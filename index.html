<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¶¨Î≥ºÎ≤Ñ ÎìÄÏñº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #0f0f1e;
            color: #fff;
        }

        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #0f0f1e;
        }


        #augmentModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 0.95);
            border: 3px solid #e94560;
            border-radius: 15px;
            padding: 30px;
            z-index: 1000;
            max-width: 600px;
            width: 90%;
        }

        #augmentModal h2 {
            color: #e94560;
            margin-bottom: 20px;
        }

        #augmentViewModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 0.95);
            border: 3px solid #4a9eff;
            border-radius: 15px;
            padding: 30px;
            z-index: 1000;
            max-width: 600px;
            width: 90%;
        }

        #augmentViewModal h2 {
            color: #4a9eff;
            margin-bottom: 20px;
        }

        .augment-option {
            background: rgba(233, 69, 96, 0.2);
            border: 2px solid #e94560;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .augment-option:hover {
            background: rgba(233, 69, 96, 0.4);
            transform: scale(1.05);
        }

        .augment-option h4 {
            color: #ffc107;
            margin-bottom: 5px;
        }

        #gameOverModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 0.95);
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 40px;
            z-index: 1001;
            text-align: center;
        }

        #gameOverModal h2 {
            color: #ffc107;
            font-size: 32px;
            margin-bottom: 20px;
        }

        #collectionModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 1);
            border: 3px solid #4a9eff;
            border-radius: 15px;
            padding: 30px;
            z-index: 3000;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            pointer-events: auto;
        }

        #collectionModal h2 {
            color: #4a9eff;
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }

        #controlsModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 1);
            border: 3px solid #4a9eff;
            border-radius: 15px;
            padding: 30px;
            z-index: 3001;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            pointer-events: auto;
        }

        #controlsModal h2 {
            color: #4a9eff;
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
        }

        #controlsModal .control-item {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        #controlsModal .control-item h3 {
            color: #4a9eff;
            font-size: 20px;
            margin-bottom: 10px;
        }

        #controlsModal .control-item p {
            color: #ffffff;
            font-size: 16px;
            line-height: 1.6;
            margin: 5px 0;
        }

        #controlsModal .key {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(74, 158, 255, 0.3);
            border: 1px solid #4a9eff;
            border-radius: 5px;
            font-weight: bold;
            margin: 0 5px;
        }

        .collection-item {
            background: rgba(74, 158, 255, 0.1);
            border: 2px solid #4a9eff;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s;
            position: relative; /* ÏÑ†ÌÉù ÌöüÏàò ÏúÑÏπò ÏßÄÏ†ïÏùÑ ÏúÑÌï¥ */
        }
        
        .collection-item .select-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(74, 158, 255, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .collection-item.locked {
            background: rgba(100, 100, 100, 0.1);
            border-color: #666;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .collection-item h4 {
            color: #4a9eff;
            margin-bottom: 8px;
            font-size: 20px;
        }

        .collection-item.locked h4 {
            color: #666;
        }

        .collection-item p {
            color: #ccc;
            margin: 0;
            font-size: 16px;
        }

        .collection-item.locked p {
            color: #888;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        button:hover {
            background: #c7364d;
        }

        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 15, 30, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 40px;
            padding-top: 60px;
            z-index: 2000;
        }

        #mainMenu h1 {
            font-size: 100px;
            color: #e94560;
            margin-bottom: 25px;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
            animation: neonFlicker 1.67s ease-in-out;
            animation-fill-mode: forwards;
            opacity: 0;
        }

        @keyframes neonFlicker {
            0% {
                opacity: 0;
                text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
            }
            20% {
                opacity: 0.3;
                text-shadow: 0 0 10px rgba(233, 69, 96, 0.4);
            }
            40% {
                opacity: 0.1;
                text-shadow: 0 0 5px rgba(233, 69, 96, 0.2);
            }
            60% {
                opacity: 0.6;
                text-shadow: 0 0 18px rgba(233, 69, 96, 0.6);
            }
            80% {
                opacity: 0.3;
                text-shadow: 0 0 10px rgba(233, 69, 96, 0.4);
            }
            100% {
                opacity: 1;
                text-shadow: 0 0 20px rgba(233, 69, 96, 0.5),
                            0 0 40px rgba(233, 69, 96, 0.5),
                            0 0 60px rgba(233, 69, 96, 0.3);
            }
        }

        @keyframes neonFlickerLocked {
            0% {
                opacity: 0;
                text-shadow: 0 0 5px rgba(136, 136, 136, 0.1);
            }
            20% {
                opacity: 0.2;
                text-shadow: 0 0 8px rgba(136, 136, 136, 0.2);
            }
            40% {
                opacity: 0.1;
                text-shadow: 0 0 5px rgba(136, 136, 136, 0.1);
            }
            60% {
                opacity: 0.4;
                text-shadow: 0 0 12px rgba(136, 136, 136, 0.3);
            }
            80% {
                opacity: 0.2;
                text-shadow: 0 0 8px rgba(136, 136, 136, 0.2);
            }
            100% {
                opacity: 0.6;
                text-shadow: 0 0 10px rgba(136, 136, 136, 0.3),
                            0 0 20px rgba(136, 136, 136, 0.2),
                            0 0 30px rgba(136, 136, 136, 0.1);
            }
        }

        #soloPlayText {
            font-size: 42px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                        0 0 20px rgba(255, 255, 255, 0.4),
                        0 0 30px rgba(255, 255, 255, 0.3),
                        0 0 40px rgba(255, 255, 255, 0.2);
            margin-left: 12px;
            display: block;
            margin-top: 15px;
        }

        #soloPlayText:hover {
            color: #4a9eff;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5),
                        0 0 20px rgba(74, 158, 255, 0.5),
                        0 0 40px rgba(74, 158, 255, 0.5),
                        0 0 60px rgba(74, 158, 255, 0.3);
            transform: scale(1.05);
        }

        #multiPlayText {
            font-size: 42px;
            color: #888;
            cursor: not-allowed;
            margin-left: 12px;
            display: block;
            margin-top: 15px;
            opacity: 0.6;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(255, 255, 255, 0.2),
                        0 0 30px rgba(255, 255, 255, 0.1);
            transition: margin-top 0.3s ease;
        }

        #settingsText {
            font-size: 42px;
            color: #888;
            cursor: not-allowed;
            margin-left: 12px;
            display: block;
            margin-top: 15px;
            opacity: 0.6;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3),
                        0 0 20px rgba(255, 255, 255, 0.2),
                        0 0 30px rgba(255, 255, 255, 0.1);
        }

        .lock-icon {
            filter: grayscale(100%);
            opacity: 0.6;
            margin-right: 4px;
        }

        .menu-text {
            font-size: 42px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                        0 0 20px rgba(255, 255, 255, 0.4),
                        0 0 30px rgba(255, 255, 255, 0.3),
                        0 0 40px rgba(255, 255, 255, 0.2);
            margin-left: 12px;
            display: block;
            margin-top: 15px;
        }

        .menu-text:hover {
            color: #4a9eff;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5),
                        0 0 20px rgba(74, 158, 255, 0.5),
                        0 0 40px rgba(74, 158, 255, 0.5),
                        0 0 60px rgba(74, 158, 255, 0.3);
            transform: scale(1.05);
        }

        .menu-button {
            background: rgba(233, 69, 96, 0.3);
            border: 3px solid #e94560;
            color: #fff;
            padding: 20px 50px;
            font-size: 24px;
            border-radius: 15px;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s;
            min-width: 250px;
        }

        .menu-button:hover {
            background: rgba(233, 69, 96, 0.5);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(233, 69, 96, 0.7);
        }

        .menu-button:active {
            transform: scale(1.05);
        }

        #controlsInfo {
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            text-align: center;
            max-width: 600px;
        }

        #controlsInfo h3 {
            color: #4a9eff;
            margin-bottom: 15px;
        }

        #controlsInfo p {
            margin: 8px 0;
            color: #ccc;
        }

        #modeSelection {
            max-height: 0;
            opacity: 0;
            overflow: visible;
            margin-top: 0;
            margin-left: 12px;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
        }

        #modeSelection.expanded {
            max-height: 200px;
            opacity: 1;
            margin-top: 10px;
        }

        .mode-option {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2),
                        0 0 20px rgba(255, 255, 255, 0.15),
                        0 0 30px rgba(255, 255, 255, 0.1),
                        0 0 40px rgba(255, 255, 255, 0.05);
            margin-top: 8px;
            margin-left: 0;
            display: block;
        }

        .mode-option:hover {
            color: #4a9eff;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5),
                        0 0 20px rgba(74, 158, 255, 0.5),
                        0 0 40px rgba(74, 158, 255, 0.5),
                        0 0 60px rgba(74, 158, 255, 0.3);
            transform: scale(1.05);
        }

        .menu-text.moved-down {
            margin-top: 120px;
        }

        #multiPlayText.moved-down {
            margin-top: 20px;
            transition: margin-top 0.3s ease;
        }

        #settingsText.moved-down {
            margin-top: 120px;
        }

        #randomModeDisplay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 28px;
            z-index: 100;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 200px;
        }

        #randomModeDisplay::before,
        #randomModeDisplay::after {
            display: none;
        }

        #randomModeDisplay:hover {
            background: transparent;
        }

        #randomModeName {
            display: block;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        #randomModeTooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
            background: rgba(15, 15, 30, 0.95);
            border: 2px solid #4a9eff;
            border-radius: 10px;
            padding: 10px 15px;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #randomModeDisplay:hover #randomModeTooltip {
            opacity: 1;
        }


    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div id="augmentModal">
            <h2>Ï¶ùÍ∞ï ÏÑ†ÌÉù</h2>
            <p style="margin-bottom: 20px;">Ìå®Î∞∞ÌïòÏÖ®ÏäµÎãàÎã§. Ï¶ùÍ∞ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</p>
            <div id="enemySelection" style="margin-bottom: 20px; padding: 10px; background: rgba(233, 69, 96, 0.2); border-radius: 5px; display: none;">
                <p style="color: #e94560; margin: 0;">ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉù Ï§ë...</p>
            </div>
            <div id="augmentOptions"></div>
        </div>

        <div id="augmentViewModal">
            <h2>Ï¶ùÍ∞ï ÌôïÏù∏</h2>
            <p style="margin-bottom: 20px;">ÏäπÎ¶¨ÌïòÏÖ®ÏäµÎãàÎã§! ÏÉÅÎåÄÏùò Ï¶ùÍ∞ï ÏÑ†ÌÉùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî:</p>
            <div id="opponentSelection" style="margin-bottom: 20px; padding: 10px; background: rgba(233, 69, 96, 0.2); border-radius: 5px;">
                <p style="color: #e94560; margin: 0;">ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉù Ï§ë...</p>
            </div>
            <button onclick="closeAugmentViewModal()" style="margin-top: 20px;">ÌôïÏù∏</button>
        </div>

        <div id="gameOverModal">
            <h2 id="gameOverTitle">Í≤åÏûÑ Ï¢ÖÎ£å</h2>
            <p id="gameOverMessage" style="font-size: 20px; margin-bottom: 20px;"></p>
            <button onclick="restartGame()">Î©îÏù∏Î©îÎâ¥Î°ú</button>
        </div>

        <div id="collectionModal">
            <h2>ÎèÑÍ∞ê</h2>
            <div id="collectionContent" style="max-height: 70vh; overflow-y: auto; padding: 10px;"></div>
            <button onclick="closeCollectionModal()" style="margin-top: 20px;">Îã´Í∏∞</button>
        </div>

        <div id="controlsModal">
            <h2>Ï°∞ÏûëÎ≤ï</h2>
            <div class="control-item">
                <h3>Ïù¥Îèô</h3>
                <p><span class="key">W</span> ÏúÑÎ°ú Ïù¥Îèô</p>
                <p><span class="key">S</span> ÏïÑÎûòÎ°ú Ïù¥Îèô</p>
                <p><span class="key">A</span> ÏôºÏ™ΩÏúºÎ°ú Ïù¥Îèô</p>
                <p><span class="key">D</span> Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïù¥Îèô</p>
            </div>
            <div class="control-item">
                <h3>Ï°∞Ï§Ä Î∞è Î∞úÏÇ¨</h3>
                <p>ÎßàÏö∞Ïä§Î•º ÏõÄÏßÅÏó¨ Ï°∞Ï§Ä</p>
                <p><span class="key">ÎßàÏö∞Ïä§ ÏôºÏ™Ω ÌÅ¥Î¶≠</span> Î∞úÏÇ¨</p>
            </div>
            <button onclick="closeControlsModal()" style="margin-top: 20px; padding: 10px 30px; background: #4a9eff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Îã´Í∏∞</button>
        </div>

        <div id="mainMenu">
            <h1>Î¶¨Î≥ºÎ≤Ñ ÎìÄÏñº</h1>
            <span id="soloPlayText" onclick="showModeSelection()">ÏÜîÎ°ú ÌîåÎ†àÏù¥</span>
            <div id="modeSelection">
                <span class="mode-option" onclick="startSoloGame('classic')">- ÌÅ¥ÎûòÏãù Î™®Îìú</span>
                <span class="mode-option" onclick="startSoloGame('random')">- ÎûúÎç§ Î™®Îìú</span>
            </div>
            <span id="multiPlayText"><span class="lock-icon">üîí</span>Î©ÄÌã∞ ÌîåÎ†àÏù¥</span>
            <span class="menu-text" id="collectionText" onclick="openCollectionModal()">ÎèÑÍ∞ê</span>
            <span id="settingsText"><span class="lock-icon">üîí</span>ÏÑ§Ï†ï</span>
            <span class="menu-text" id="controlsText" onclick="openControlsModal()">Ï°∞ÏûëÎ≤ï</span>
        </div>

        <div id="randomModeDisplay" style="display: none;">
            <div id="randomModeTooltip"></div>
            <span id="randomModeName"></span>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º ÌôîÎ©¥ Ï†ÑÏ≤¥Î°ú ÏÑ§Ï†ï
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Î©îÏù∏ Î©îÎâ¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞
        document.addEventListener('click', (e) => {
            const mainMenu = document.getElementById('mainMenu');
            const modeSelection = document.getElementById('modeSelection');
            const soloPlayText = document.getElementById('soloPlayText');
            
            // Î©îÏù∏ Î©îÎâ¥Í∞Ä ÌëúÏãúÎêòÏñ¥ ÏûàÍ≥†, Î™®Îìú ÏÑ†ÌÉùÏù¥ ÌéºÏ≥êÏ†∏ ÏûàÏùÑ Îïå
            if (mainMenu && mainMenu.style.display === 'flex' && modeSelection && modeSelection.classList.contains('expanded')) {
                // ÌÅ¥Î¶≠Ìïú ÏöîÏÜåÍ∞Ä Î™®Îìú ÏÑ†ÌÉù ÏòÅÏó≠Ïù¥ÎÇò ÏÜîÎ°ú ÌîåÎ†àÏù¥ ÌÖçÏä§Ìä∏Í∞Ä ÏïÑÎãê Îïå
                if (!modeSelection.contains(e.target) && !soloPlayText.contains(e.target)) {
                    collapseModeSelection();
                }
            }
        });

        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = {
            round: 1,
            playerWins: 0,
            enemyWins: 0,
            winsNeeded: 5, // 5ÎùºÏö¥Îìú ÏÑ†ÏäπÏ†ú
            gameTime: 180, // 3Î∂Ñ = 180Ï¥à
            isGameOver: false,
            isPaused: false,
            isMenu: true, // Î©îÎâ¥ ÌôîÎ©¥ ÌëúÏãú Ïó¨Î∂Ä
            roundWins: [], // Í∞Å ÎùºÏö¥ÎìúÏùò ÏäπÏûê Í∏∞Î°ù ('player' ÎòêÎäî 'enemy')
            countdown: 3, // ÎùºÏö¥Îìú ÏãúÏûë Ïπ¥Ïö¥Ìä∏Îã§Ïö¥
            augmentCountdown: 0, // Ï¶ùÍ∞ï ÏÑ†ÌÉù Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ (0Ïù¥Î©¥ ÌëúÏãú ÏïàÌï®)
            showOpponentSelecting: false, // ÏÉÅÎåÄ ÏÑ†ÌÉù Ï§ë Î©îÏãúÏßÄ ÌëúÏãú Ïó¨Î∂Ä
            shake: {
                intensity: 0,
                duration: 0
            },
            // Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÉÅÌÉú
            isSlotMachine: false,
            slotMachineStartTime: 0,
            slotMachineCurrentIndex: 0,
            slotMachineSelectedMode: null,
            // Îßµ ÌÅ¨Í∏∞ (Í∏∞Î≥∏Í∞íÏùÄ Ï†ÑÏ≤¥ Ï∫îÎ≤ÑÏä§)
            mapBounds: {
                minX: 0,
                minY: 0,
                maxX: 0, // initGameÏóêÏÑú ÏÑ§Ï†ï
                maxY: 0  // initGameÏóêÏÑú ÏÑ§Ï†ï
            }
        };

        // ÌäúÌÜ†Î¶¨Ïñº ÏÉÅÌÉú

        // ÌîåÎ†àÏù¥Ïñ¥
        const player = {
            x: canvas.width * 0.2,
            y: canvas.height * 0.5,
            radius: 30, // 1.5Î∞∞ Ï¶ùÍ∞Ä (20 -> 30)
            speed: 3,
            health: 5,
            displayHealth: 5, // ÌëúÏãúÎêòÎäî Ï≤¥Î†• (Ïï†ÎãàÎ©îÏù¥ÏÖòÏö©)
            maxHealth: 5,
            ammo: 6,
            maxAmmo: 6,
            reloadTime: 3000, // 3Ï¥à
            isReloading: false,
            reloadStartTime: 0, // Ïû¨Ïû•Ï†Ñ ÏãúÏûë ÏãúÍ∞Ñ
            angle: 0,
            color: '#4a9eff',
            bullets: [],
            lastShot: 0,
            shootCooldown: 1000, // 1Ï¥àÎ°ú Í≥†Ï†ï
            damage: 1, // Í∏∞Î≥∏ Îç∞ÎØ∏ÏßÄ
            augmentations: [],
            // Ï¶ùÍ∞ï Í¥ÄÎ†® ÏÉÅÌÉú
            bulletSpeedMultiplier: 1,
            bulletSizeMultiplier: 1, // ÌÉÑÌôò ÌÅ¨Í∏∞ Î∞∞Ïú®
            hasCritical: false,
            hasDoubleShot: false,
            hasDodge: false,
            hasRevive: false,
            hasRevived: 0, // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò
            hasDeepWound: false,
            hasOneShotOneKill: false,
            hasPoisonBullet: false,
            hasReloadHeal: false,
            hasSurvivalInstinct: false, // ÏÉùÏ°¥Î≥∏Îä•
            hasLastBullet: false, // ÎπÑÏû•Ïùò ÌïúÎ∞ú
            hasRecoveryContract: false, // ÌöåÎ≥µÍ≥ÑÏïΩ
            hasRecoveryContractUsed: false, // ÌöåÎ≥µÍ≥ÑÏïΩ ÏÇ¨Ïö© Ïó¨Î∂Ä (ÎùºÏö¥ÎìúÎãπ ÌïúÎ≤à)
            hasFocusedFire: false, // ÏßëÏ§ë ÏÇ¨Í≤©
            hasShotgun: false, // ÏÉ∑Í±¥
            hasRagged: false, // Îã§Îã§ÏùµÏÑ†
            hasGhost: false, // Ïú†Î†π
            hasFortify: false, // Í±∞Ï†êÌôïÎ≥¥
            isFortified: false, // Í±∞Ï†ê ÌôïÎ≥¥ ÏÉÅÌÉú
            fortifyStartTime: 0, // Í±∞Ï†ê ÌôïÎ≥¥ ÏãúÏûë ÏãúÍ∞Ñ
            lastPosition: { x: 0, y: 0 }, // ÎßàÏßÄÎßâ ÏúÑÏπò
            stationaryTime: 0, // Ï†ïÏßÄÌïú ÏãúÍ∞Ñ
            hasOverheat: false, // Í≥ºÏó¥
            overheatHitCount: 0, // Ïó∞ÏÜç ÌûàÌä∏ Ïπ¥Ïö¥Ìä∏
            lastHitTime: 0, // ÎßàÏßÄÎßâ ÌûàÌä∏ ÏãúÍ∞Ñ
            hasGamble: false, // ÎèÑÎ∞ï
            hasWeaken: false, // ÏïΩÌôî
            isWeakened: false, // ÏïΩÌôî ÏÉÅÌÉú
            weakenEndTime: 0, // ÏïΩÌôî Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasDamageBoost: false, // Îç∞ÎØ∏ÏßÄ 1.2Î∞∞
            hasLightning: false, // Î≤àÍ∞ú
            isStunned: false, // Í∏∞Ï†à ÏÉÅÌÉú
            stunEndTime: 0, // Í∏∞Ï†à Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasShield: false, // Î∞©Ïñ¥Îßâ
            shieldReady: false, // Î∞©Ïñ¥Îßâ Ï§ÄÎπÑÎê®
            shieldCooldown: 0, // Î∞©Ïñ¥Îßâ Ïø®ÌÉÄÏûÑ
            hasRegeneration: false, // Ïû¨ÏÉù
            lastRegenTime: 0, // ÎßàÏßÄÎßâ ÌöåÎ≥µ ÏãúÍ∞Ñ
            isVulnerable: false, // Ï∑®ÏïΩ ÏÉÅÌÉú
            vulnerabilityUsed: false, // Ï∑®ÏïΩ ÏÇ¨Ïö© Ïó¨Î∂Ä
            poisonEffects: [], // ÎèÖ Ìö®Í≥º Î∞∞Ïó¥ {target, startTime, duration, damagePerSecond}
            isDodging: false,
            dodgeStartTime: 0, // Íµ¨Î•¥Í∏∞ ÏãúÏûë ÏãúÍ∞Ñ
            dodgeEndTime: 0,
            dodgeStartX: 0,
            dodgeStartY: 0,
            dodgeTargetX: 0,
            dodgeTargetY: 0,
            dodgeTrail: [], // Íµ¨Î•¥Í∏∞ ÏûîÏÉÅ ÏúÑÏπò Î∞∞Ïó¥
            lastDodgeTime: 0, // ÎßàÏßÄÎßâ Íµ¨Î•¥Í∏∞ ÏãúÍ∞Ñ (Ïø®ÌÉÄÏûÑÏö©)
            isReviving: false,
            reviveTime: 0,
            isInvincible: false,
            invincibleEndTime: 0,
            slowEndTime: 0,
            damageNumbers: [] // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌëúÏãúÏö©
        };

        // Ï†Å (AI)
        const enemy = {
            x: canvas.width * 0.8,
            y: canvas.height * 0.5,
            radius: 30, // 1.5Î∞∞ Ï¶ùÍ∞Ä (20 -> 30)
            speed: 2.5,
            health: 5,
            displayHealth: 5, // ÌëúÏãúÎêòÎäî Ï≤¥Î†• (Ïï†ÎãàÎ©îÏù¥ÏÖòÏö©)
            maxHealth: 5,
            ammo: 6,
            maxAmmo: 6,
            reloadTime: 3000, // 3Ï¥à
            isReloading: false,
            reloadStartTime: 0, // Ïû¨Ïû•Ï†Ñ ÏãúÏûë ÏãúÍ∞Ñ
            angle: Math.PI,
            color: '#e94560',
            bullets: [],
            lastShot: 0,
            shootCooldown: 1000, // 1Ï¥àÎ°ú Í≥†Ï†ï
            damage: 1, // Í∏∞Î≥∏ Îç∞ÎØ∏ÏßÄ
            augmentations: [],
            // Ï¶ùÍ∞ï Í¥ÄÎ†® ÏÉÅÌÉú
            bulletSpeedMultiplier: 1,
            bulletSizeMultiplier: 1, // ÌÉÑÌôò ÌÅ¨Í∏∞ Î∞∞Ïú®
            hasCritical: false,
            hasDoubleShot: false,
            hasDodge: false,
            hasRevive: false,
            hasRevived: 0, // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò
            hasDeepWound: false,
            hasOneShotOneKill: false,
            hasPoisonBullet: false,
            hasReloadHeal: false,
            hasSurvivalInstinct: false, // ÏÉùÏ°¥Î≥∏Îä•
            hasLastBullet: false, // ÎπÑÏû•Ïùò ÌïúÎ∞ú
            hasRecoveryContract: false, // ÌöåÎ≥µÍ≥ÑÏïΩ
            hasRecoveryContractUsed: false, // ÌöåÎ≥µÍ≥ÑÏïΩ ÏÇ¨Ïö© Ïó¨Î∂Ä (ÎùºÏö¥ÎìúÎãπ ÌïúÎ≤à)
            hasFocusedFire: false, // ÏßëÏ§ë ÏÇ¨Í≤©
            hasShotgun: false, // ÏÉ∑Í±¥
            hasRagged: false, // Îã§Îã§ÏùµÏÑ†
            hasGhost: false, // Ïú†Î†π
            hasFortify: false, // Í±∞Ï†êÌôïÎ≥¥
            isFortified: false, // Í±∞Ï†ê ÌôïÎ≥¥ ÏÉÅÌÉú
            fortifyStartTime: 0, // Í±∞Ï†ê ÌôïÎ≥¥ ÏãúÏûë ÏãúÍ∞Ñ
            lastPosition: { x: 0, y: 0 }, // ÎßàÏßÄÎßâ ÏúÑÏπò
            stationaryTime: 0, // Ï†ïÏßÄÌïú ÏãúÍ∞Ñ
            hasOverheat: false, // Í≥ºÏó¥
            overheatHitCount: 0, // Ïó∞ÏÜç ÌûàÌä∏ Ïπ¥Ïö¥Ìä∏
            lastHitTime: 0, // ÎßàÏßÄÎßâ ÌûàÌä∏ ÏãúÍ∞Ñ
            hasGamble: false, // ÎèÑÎ∞ï
            hasWeaken: false, // ÏïΩÌôî
            isWeakened: false, // ÏïΩÌôî ÏÉÅÌÉú
            weakenEndTime: 0, // ÏïΩÌôî Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasDamageBoost: false, // Îç∞ÎØ∏ÏßÄ 1.2Î∞∞
            hasLightning: false, // Î≤àÍ∞ú
            isStunned: false, // Í∏∞Ï†à ÏÉÅÌÉú
            stunEndTime: 0, // Í∏∞Ï†à Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasShield: false, // Î∞©Ïñ¥Îßâ
            shieldReady: false, // Î∞©Ïñ¥Îßâ Ï§ÄÎπÑÎê®
            shieldCooldown: 0, // Î∞©Ïñ¥Îßâ Ïø®ÌÉÄÏûÑ
            hasRegeneration: false, // Ïû¨ÏÉù
            lastRegenTime: 0, // ÎßàÏßÄÎßâ ÌöåÎ≥µ ÏãúÍ∞Ñ
            hasEvasiveManeuver: false, // ÌöåÌîºÍ∏∞Îèô
            hasCombatExperience: false, // Ï†ÑÌà¨ Í≤ΩÌóò
            combatExperienceRounds: 0, // Ï†ÑÌà¨ Í≤ΩÌóò ÎùºÏö¥Îìú Ïàò
            hasHallucination: false, // ÌôòÍ∞Å
            hasTasteOfBlood: false, // ÌîºÏùò Îßõ
            hasCannon: false, // ÎåÄÌè¨
            hasTimeBarrier: false, // ÏãúÍ∞ÑÏû•Îßâ
            timeBarrierRadius: 150, // ÏãúÍ∞ÑÏû•Îßâ Î∞òÏßÄÎ¶Ñ
            hasBouncyBullet: false, // ÌÜµÌÜµÌÉÑ
            hasGamble2: false, // Ïä§ÎÑ§Ïù¥ÌÅ¨
            hasReflect: false, // Î∞òÏÇ¨
            reflectActive: false, // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
            reflectCooldown: 0, // Î∞òÏÇ¨ Ïø®ÌÉÄÏûÑ
            reflectEndTime: 0, // Î∞òÏÇ¨ Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasGatling: false, // Í≤åÌãÄÎßÅ
            gatlingBullets: 0, // Í≤åÌãÄÎßÅ ÎÇ®ÏùÄ Î∞úÏÇ¨ Ïàò
            gatlingNextShot: 0, // Í≤åÌãÄÎßÅ Îã§Ïùå Î∞úÏÇ¨ ÏãúÍ∞Ñ
            hasTimeStop: false, // ÏãúÍ∞ÑÏ†ïÏßÄ
            timeStopCooldown: 0, // ÏãúÍ∞ÑÏ†ïÏßÄ Ïø®ÌÉÄÏûÑ
            timeStopActive: false, // ÏãúÍ∞ÑÏ†ïÏßÄ ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
            timeStopEndTime: 0, // ÏãúÍ∞ÑÏ†ïÏßÄ Ï¢ÖÎ£å ÏãúÍ∞Ñ
            hasScatter: false, // ÎπÑÏÇ∞ÌÉÑ
            hasRocket: false, // Î°úÏºìÌÉÑ
            hasTrinity: false, // ÏÇºÏúÑÏùºÏ≤¥
            hasJudgment: false, // ÏÑ†Í≥†
            isJudgmentPushing: false, // ÏÑ†Í≥† Î∞ÄÎ†§ÎÇòÎäî Ï§ë
            judgmentPushStartX: 0,
            judgmentPushStartY: 0,
            judgmentPushTargetX: 0,
            judgmentPushTargetY: 0,
            judgmentPushStartTime: 0,
            judgmentPushDuration: 0,
            hasBoomerang: false, // Î∂ÄÎß§Îûë
            isVulnerable: false, // Ï∑®ÏïΩ ÏÉÅÌÉú
            vulnerabilityUsed: false, // Ï∑®ÏïΩ ÏÇ¨Ïö© Ïó¨Î∂Ä
            poisonEffects: [], // ÎèÖ Ìö®Í≥º Î∞∞Ïó¥ {target, startTime, duration, damagePerSecond}
            isDodging: false,
            dodgeStartTime: 0, // Íµ¨Î•¥Í∏∞ ÏãúÏûë ÏãúÍ∞Ñ
            dodgeEndTime: 0,
            dodgeStartX: 0,
            dodgeStartY: 0,
            dodgeTargetX: 0,
            dodgeTargetY: 0,
            dodgeTrail: [], // Íµ¨Î•¥Í∏∞ ÏûîÏÉÅ ÏúÑÏπò Î∞∞Ïó¥
            lastDodgeTime: 0, // ÎßàÏßÄÎßâ Íµ¨Î•¥Í∏∞ ÏãúÍ∞Ñ (Ïø®ÌÉÄÏûÑÏö©)
            isReviving: false,
            reviveTime: 0,
            isInvincible: false,
            invincibleEndTime: 0,
            slowEndTime: 0,
            aiTimer: 0,
            aiDirection: Math.random() * Math.PI * 2,
            usePrediction: false, // Î∞úÏÇ¨ Ìå®ÌÑ¥: false=ÌòÑÏû¨ ÏúÑÏπò, true=ÏòàÏ∏° ÏúÑÏπò
            lastPlayerX: 0, // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Ï†Ñ ÏúÑÏπò (Ïù¥Îèô Î∞©Ìñ• Í≥ÑÏÇ∞Ïö©)
            lastPlayerY: 0,
            playerVelocity: { x: 0, y: 0 }, // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô ÏÜçÎèÑ
            lastPlayerBulletCount: 0, // ÌîåÎ†àÏù¥Ïñ¥ Ï¥ùÏïå Í∞úÏàò Ï∂îÏ†Å (Î∞úÏÇ¨ Í∞êÏßÄÏö©)
            bulletDodgeTargetY: 0, // Ï¥ùÏïå ÌöåÌîº Î™©Ìëú Y ÏúÑÏπò
            isDodgingBullet: false, // Ï¥ùÏïå ÌöåÌîº Ï§ëÏù∏ÏßÄ
            damageNumbers: [] // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌëúÏãúÏö©
        };

        // Ï¶ùÍ∞ï Î™©Î°ù
        // Ï¶ùÍ∞ï Ï§ëÏ≤© ÌöüÏàò Í≥ÑÏÇ∞ Ìó¨Ìçº Ìï®Ïàò
        function getAugmentCount(character, augmentId) {
            return character.augmentations.filter(aug => aug.id === augmentId).length;
        }

        const augmentations = [
            { 
                id: 'health', 
                name: 'ÏµúÎåÄÏ≤¥Î†• +1.5', 
                description: 'ÏµúÎåÄ Ï≤¥Î†• +1.5', 
                effect: (character) => { 
                    // Ï§ëÏ≤© Í∞ÄÎä•: ÌöüÏàòÎßåÌÅº Ï∂îÍ∞Ä
                    const count = character.augmentations.filter(aug => aug.id === 'health').length + 1;
                    character.maxHealth += 1.5;
                    character.health += 1.5;
                } 
            },
            { 
                id: 'speed', 
                name: 'Ïù¥ÎèôÏÜçÎèÑ +25%', 
                description: 'Ïù¥Îèô ÏÜçÎèÑ +25%', 
                effect: (character) => { 
                    character.speed *= 1.25; 
                } 
            },
            { 
                id: 'bulletSpeed', 
                name: 'Ï¥ùÏïå ÏÜçÎèÑ +25%', 
                description: 'Ï¥ùÏïå ÏÜçÎèÑ +25%', 
                effect: (character) => { 
                    character.bulletSpeedMultiplier = (character.bulletSpeedMultiplier || 1) * 1.25; 
                } 
            },
            { 
                id: 'ammo', 
                name: 'ÌÉÑÏïΩ +1', 
                description: 'ÏµúÎåÄ ÌÉÑÏïΩ +1', 
                effect: (character) => { 
                    character.maxAmmo += 1; 
                    character.ammo += 1; 
                } 
            },
            { 
                id: 'fireRate', 
                name: 'Î∞úÏÇ¨ÏÜçÎèÑ -25%', 
                description: 'Î∞úÏÇ¨ÏÜçÎèÑ -25%', 
                effect: (character) => { 
                    character.shootCooldown *= 0.75; 
                } 
            },
            { 
                id: 'reload', 
                name: 'Ïû¨Ïû•Ï†Ñ ÏÜçÎèÑ -1.5Ï¥à', 
                description: 'Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ -1.5Ï¥à', 
                effect: (character) => { 
                    character.reloadSpeedCount = (character.reloadSpeedCount || 0) + 1;
                    // Ï§ëÏ≤© Ï†ÅÏö©: Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞ÑÏóêÏÑú Ï§ëÏ≤© ÌöüÏàò * 1.5Ï¥àÎ•º Î∫å
                    const baseReloadTime = character.baseReloadTime || 3000;
                    character.reloadTime = Math.max(1000, baseReloadTime - (1500 * character.reloadSpeedCount));
                } 
            },
            { 
                id: 'critical', 
                name: 'ÌÅ¨Î¶¨Ìã∞Ïª¨', 
                description: 'ÌîºÍ≤© Ïãú 25% ÌôïÎ•†Î°ú Îç∞ÎØ∏ÏßÄ 2Î∞∞', 
                effect: (character) => { 
                    character.hasCritical = true; 
                    character.criticalCount = (character.criticalCount || 0) + 1; 
                } 
            },
            { 
                id: 'doubleShot', 
                name: 'ÎçîÎ∏îÏÉ∑', 
                description: 'Î∞úÏÇ¨ Ïãú 25% ÌôïÎ•†Î°ú Ï∂îÍ∞Ä Î∞úÏÇ¨', 
                effect: (character) => { 
                    character.hasDoubleShot = true; 
                    character.doubleShotCount = (character.doubleShotCount || 0) + 1; 
                } 
            },
            { 
                id: 'dodge', 
                name: 'Íµ¨Î•¥Í∏∞', 
                description: 'Ïö∞ÌÅ¥Î¶≠ÏúºÎ°ú Íµ¨Î•¥Í∏∞ (Íµ¨Î•¥Îäî ÎèôÏïà Î¨¥Ï†Å)', 
                effect: (character) => { 
                    character.hasDodge = true; 
                } 
            },
            { 
                id: 'revive', 
                name: 'Î∂ÄÌôú', 
                description: 'Ï£ΩÏóàÏùÑ Îïå 2Ï¥à ÌõÑ Ï≤¥Î†• 1Î°ú Î∂ÄÌôú', 
                effect: (character) => { 
                    character.hasRevive = true; 
                    character.reviveCount = (character.reviveCount || 0) + 1; 
                } 
            },
            { 
                id: 'deepWound', 
                name: 'ÍπäÏùÄ ÏÉÅÏ≤ò', 
                description: 'ÌîºÍ≤© Ïãú ÏÉÅÎåÄ Ïù¥ÎèôÏÜçÎèÑ -25%', 
                effect: (character) => { 
                    character.hasDeepWound = true; 
                    character.deepWoundCount = (character.deepWoundCount || 0) + 1; 
                } 
            },
            { 
                id: 'giant', 
                name: 'Í±∞ÎåÄÌôî', 
                description: 'Ï≤¥Î†• +3, Ïù¥ÎèôÏÜçÎèÑ -25%', 
                effect: (character) => { 
                    character.maxHealth += 3; 
                    character.health += 3; 
                    character.speed *= 0.75; 
                } 
            },
            { 
                id: 'sniper', 
                name: 'Ï†ÄÍ≤©Ïàò', 
                description: 'Ï¥ùÏïå ÏÜçÎèÑ +75%, ÏµúÎåÄ ÌÉÑÏïΩ -3', 
                effect: (character) => { 
                    character.bulletSpeedMultiplier = (character.bulletSpeedMultiplier || 1) * 1.75; 
                    character.maxAmmo = Math.max(1, character.maxAmmo - 3); 
                    character.ammo = Math.min(character.ammo, character.maxAmmo); 
                } 
            },
            { 
                id: 'oneShotOneKill', 
                name: 'ÏõêÏÉ∑ÏõêÌÇ¨', 
                description: 'ÏµúÎåÄ ÌÉÑÏïΩ 1Í∞úÎ°ú Í≥†Ï†ï, Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ *3', 
                effect: (character) => { 
                    character.maxAmmo = 1; 
                    character.ammo = Math.min(character.ammo, 1); 
                    character.damage = (character.damage || 1) * 3; // Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ *3
                    character.hasOneShotOneKill = true; 
                } 
            },
            { 
                id: 'poisonBullet', 
                name: 'ÎèÖ ÌÉÑÌôò', 
                description: 'Ï†Å ÌîºÍ≤©Ïãú 0.2Îç∞ÎØ∏ÏßÄÎ•º 1Ï¥àÍ∞ÑÍ≤©ÏúºÎ°ú 2Î≤à Ï∂îÍ∞ÄÌîºÌï¥', 
                effect: (character) => { 
                    character.hasPoisonBullet = true; 
                    character.poisonBulletCount = (character.poisonBulletCount || 0) + 1; 
                } 
            },
            { 
                id: 'reloadHeal', 
                name: 'Ïû¨Ïû•Ï†Ñ ÌöåÎ≥µ', 
                description: 'Ïû¨Ïû•Ï†Ñ Ïãú Ï≤¥Î†• 1ÌöåÎ≥µ', 
                effect: (character) => { 
                    character.hasReloadHeal = true; 
                    character.reloadHealCount = (character.reloadHealCount || 0) + 1; 
                } 
            },
            { 
                id: 'bigBullet', 
                name: 'ÌÅ∞ ÌÉÑÌôò', 
                description: 'ÌÉÑÌôò ÌÅ¨Í∏∞ +50%', 
                effect: (character) => { 
                    character.bulletSizeMultiplier = (character.bulletSizeMultiplier || 1) * 1.5; 
                } 
            },
            { 
                id: 'survivalInstinct', 
                name: 'ÏÉùÏ°¥Î≥∏Îä•', 
                description: 'Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ïù¥ÎèôÏÜçÎèÑ +50%', 
                effect: (character) => { 
                    character.hasSurvivalInstinct = true; 
                    character.survivalInstinctCount = (character.survivalInstinctCount || 0) + 1; 
                } 
            },
            { 
                id: 'lastBullet', 
                name: 'ÎπÑÏû•Ïùò ÌïúÎ∞ú', 
                description: 'ÎßàÏßÄÎßâ ÌÉÑÌôòÏùò Îç∞ÎØ∏ÏßÄ +1.5', 
                effect: (character) => { 
                    character.hasLastBullet = true; 
                    character.lastBulletCount = (character.lastBulletCount || 0) + 1; 
                } 
            },
            { 
                id: 'recoveryContract', 
                name: 'ÌöåÎ≥µÍ≥ÑÏïΩ', 
                description: 'Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ï≤¥Î†• 2ÌöåÎ≥µ', 
                effect: (character) => { 
                    character.hasRecoveryContract = true; 
                    character.recoveryContractCount = (character.recoveryContractCount || 0) + 1; 
                } 
            },
            { 
                id: 'focusedFire', 
                name: 'ÏßëÏ§ë ÏÇ¨Í≤©', 
                description: 'ÌîºÍ≤©Ïãú 50% ÌôïÎ•†Î°ú ÏÉÅÎåÄÏóêÍ≤å Ï∑®ÏïΩ Î∂ÄÏó¨ (Îã§Ïùå Îç∞ÎØ∏ÏßÄ *1.5Î∞∞)', 
                effect: (character) => { 
                    character.hasFocusedFire = true; 
                } 
            },
            { 
                id: 'shotgun', 
                name: 'ÏÉ∑Í±¥', 
                description: 'Î™®Îì† ÌÉÑÏïΩÏùÑ ¬±20ÎèÑ Î≤îÏúÑÏóêÏÑú ÌïúÎ≤àÏóê Î∞úÏÇ¨', 
                effect: (character) => { 
                    character.hasShotgun = true; 
                } 
            },
            { 
                id: 'ragged', 
                name: 'Îã§Îã§ÏùµÏÑ†', 
                description: 'ÏµúÎåÄ ÌÉÑÏïΩ +3, Î∞úÏÇ¨ÏÜçÎèÑ -50%, Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ *0.5', 
                effect: (character) => { 
                    character.maxAmmo += 3; 
                    character.ammo += 3; 
                    character.shootCooldown *= 0.5; // Î∞úÏÇ¨ÏÜçÎèÑ -50% (Ïø®ÌÉÄÏûÑ Ï†àÎ∞ò)
                    character.damage = (character.damage || 1) * 0.5; // Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ *0.5
                    character.hasRagged = true; 
                } 
            },
            { 
                id: 'ghost', 
                name: 'Ïú†Î†π', 
                description: 'ÏÉÅÎåÄÏùò Í≥µÍ≤©ÏùÑ 25% ÌôïÎ•†Î°ú Î¨¥Ïãú', 
                effect: (character) => { 
                    character.hasGhost = true; 
                    character.ghostCount = (character.ghostCount || 0) + 1; 
                } 
            },
            { 
                id: 'fortify', 
                name: 'Í±∞Ï†êÌôïÎ≥¥', 
                description: '3Ï¥àÎèôÏïà Í∞ÄÎßåÌûà ÏÑúÏûàÏùÑ Í≤ΩÏö∞ Îã§Ïãú ÏõÄÏßÅÏùºÎïåÍπåÏßÄ Î∞õÎäî Îç∞ÎØ∏ÏßÄ *0.5', 
                effect: (character) => { 
                    character.hasFortify = true; 
                    character.fortifyStartTime = 0; // Í±∞Ï†ê ÌôïÎ≥¥ ÏãúÏûë ÏãúÍ∞Ñ
                    character.isFortified = false; // Í±∞Ï†ê ÌôïÎ≥¥ ÏÉÅÌÉú
                    character.lastPosition = { x: character.x, y: character.y }; // ÎßàÏßÄÎßâ ÏúÑÏπò
                    character.stationaryTime = 0; // Ï†ïÏßÄÌïú ÏãúÍ∞Ñ
                } 
            },
            { 
                id: 'overheat', 
                name: 'Í≥ºÏó¥', 
                description: 'ÏÉÅÎåÄÏóêÍ≤å Ï¥ùÏïåÏùÑ Ïó∞ÏÜçÏúºÎ°ú ÎßûÏ∂ú Ïãú ÎßûÏ∂úÎïåÎßàÎã§ Îç∞ÎØ∏ÏßÄ 0.5Î∞∞Ïî© ÏÉÅÏäπ', 
                effect: (character) => { 
                    character.hasOverheat = true; 
                    character.overheatHitCount = 0; // Ïó∞ÏÜç ÌûàÌä∏ Ïπ¥Ïö¥Ìä∏
                    character.lastHitTime = 0; // ÎßàÏßÄÎßâ ÌûàÌä∏ ÏãúÍ∞Ñ
                } 
            },
            { 
                id: 'gamble', 
                name: 'ÎèÑÎ∞ï', 
                description: 'Ï¥ùÏïåÏù¥ ¬±10ÎèÑ Î≤îÏúÑÏóêÏÑú ÎûúÎç§ÌïòÍ≤å ÎÇòÍ∞ÄÏßÄÎßå Îç∞ÎØ∏ÏßÄÎäî 1~2Î∞∞ ÏÇ¨Ïù¥Î°ú ÎûúÎç§', 
                effect: (character) => { 
                    character.hasGamble = true; 
                } 
            },
            { 
                id: 'weaken', 
                name: 'ÏïΩÌôî', 
                description: 'ÏÉÅÎåÄÏóêÍ≤å Ï¥ùÏïåÏùÑ ÎßûÏ∂ú Ïãú 3Ï¥àÎèôÏïà ÏÉÅÎåÄ Îç∞ÎØ∏ÏßÄ -0.25', 
                effect: (character) => { 
                    character.hasWeaken = true; 
                    character.weakenCount = (character.weakenCount || 0) + 1; 
                } 
            },
            { 
                id: 'damageBoost', 
                name: 'Îç∞ÎØ∏ÏßÄ 1.2Î∞∞', 
                description: 'Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ *1.2', 
                effect: (character) => { 
                    character.damage = (character.damage || 1) * 1.2; 
                    character.hasDamageBoost = true; 
                } 
            },
            { 
                id: 'lightning', 
                name: 'Î≤àÍ∞ú', 
                description: 'Ï†ÅÏóêÍ≤å Ï¥ùÏïåÏùÑ ÎßûÏ∂ú Ïãú 25% ÌôïÎ•†Î°ú Ï†Å 0.75Ï¥à Í∏∞Ï†à', 
                effect: (character) => { 
                    character.hasLightning = true; 
                    character.lightningCount = (character.lightningCount || 0) + 1; 
                } 
            },
            { 
                id: 'shield', 
                name: 'Î∞©Ïñ¥Îßâ', 
                description: 'Î∞õÎäî Îç∞ÎØ∏ÏßÄ 1Ìöå Î¨¥Ïãú (Ïø®ÌÉÄÏûÑ 7.5Ï¥à)', 
                effect: (character) => { 
                    character.hasShield = true; 
                    character.shieldReady = true; // Î∞©Ïñ¥Îßâ Ï§ÄÎπÑÎê®
                    character.shieldCooldown = 0; // Ïø®ÌÉÄÏûÑ
                } 
            },
            { 
                id: 'regeneration', 
                name: 'Ïû¨ÏÉù', 
                description: '1Ï¥àÎßàÎã§ Ï≤¥Î†• 0.1 ÌöåÎ≥µ', 
                effect: (character) => { 
                    character.hasRegeneration = true; 
                    character.lastRegenTime = 0; // ÎßàÏßÄÎßâ ÌöåÎ≥µ ÏãúÍ∞Ñ
                    character.regenerationCount = (character.regenerationCount || 0) + 1; 
                } 
            },
            { 
                id: 'evasiveManeuver', 
                name: 'ÌöåÌîºÍ∏∞Îèô', 
                description: 'Ïû¨Ïû•Ï†Ñ Ï§ë Ïù¥ÎèôÏÜçÎèÑ +75%', 
                effect: (character) => { 
                    character.hasEvasiveManeuver = true; 
                    character.evasiveManeuverCount = (character.evasiveManeuverCount || 0) + 1; 
                } 
            },
            { 
                id: 'combatExperience', 
                name: 'Ï†ÑÌà¨ Í≤ΩÌóò', 
                description: 'ÏßÑ ÎùºÏö¥Îìú ÏàòÎßàÎã§ ÏµúÎåÄÏ≤¥Î†• 0.5, Îç∞ÎØ∏ÏßÄ 0.1 Ï¶ùÍ∞Ä', 
                effect: (character) => { 
                    character.hasCombatExperience = true; 
                    character.combatExperienceRounds = 0; // ÌòÑÏû¨ ÎùºÏö¥Îìú Ïàò
                    character.combatExperienceCount = (character.combatExperienceCount || 0) + 1; 
                } 
            },
            { 
                id: 'hallucination', 
                name: 'ÌôòÍ∞Å', 
                description: 'Ï¥ùÏïåÏù¥ ÎÇ†ÏïÑÍ∞ÄÎäî ÎèÑÏ§ëÏóê 0.1Ï¥àÎßàÎã§ ÏÜçÎèÑÍ∞Ä 0.75Î∞∞~2Î∞∞ ÏÇ¨Ïù¥Î°ú ÎûúÎç§ÏúºÎ°ú Ï°∞Ï†ïÎê®', 
                effect: (character) => { 
                    character.hasHallucination = true; 
                } 
            },
            { 
                id: 'tasteOfBlood', 
                name: 'ÌîºÏùò Îßõ', 
                description: 'Ï†ÅÏóêÍ≤å ÏûÖÌûå ÌîºÌï¥Ïùò 20%ÎßåÌÅº ÌöåÎ≥µ', 
                effect: (character) => { 
                    character.hasTasteOfBlood = true; 
                    character.tasteOfBloodCount = (character.tasteOfBloodCount || 0) + 1; 
                } 
            },
            { 
                id: 'cannon', 
                name: 'ÎåÄÌè¨', 
                description: 'Ï¥ùÏïåÏùò ÏÜçÎèÑ -50% ÎåÄÏã† Ï¥ùÏïåÏùò ÌÅ¨Í∏∞ +200%', 
                effect: (character) => { 
                    // ÏÜçÎèÑÎäî 0.5Î∞∞Ïî© Í≥±ÌïòÍ∏∞ (Ï§ëÏ≤©)
                    character.bulletSpeedMultiplier = (character.bulletSpeedMultiplier || 1) * 0.5; 
                    // ÌÅ¨Í∏∞Îäî 200%Ïî© Ï§ëÏ≤© (3Î∞∞Ïî© Í≥±ÌïòÍ∏∞)
                    character.bulletSizeMultiplier = (character.bulletSizeMultiplier || 1) * 3; // +200% = 3Î∞∞
                    character.hasCannon = true; 
                } 
            },
            { 
                id: 'timeBarrier', 
                name: 'ÏãúÍ∞ÑÏû•Îßâ', 
                description: 'ÏûêÏã† Ï£ºÏúÑÏùò Î∞òÏßÄÎ¶Ñ 150pxÏßúÎ¶¨ Ïõê ÏÉùÏÑ±, Ïù¥ Ïõê ÏïàÏóê Îì§Ïñ¥Ïò§Îäî Ï†ÅÏùò Ï¥ùÏïå 35% ÎëîÌôî', 
                effect: (character) => { 
                    character.hasTimeBarrier = true; 
                    character.timeBarrierRadius = 150; 
                } 
            },
            { 
                id: 'bouncyBullet', 
                name: 'ÌÜµÌÜµÌÉÑ', 
                description: 'Ï¥ùÏïåÏù¥ Î≤ΩÏóê ÎßûÏúºÎ©¥ 1Ìöå ÌäïÍπÄ', 
                effect: (character) => { 
                    character.hasBouncyBullet = true; 
                    character.bouncyBulletCount = (character.bouncyBulletCount || 0) + 1; 
                } 
            },
            { 
                id: 'gamble2', 
                name: 'Ïä§ÎÑ§Ïù¥ÌÅ¨', 
                description: 'Ï¥ùÏïåÏù¥ ÎÇ†ÏïÑÍ∞ÄÎäî ÎèÑÏ§ëÏóê 0.2Ï¥àÎßàÎã§ ¬±20ÎèÑÎßåÌÅº ÎûúÎç§ÏúºÎ°ú Î∞©Ìñ• Ï†ÑÌôò + Ï¥ùÏïåÏÜçÎèÑ -50% + Î∞úÏÇ¨ÏÜçÎèÑ -50%', 
                effect: (character) => { 
                    character.hasGamble2 = true; 
                    character.bulletSpeedMultiplier = (character.bulletSpeedMultiplier || 1) * 0.5;
                    character.shootCooldown *= 0.5; // Î∞úÏÇ¨ÏÜçÎèÑ -50% (Ïø®ÌÉÄÏûÑ Ï†àÎ∞ò)
                } 
            },
            { 
                id: 'reflect', 
                name: 'Î∞òÏÇ¨', 
                description: '5Ï¥àÎßàÎã§ Ïö∞ÌÅ¥Î¶≠ÏúºÎ°ú 0.1Ï¥àÎèôÏïà Î∞òÏÇ¨Î•º Ìï† Ïàò ÏûàÎäî Î≥¥Ìò∏ÎßâÏùÑ ÏñªÏùÑ Ïàò ÏûàÏùå. Î≥¥Ìò∏ÎßâÏù¥ ÏûàÎäîÎèôÏïà Ï†ÅÏùò Ï¥ùÏïåÏóê ÎßûÏúºÎ©¥ ÏÉÅÎåÄÍ∞Ä ÏûàÎäî Ï™ΩÏúºÎ°ú ÎÇ†ÏïÑÍ∞ê', 
                effect: (character) => { 
                    character.hasReflect = true;
                    character.reflectCooldown = 0;
                } 
            },
            { 
                id: 'gatling', 
                name: 'Í≤åÌãÄÎßÅ', 
                description: 'Í≥µÍ≤© Ïãú ÎÇ®ÏùÄ ÌÉÑÏïΩÏùÑ Î™®Îëê ÏÇ¨Ïö©Ìï¥ Í∑∏ Í∞ØÏàòÎßåÌÅº 0.1Ï¥àÎßàÎã§ ÎßàÏö∞Ïä§Í∞Ä Î≥¥Í≥†ÏûàÎäî Î∞©Ìñ•ÏúºÎ°ú Ï¥ùÏïå Î∞úÏÇ¨ + Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ +0.5Ï¥à', 
                effect: (character) => { 
                    character.hasGatling = true;
                    character.reloadTime += 500; // Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ +0.5Ï¥à
                } 
            },
            { 
                id: 'timeStop', 
                name: 'ÏãúÍ∞ÑÏ†ïÏßÄ', 
                description: '10Ï¥àÎßàÎã§ Ïö∞ÌÅ¥Î¶≠ÏúºÎ°ú 1Ï¥àÎèôÏïà ÏãúÍ∞ÑÏùÑ Ï†ïÏßÄÏãúÏºú ÏÉÅÎåÄÏùò Ï¥ùÏïåÏùÄ Í∑∏ ÏÉÅÌÉúÏóêÏÑú Î©àÏ∂îÍ≥†, ÏÉÅÎåÄÎäî ÏõÄÏßÅÏù¥ÏßÄ Î™ªÌïòÍ≤å Ìï† Ïàò ÏûàÏùå', 
                effect: (character) => { 
                    character.hasTimeStop = true;
                    character.timeStopCooldown = 0;
                } 
            },
            { 
                id: 'scatter', 
                name: 'ÎπÑÏÇ∞ÌÉÑ', 
                description: 'Ï¥ùÏïå ÌÅ¨Í∏∞ -25%, Ï¥ùÏïåÏù¥ ¬±4ÎèÑ ÏÇ¨Ïù¥ÏóêÏÑú 2ÎèÑ Í∞ÑÍ≤©ÏúºÎ°ú 4Í∞úÎ°ú ÎÇòÎàî + ÌïúÎ∞úÎãπ Îç∞ÎØ∏ÏßÄ 0.25Î∞∞', 
                effect: (character) => { 
                    character.hasScatter = true;
                    character.bulletSizeMultiplier = (character.bulletSizeMultiplier || 1) * 0.75; // Ï¥ùÏïå ÌÅ¨Í∏∞ -25%
                } 
            },
            { 
                id: 'rocket', 
                name: 'Î°úÏºìÌÉÑ', 
                description: 'Ï¥ùÏïå ÏÜçÎèÑÍ∞Ä Ï¥àÍ∏∞ ÏÜçÎèÑÏùò 0.1Î∞∞Î∂ÄÌÑ∞ ÏãúÏûëÌï¥ 0.2Ï¥àÎßàÎã§ 2Î∞∞Ïî© Ï¶ùÍ∞Ä (ÏµúÎåÄ 6.4Î∞∞)', 
                effect: (character) => { 
                    character.hasRocket = true; 
                } 
            },
            { 
                id: 'trinity', 
                name: 'ÏÇºÏúÑÏùºÏ≤¥', 
                description: 'Ïù¥ÎèôÏÜçÎèÑ +10%, Î∞úÏÇ¨ÏÜçÎèÑ +10%, ÏµúÎåÄÏ≤¥Î†• +0.5', 
                effect: (character) => { 
                    character.speed *= 1.1;
                    character.shootCooldown *= 0.9; // Î∞úÏÇ¨ÏÜçÎèÑ +10% (Ïø®ÌÉÄÏûÑ 10% Í∞êÏÜå)
                    character.maxHealth += 0.5;
                    character.health += 0.5;
                    character.hasTrinity = true;
                } 
            },
            { 
                id: 'judgment', 
                name: 'ÏÑ†Í≥†', 
                description: 'Ï†ÅÏùÑ ÎßûÏ∂ú Ïãú Ï†ÅÏù¥ ÎßûÏùÄ Î∞©Ìñ•ÏúºÎ°ú 75px Î∞ÄÎ†§ÎÇ©ÎãàÎã§', 
                effect: (character) => { 
                    character.hasJudgment = true;
                } 
            },
            { 
                id: 'boomerang', 
                name: 'Î∂ÄÎß§Îûë', 
                description: 'Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ -0.25, Ï¥ùÏïåÏùò ÏµúÎåÄ ÏÇ¨Í±∞Î¶¨ 850pxÎ°ú Ï†úÌïú ÎåÄÏã† Ï¥ùÏïåÏù¥ ÏµúÎåÄ ÏÇ¨Í±∞Î¶¨ÍπåÏßÄ Í∞îÎã§Í∞Ä Îã§Ïãú ÎêòÎèåÏïÑÏòµÎãàÎã§', 
                effect: (character) => { 
                    character.hasBoomerang = true;
                } 
            },
        ];

        // ÌÇ§ ÏûÖÎ†• ÏÉÅÌÉú
        const keys = {};
        let mouse = { x: 0, y: 0 };
        let hoveredAugment = null; // ÎßàÏö∞Ïä§ Ìò∏Î≤ÑÎêú Ï¶ùÍ∞ï Ï†ïÎ≥¥

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        canvas.addEventListener('click', (e) => {
            if (!gameState.isPaused && !gameState.isGameOver && !player.isDodging) {
                shoot(player);
            }
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault(); // Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ Î∞©ÏßÄ
            
            if (gameState.isPaused || gameState.isGameOver) return;
            
            // ÌîåÎ†àÏù¥Ïñ¥ Íµ¨Î•¥Í∏∞ (Ïö∞ÌÅ¥Î¶≠)
            if (player.hasDodge && !player.isDodging) {
                    dodge(player);
            }
            
            // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ ÌôúÏÑ±Ìôî (Ïö∞ÌÅ¥Î¶≠)
            if (player.hasReflect && !player.reflectActive && player.reflectCooldown === 0) {
                player.reflectActive = true;
                player.reflectEndTime = Date.now() + 100; // 0.1Ï¥à
            }
            
            // ÏãúÍ∞ÑÏ†ïÏßÄ ÌôúÏÑ±Ìôî (Ïö∞ÌÅ¥Î¶≠)
            if (player.hasTimeStop && !player.timeStopActive && player.timeStopCooldown === 0) {
                player.timeStopActive = true;
                player.timeStopEndTime = Date.now() + 1000; // 1Ï¥à
            }
        });

        // Ï¥ùÏïå ÌÅ¥ÎûòÏä§
        class Bullet {
            constructor(x, y, angle, owner, isFreeShot = false) {
                this.x = x;
                this.y = y;
                this.startX = x; // ÏãúÏûë ÏúÑÏπò Ï†ÄÏû• (Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÏö©)
                this.startY = y;
                this.angle = angle;
                this.createTime = Date.now(); // ÏÉùÏÑ± ÏãúÍ∞Ñ Ï†ÄÏû• (10Ï¥à ÌõÑ ÏÇ≠Ï†úÏö©)
                const baseSpeed = 20;
                const speedMultiplier = owner.bulletSpeedMultiplier || 1;
                this.speed = baseSpeed * speedMultiplier;
                this.baseSpeed = this.speed; // ÏõêÎûò ÏÜçÎèÑ Ï†ÄÏû• (ÏãúÍ∞ÑÏû•ÎßâÏö©)
                // ÌôòÍ∞Å: ÎÇ†ÏïÑÍ∞ÄÎäî ÎèÑÏ§ëÏóê 0.1Ï¥àÎßàÎã§ ÏÜçÎèÑ Î≥ÄÍ≤ΩÏùÑ ÏúÑÌïú Î≥ÄÏàò
                if (owner.hasHallucination) {
                    this.hallucinationLastChange = Date.now(); // ÎßàÏßÄÎßâ ÏÜçÎèÑ Î≥ÄÍ≤Ω ÏãúÍ∞Ñ
                    // Ï¥àÍ∏∞ ÏÜçÎèÑÎèÑ ÎûúÎç§ÏúºÎ°ú ÏÑ§Ï†ï (0.75Î∞∞~2Î∞∞)
                    const randomMultiplier = 0.75 + Math.random() * 1.25; // 0.75 ~ 2.0
                    this.hallucinationSpeed = this.baseSpeed * randomMultiplier;
                    this.speed = this.hallucinationSpeed; // Ï¥àÍ∏∞ ÏÜçÎèÑÎäî ÌôòÍ∞Å ÏÜçÎèÑÎ°ú
                }
                this.isInTimeBarrier = false; // ÏãúÍ∞ÑÏû•Îßâ ÏïàÏóê ÏûàÎäîÏßÄ Ïó¨Î∂Ä
                const sizeMultiplier = owner.bulletSizeMultiplier || 1;
                this.radius = 9 * sizeMultiplier;
                this.owner = owner;
                this.damage = owner.damage || 1;
                // Î∂ÄÎß§Îûë: Ï¥ùÏïå Îç∞ÎØ∏ÏßÄ -0.25
                if (owner.hasBoomerang) {
                    this.damage = Math.max(0.25, this.damage - 0.25);
                }
                // ÎπÑÏû•Ïùò ÌïúÎ∞ú: ÎßàÏßÄÎßâ ÌÉÑÌôòÏùò Îç∞ÎØ∏ÏßÄ +1.5 (Ï§ëÏ≤©)
                if (owner.hasLastBullet && owner.ammo === 1) {
                    const lastBulletCount = owner.lastBulletCount || 1;
                    this.damage += 1.5 * lastBulletCount;
                }
                // ÏïΩÌôî ÏÉÅÌÉú: Î™®Îì† Í≥µÍ≤© Îç∞ÎØ∏ÏßÄ -0.25 (Ï§ëÏ≤©)
                if (owner.isWeakened) {
                    const weakenCount = owner.weakenCount || 1;
                    this.damage = Math.max(0.25, this.damage - (0.25 * weakenCount));
                }
                this.isFreeShot = isFreeShot; // ÌÉÑÏïΩ ÏÜåÎ™® ÏóÜÎäî Ï¥ùÏïå (ÎçîÎ∏îÏÉ∑Ïö©)
                this.hasPoison = owner.hasPoisonBullet || false; // ÎèÖ ÌÉÑÌôò Ïó¨Î∂Ä
                this.hasBouncy = owner.hasBouncyBullet || false; // ÌÜµÌÜµÌÉÑ Ïó¨Î∂Ä
                this.bounceCount = 0; // ÌäïÍπÄ ÌöüÏàò
                this.maxBounces = owner.hasBouncyBullet ? (owner.bouncyBulletCount || 1) : 0; // ÏµúÎåÄ ÌäïÍπÄ ÌöüÏàò
                this.lastX = x; // Ïù¥Ï†Ñ ÏúÑÏπò (Î≤Ω Ï∂©Îèå Í∞êÏßÄÏö©)
                this.lastY = y;
                // ÎèÑÎ∞ïÌÉÑ_2: 0.2Ï¥àÎßàÎã§ ¬±10ÎèÑ ÎûúÎç§ Î∞©Ìñ• Ï†ÑÌôò
                if (owner.hasGamble2) {
                    this.gamble2LastChange = Date.now();
                }
                // Î°úÏºìÌÉÑ: 0.1Î∞∞Î∂ÄÌÑ∞ ÏãúÏûë, 0.2Ï¥àÎßàÎã§ 2Î∞∞Ïî© Ï¶ùÍ∞Ä
                if (owner.hasRocket) {
                    this.rocketSpeed = this.baseSpeed * 0.1; // 0.1Î∞∞
                    this.rocketLastChange = Date.now();
                    this.speed = this.rocketSpeed;
                }
                // Í∑ºÏ†ëÏ†ÑÎ™®Îìú: Î©àÏ∂§ ÏÉÅÌÉú
                this.isStopped = false; // Î©àÏ∂§ Ïó¨Î∂Ä
                this.stopTime = 0; // Î©àÏ∂ò ÏãúÍ∞Ñ
                this.fadeStartTime = 0; // ÌéòÏù¥Îìú ÏïÑÏõÉ ÏãúÏûë ÏãúÍ∞Ñ
                // Î∂ÄÎß§Îûë: Ï¥ùÏïåÏù¥ ÎêòÎèåÏïÑÏò¥
                this.hasBoomerang = owner.hasBoomerang || false;
                this.isReturning = false; // ÎêòÎèåÏïÑÍ∞ÄÎäî Ï§ëÏù∏ÏßÄ
                this.maxDistance = owner.hasBoomerang ? 850 : Infinity; // ÏµúÎåÄ ÏÇ¨Í±∞Î¶¨
            }

            update() {
                // Î°úÏºìÌÉÑ: 0.2Ï¥àÎßàÎã§ ÏÜçÎèÑ 2Î∞∞Ïî© Ï¶ùÍ∞Ä (ÏµúÎåÄ 6.4Î∞∞)
                if (this.owner && this.owner.hasRocket && this.rocketSpeed !== undefined) {
                    const now = Date.now();
                    if (now - this.rocketLastChange >= 200) { // 0.2Ï¥à = 200ms
                        if (this.rocketSpeed < this.baseSpeed * 6.4) {
                            this.rocketSpeed *= 2;
                            if (this.rocketSpeed > this.baseSpeed * 6.4) {
                                this.rocketSpeed = this.baseSpeed * 6.4;
                            }
                        }
                        this.rocketLastChange = now;
                    }
                    // ÏãúÍ∞ÑÏû•ÎßâÏù¥ ÏóÜÍ±∞ÎÇò Î∞ñÏóê ÏûàÏùÑ ÎïåÎßå Î°úÏºì ÏÜçÎèÑ Ï†ÅÏö©
                    if (!this.isInTimeBarrier) {
                        this.speed = this.rocketSpeed;
                    }
                }
                
                // Ïä§ÎÑ§Ïù¥ÌÅ¨: 0.2Ï¥àÎßàÎã§ ¬±20ÎèÑ ÎûúÎç§ Î∞©Ìñ• Ï†ÑÌôò
                if (this.owner && this.owner.hasGamble2 && this.gamble2LastChange !== undefined) {
                    const now = Date.now();
                    if (now - this.gamble2LastChange >= 200) { // 0.2Ï¥à = 200ms
                        const randomOffset = (Math.random() - 0.5) * 40 * Math.PI / 180; // ¬±20ÎèÑ
                        this.angle += randomOffset;
                        this.gamble2LastChange = now;
                    }
                }
                
                // ÌôòÍ∞Å: ÎÇ†ÏïÑÍ∞ÄÎäî ÎèÑÏ§ëÏóê 0.1Ï¥àÎßàÎã§ Ï¥ùÏïå ÏÜçÎèÑÎ•º Ïã§ÏãúÍ∞ÑÏúºÎ°ú Î≥ÄÍ≤Ω
                if (this.owner && this.owner.hasHallucination && this.hallucinationLastChange !== undefined) {
                    const now = Date.now();
                    if (now - this.hallucinationLastChange >= 100) { // 0.1Ï¥à = 100ms
                        // 0.75Î∞∞~2Î∞∞ ÏÇ¨Ïù¥Î°ú ÎûúÎç§ Ï°∞Ï†ï
                        const randomMultiplier = 0.75 + Math.random() * 1.25; // 0.75 ~ 2.0
                        this.hallucinationSpeed = this.baseSpeed * randomMultiplier;
                        this.hallucinationLastChange = now;
                    }
                    // ÌôòÍ∞Å ÏÜçÎèÑ ÏÇ¨Ïö© (ÏãúÍ∞ÑÏû•ÎßâÏù¥ Ï†ÅÏö©ÎêòÎ©¥ Í∑∏Í≤å Ïö∞ÏÑ†Ïù¥ÎØÄÎ°ú ÏãúÍ∞ÑÏû•Îßâ Î°úÏßÅÏóêÏÑú Ï≤òÎ¶¨)
                    // ÏãúÍ∞ÑÏû•ÎßâÏù¥ ÏóÜÍ±∞ÎÇò Î∞ñÏóê ÏûàÏùÑ ÎïåÎßå ÌôòÍ∞Å ÏÜçÎèÑ Ï†ÅÏö©
                    if (!this.isInTimeBarrier && !this.owner.hasRocket) { // Î°úÏºìÌÉÑÏù¥ ÏûàÏúºÎ©¥ Î°úÏºì ÏÜçÎèÑ Ïö∞ÏÑ†
                        this.speed = this.hallucinationSpeed;
                    }
                }
                
                // Î∂ÄÎß§Îûë: Ï¥ùÏïåÏù¥ ÏµúÎåÄ ÏÇ¨Í±∞Î¶¨ÍπåÏßÄ Í∞ÄÍ±∞ÎÇò Îßµ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎ©¥ ÎêòÎèåÏïÑÏò¥
                if (this.hasBoomerang && !this.isReturning) {
                    const distance = Math.sqrt(
                        Math.pow(this.x - this.startX, 2) + 
                        Math.pow(this.y - this.startY, 2)
                    );
                    
                    // Îßµ Î∞ñÏúºÎ°ú ÎÇòÍ∞îÍ±∞ÎÇò ÏµúÎåÄ ÏÇ¨Í±∞Î¶¨Ïóê ÎèÑÎã¨ÌïòÎ©¥ ÎêòÎèåÏïÑÍ∞ÄÍ∏∞ ÏãúÏûë
                    if (this.isOutOfBounds() || distance >= this.maxDistance) {
                        // ÎêòÎèåÏïÑÍ∞ÄÍ∏∞ ÏãúÏûë
                        this.isReturning = true;
                        // ÏÜçÎèÑÍ∞Ä Îß§Ïö∞ Ï§ÑÏñ¥Îì¶
                        this.speed = this.baseSpeed * 0.1;
                    }
                }
                
                // Î∂ÄÎß§Îûë: ÎêòÎèåÏïÑÍ∞ÄÎäî Ï§ë
                if (this.hasBoomerang && this.isReturning) {
                    // ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ•ÏúºÎ°ú Ïù¥Îèô
                    const dxToOwner = this.owner.x - this.x;
                    const dyToOwner = this.owner.y - this.y;
                    const distanceToOwner = Math.sqrt(dxToOwner * dxToOwner + dyToOwner * dyToOwner);
                    
                    if (distanceToOwner > 0) {
                        this.angle = Math.atan2(dyToOwner, dxToOwner);
                        // ÏÜçÎèÑ Ï†êÏßÑÏ†ÅÏúºÎ°ú Ï¶ùÍ∞Ä
                        this.speed = Math.min(this.baseSpeed * 1.5, this.speed * 1.05);
                    }
                }
                
                // ÌÜµÌÜµÌÉÑ: Î≤ΩÏóê ÎßûÏúºÎ©¥ ÌäïÍπÄ (Ï§ëÏ≤© ÌöüÏàòÎßåÌÅº)
                if (this.hasBouncy && this.bounceCount < this.maxBounces) {
                    const nextX = this.x + Math.cos(this.angle) * this.speed;
                    const nextY = this.y + Math.sin(this.angle) * this.speed;
                    
                    // Î≤Ω Ï∂©Îèå Í∞êÏßÄ
                    let hitWall = false;
                    let newAngle = this.angle;
                    
                    // ÏôºÏ™Ω Î≤Ω ÎòêÎäî Ïò§Î•∏Ï™Ω Î≤ΩÏóê Ï∂©Îèå
                    if (nextX - this.radius < 0 || nextX + this.radius > canvas.width) {
                        hitWall = true;
                        // Î∞òÎåÄÎ∞©Ìñ•ÏóêÏÑú ¬±25ÎèÑ (ÏàòÌèâ Î∞òÏÇ¨)
                        const reflectAngle = Math.PI - this.angle; // Î∞òÏÇ¨Í∞Å
                        const randomOffset = (Math.random() - 0.5) * 50 * Math.PI / 180; // ¬±25ÎèÑ
                        newAngle = reflectAngle + randomOffset;
                    }
                    // ÏúÑÏ™Ω Î≤Ω ÎòêÎäî ÏïÑÎûòÏ™Ω Î≤ΩÏóê Ï∂©Îèå
                    if (nextY - this.radius < 0 || nextY + this.radius > canvas.height) {
                        hitWall = true;
                        // Î∞òÎåÄÎ∞©Ìñ•ÏóêÏÑú ¬±25ÎèÑ (ÏàòÏßÅ Î∞òÏÇ¨)
                        const reflectAngle = -this.angle; // Î∞òÏÇ¨Í∞Å
                        const randomOffset = (Math.random() - 0.5) * 50 * Math.PI / 180; // ¬±25ÎèÑ
                        newAngle = reflectAngle + randomOffset;
                    }
                    
                    if (hitWall) {
                        this.bounceCount++;
                        this.angle = newAngle;
                        // Î≤Ω Í≤ΩÍ≥ÑÎ°ú ÏúÑÏπò Ï°∞Ï†ï (Îßµ Í≤ΩÍ≥Ñ ÏÇ¨Ïö©)
                        this.x = Math.max(gameState.mapBounds.minX + this.radius, Math.min(gameState.mapBounds.maxX - this.radius, this.x));
                        this.y = Math.max(gameState.mapBounds.minY + this.radius, Math.min(gameState.mapBounds.maxY - this.radius, this.y));
                    } else {
                        this.x = nextX;
                        this.y = nextY;
                    }
                } else {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // ÌéòÏù¥Îìú ÏïÑÏõÉ Ìö®Í≥º (Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÏóêÏÑú Î©àÏ∂ò Ï¥ùÏïå)
                let alpha = 1.0;
                if (this.isStopped && this.fadeStartTime > 0) {
                    const fadeElapsed = Date.now() - this.fadeStartTime;
                    const fadeDuration = 300; // 0.3Ï¥à
                    alpha = Math.max(0, 1 - (fadeElapsed / fadeDuration));
                }
                ctx.globalAlpha = alpha;
                
                // ÏßÅÏÇ¨Í∞ÅÌòï Ï¥ùÏïå Í∑∏Î¶¨Í∏∞ (ÎÑ§Ïò® Ìö®Í≥º Ï∂îÍ∞Ä)
                // ÎèÖ ÌÉÑÌôòÏù¥Î©¥ Ïñ¥ÎëêÏö¥ Ï¥àÎ°ùÏÉâ, ÏïÑÎãàÎ©¥ ÌïòÏñÄÏÉâ
                const bulletColor = this.hasPoison ? '#006600' : '#ffffff';
                ctx.fillStyle = bulletColor;
                ctx.shadowBlur = 10;
                ctx.shadowColor = bulletColor;
                const sizeMultiplier = this.owner.bulletSizeMultiplier || 1;
                const bulletWidth = 24 * sizeMultiplier; // Ï¥ùÏïå ÎÑàÎπÑ
                const bulletHeight = 9 * sizeMultiplier; // Ï¥ùÏïå ÎÜíÏù¥
                ctx.fillRect(-bulletWidth / 2, -bulletHeight / 2, bulletWidth, bulletHeight);
                
                ctx.globalAlpha = 1.0; // Î≥µÏõê
                ctx.restore();
            }

            isOutOfBounds() {
                // Îßµ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                return this.x < gameState.mapBounds.minX || this.x > gameState.mapBounds.maxX || 
                       this.y < gameState.mapBounds.minY || this.y > gameState.mapBounds.maxY;
            }
        }

        // ÏÜåÏàòÏ†ê Î∞òÏò¨Î¶º Ìó¨Ìçº Ìï®Ïàò: 1~2ÏûêÎ¶¨Îäî Ïú†ÏßÄ, 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏùÄ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º
        function roundToMaxTwoDecimals(value) {
            const strValue = value.toString();
            const decimalIndex = strValue.indexOf('.');
            if (decimalIndex === -1) {
                return value; // Ï†ïÏàòÎ©¥ Í∑∏ÎåÄÎ°ú
            }
            const decimalPart = strValue.substring(decimalIndex + 1);
            if (decimalPart.length <= 2) {
                return value; // 2ÏûêÎ¶¨ Ïù¥ÌïòÎ©¥ Í∑∏ÎåÄÎ°ú
            }
            // 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º
            return Math.round(value * 100) / 100;
        }

        // ÌôîÎ©¥ ÌùîÎì§Î¶º Ìï®Ïàò
        function addScreenShake(intensity, duration) {
            gameState.shake.intensity = intensity;
            gameState.shake.duration = duration;
        }

        // Î∞úÏÇ¨ Ìï®Ïàò
        function shoot(character) {
            const now = Date.now();
            // Í∏∞Ï†à ÏÉÅÌÉúÎ©¥ Î∞úÏÇ¨ Î∂àÍ∞Ä
            if (character.isStunned) return;
            if (character.ammo > 0 && !character.isReloading && 
                now - character.lastShot > character.shootCooldown) {
                
                // Í≤åÌãÄÎßÅ Ï¶ùÍ∞ï: ÎÇ®ÏùÄ ÌÉÑÏïΩ Î™®Îëê ÏÇ¨Ïö©, 0.1Ï¥àÎßàÎã§ Î∞úÏÇ¨
                if (character.hasGatling) {
                    character.gatlingBullets = character.ammo;
                    character.ammo = 0; // Î™®Îì† ÌÉÑÏïΩ ÏÜåÎ™®
                    character.gatlingNextShot = now; // Ï≤´ Î∞úÏÇ¨Îäî Ï¶âÏãú
                    character.lastShot = now; // Ïø®ÌÉÄÏûÑ Ï†ÅÏö©
                    return; // Ïã§Ï†ú Î∞úÏÇ¨Îäî Í≤åÏûÑ Î£®ÌîÑÏóêÏÑú Ï≤òÎ¶¨
                }
                
                // ÎπÑÏÇ∞ÌÉÑ Ï¶ùÍ∞ïÏù¥ ÏûàÏùÑ ÎïåÏùò Î∞úÏÇ¨ Ï≤òÎ¶¨
                if (character.hasScatter) {
                    // ÎπÑÏÇ∞ÌÉÑ: ¬±4ÎèÑ Î≤îÏúÑÏóêÏÑú 2ÎèÑ Í∞ÑÍ≤©ÏúºÎ°ú 4Í∞úÎ°ú ÎÇòÎàî + Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                    const scatterAngles = [-4, -2, 0, 2];
                    
                    if (character.hasShotgun) {
                        // ÏÉ∑Í±¥ + ÎπÑÏÇ∞ÌÉÑ: Î™®Îì† ÌÉÑÏïΩÏùÑ ÏÉ∑Í±¥ÏúºÎ°ú Î∞úÏÇ¨ÌïòÎêò, Í∞Å Ï¥ùÏïåÏùÑ ÎπÑÏÇ∞ÌÉÑÏúºÎ°ú Î∂ÑÏÇ∞
                        const currentAmmo = character.ammo;
                        for (let i = 0; i < currentAmmo; i++) {
                            // ¬±20ÎèÑ Î≤îÏúÑ ÎÇ¥ ÎûúÎç§ Í∞ÅÎèÑ
                            const randomAngle = (Math.random() - 0.5) * (Math.PI * 40 / 180); // -20ÎèÑ ~ +20ÎèÑ
                            const baseAngle = character.angle + randomAngle;
                            
                            // Í∞Å Ï¥ùÏïåÏùÑ ÎπÑÏÇ∞ÌÉÑÏúºÎ°ú Î∂ÑÏÇ∞
                            scatterAngles.forEach(angleDeg => {
                                const angle = baseAngle + (angleDeg * Math.PI / 180);
                                const bullet = new Bullet(
                                    character.x + Math.cos(character.angle) * character.radius,
                                    character.y + Math.sin(character.angle) * character.radius,
                                    angle,
                                    character,
                                    false
                                );
                                bullet.damage = bullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                                character.bullets.push(bullet);
                            });
                        }
                        character.ammo = 0; // Î™®Îì† ÌÉÑÏïΩ ÏÜåÎ™®
                        character.lastShot = now;
                    } else {
                        // ÎπÑÏÇ∞ÌÉÑÎßå: Ìïú Î∞úÏî© Î∞úÏÇ¨Ìï† Îïå ¬±4ÎèÑ Î≤îÏúÑÏóêÏÑú 2ÎèÑ Í∞ÑÍ≤©ÏúºÎ°ú 4Í∞úÎ°ú ÎÇòÎàî
                        scatterAngles.forEach(angleDeg => {
                            const angle = character.angle + (angleDeg * Math.PI / 180);
                            const bullet = new Bullet(
                                character.x + Math.cos(character.angle) * character.radius,
                                character.y + Math.sin(character.angle) * character.radius,
                                angle,
                                character,
                                false
                            );
                            bullet.damage = bullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                            character.bullets.push(bullet);
                        });
                        character.ammo--; // Ìïú Î∞úÎßå ÏÜåÎ™®
                        character.lastShot = now;
                    }
                } else if (character.hasShotgun) {
                // ÏÉ∑Í±¥ Ï¶ùÍ∞ï: Î™®Îì† ÌÉÑÏïΩÏùÑ ¬±20ÎèÑ Î≤îÏúÑÏóêÏÑú ÌïúÎ≤àÏóê Î∞úÏÇ¨
                    const currentAmmo = character.ammo;
                    for (let i = 0; i < currentAmmo; i++) {
                        // ¬±20ÎèÑ Î≤îÏúÑ ÎÇ¥ ÎûúÎç§ Í∞ÅÎèÑ
                        const randomAngle = (Math.random() - 0.5) * (Math.PI * 40 / 180); // -20ÎèÑ ~ +20ÎèÑ
                const bullet = new Bullet(
                    character.x + Math.cos(character.angle) * character.radius,
                    character.y + Math.sin(character.angle) * character.radius,
                            character.angle + randomAngle,
                    character,
                    false
                );
                        character.bullets.push(bullet);
                    }
                    character.ammo = 0; // Î™®Îì† ÌÉÑÏïΩ ÏÜåÎ™®
                    character.lastShot = now;
                } else {
                    // ÏùºÎ∞ò Î∞úÏÇ¨
                    let bulletAngle = character.angle;
                    let bulletDamage = character.damage || 1;
                    
                    // ÎèÑÎ∞ï Ï¶ùÍ∞ï: ¬±10ÎèÑ ÎûúÎç§ Í∞ÅÎèÑ, Îç∞ÎØ∏ÏßÄ 1~2Î∞∞ ÎûúÎç§
                    if (character.hasGamble) {
                        const randomAngle = (Math.random() - 0.5) * (Math.PI * 20 / 180); // ¬±10ÎèÑ
                        bulletAngle = character.angle + randomAngle;
                        bulletDamage = bulletDamage * (1 + Math.random()); // 1~2Î∞∞
                        bulletDamage = Math.round(bulletDamage * 10) / 10; // ÏÜåÏàòÏ†ê 1ÏûêÎ¶¨ÍπåÏßÄÎßå Î∞òÏò¨Î¶º
                    }
                    
                    // ÎπÑÏÇ∞ÌÉÑÏù¥ ÏûàÏúºÎ©¥ ÏùºÎ∞ò Î∞úÏÇ¨ÎèÑ ÎπÑÏÇ∞ÌÉÑÏúºÎ°ú Î∂ÑÏÇ∞
                    if (character.hasScatter) {
                        const scatterAngles = [-4, -2, 0, 2];
                        scatterAngles.forEach(angleDeg => {
                            const scatterAngle = bulletAngle + (angleDeg * Math.PI / 180);
                            const bullet = new Bullet(
                                character.x + Math.cos(character.angle) * character.radius,
                                character.y + Math.sin(character.angle) * character.radius,
                                scatterAngle,
                                character,
                                false
                            );
                            // ÎèÑÎ∞ï Ï¶ùÍ∞ï: Îç∞ÎØ∏ÏßÄ ÎûúÎç§ Ï†ÅÏö©
                            if (character.hasGamble) {
                                bullet.damage = bulletDamage;
                            }
                            bullet.damage = bullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                            character.bullets.push(bullet);
                        });
                    } else {
                        const bullet = new Bullet(
                            character.x + Math.cos(character.angle) * character.radius,
                            character.y + Math.sin(character.angle) * character.radius,
                            bulletAngle,
                            character,
                            false
                        );
                        // ÎèÑÎ∞ï Ï¶ùÍ∞ï: Îç∞ÎØ∏ÏßÄ ÎûúÎç§ Ï†ÅÏö©
                        if (character.hasGamble) {
                            bullet.damage = bulletDamage;
                        }
                        character.bullets.push(bullet);
                    }
                    character.ammo--;
                    character.lastShot = now;

                // ÎçîÎ∏îÏÉ∑ (ÌôïÎ•† Ï§ëÏ≤©: 25% * count)
                const doubleShotCount = character.doubleShotCount || 1;
                if (character.hasDoubleShot && Math.random() < (0.25 * doubleShotCount)) {
                    // ¬±15ÎèÑ ÏÇ¨Ïù¥Ïùò ÎûúÎç§ Í∞ÅÎèÑ
                    const randomAngle = (Math.random() - 0.5) * (Math.PI * 30 / 180); // -15ÎèÑ ~ +15ÎèÑ
                    const doubleBulletAngle = character.angle + randomAngle;
                    
                    // ÎçîÎ∏îÏÉ∑ÏóêÎèÑ ÎπÑÏÇ∞ÌÉÑ Ï†ÅÏö©
                    if (character.hasScatter) {
                        const scatterAngles = [-4, -2, 0, 2];
                        scatterAngles.forEach(angleDeg => {
                            const angle = doubleBulletAngle + (angleDeg * Math.PI / 180);
                            const doubleBullet = new Bullet(
                                character.x + Math.cos(character.angle) * character.radius,
                                character.y + Math.sin(character.angle) * character.radius,
                                angle,
                                character,
                                true // ÌÉÑÏïΩ ÏÜåÎ™® ÏóÜÏùå
                            );
                            doubleBullet.damage = doubleBullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                            character.bullets.push(doubleBullet);
                        });
                    } else {
                        const doubleBullet = new Bullet(
                            character.x + Math.cos(character.angle) * character.radius,
                            character.y + Math.sin(character.angle) * character.radius,
                            doubleBulletAngle,
                            character,
                            true // ÌÉÑÏïΩ ÏÜåÎ™® ÏóÜÏùå
                        );
                        character.bullets.push(doubleBullet);
                    }
                    }
                }

                // ÌôîÎ©¥ ÌùîÎì§Î¶º Ìö®Í≥º (ÌîåÎ†àÏù¥Ïñ¥ Î∞úÏÇ¨ ÏãúÏóêÎßå)
                if (character === player) {
                    addScreenShake(18, 200);
                }

                // ÏûêÎèô Ïû¨Ïû•Ï†Ñ
                if (character.ammo === 0 && !character.isReloading) {
                    reload(character);
                }
            }
        }

        // Ïû¨Ïû•Ï†Ñ Ìï®Ïàò
        function reload(character) {
            if (character.ammo < character.maxAmmo && !character.isReloading) {
                character.isReloading = true;
                character.reloadStartTime = Date.now();
                
                setTimeout(() => {
                    character.ammo = character.maxAmmo;
                    character.isReloading = false;
                    character.reloadStartTime = 0;
                    
                    // Ïû¨Ïû•Ï†Ñ ÌöåÎ≥µ Ï¶ùÍ∞ï (ÌöåÎ≥µÎüâ Ï§ëÏ≤©)
                    if (character.hasReloadHeal) {
                        const reloadHealCount = character.reloadHealCount || 1;
                        character.health = Math.min(character.health + (1 * reloadHealCount), character.maxHealth);
                    }
                }, character.reloadTime);
            }
        }

        // Ï∂©Îèå Í∞êÏßÄ
        function checkCollision(bullet, target) {
            const dx = bullet.x - target.x;
            const dy = bullet.y - target.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < bullet.radius + target.radius;
        }

        // Íµ¨Î•¥Í∏∞ Ìï®Ïàò
        function dodge(character) {
            const now = Date.now();
            // Í∏∞Ï†à ÏÉÅÌÉúÎ©¥ Íµ¨Î•¥Í∏∞ Î∂àÍ∞Ä
            if (character.isStunned) return;
            // Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨ (3Ï¥à)
            if (character.isDodging || now - character.lastDodgeTime < 3000) return;
            
            character.isDodging = true;
            const dodgeDistance = character.radius * 6.4; // ÌîåÎ†àÏù¥Ïñ¥ ÌÅ¨Í∏∞Ïùò 3.2Î∞∞ (20% Í∞êÏÜå: 8 -> 6.4)
            const dodgeDuration = 300; // 0.3Ï¥à
            character.dodgeStartTime = now; // Íµ¨Î•¥Í∏∞ ÏãúÏûë ÏãúÍ∞Ñ
            character.dodgeEndTime = now + dodgeDuration;
            character.lastDodgeTime = now; // Ïø®ÌÉÄÏûÑ ÏãúÏûë
            character.dodgeTrail = []; // ÏûîÏÉÅ Ï¥àÍ∏∞Ìôî
            
            // Íµ¨Î•¥Í∏∞ ÏãúÏûë ÏúÑÏπò Ï†ÄÏû•
            character.dodgeStartX = character.x;
            character.dodgeStartY = character.y;
            character.dodgeTrail.push({ x: character.x, y: character.y, alpha: 0.5 });
            
            // Íµ¨Î•¥Í∏∞ Î™©Ìëú ÏúÑÏπò Í≥ÑÏÇ∞
            const targetX = character.x + Math.cos(character.angle) * dodgeDistance;
            const targetY = character.y + Math.sin(character.angle) * dodgeDistance;
            
            // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
            character.dodgeTargetX = Math.max(character.radius, Math.min(canvas.width - character.radius, targetX));
            character.dodgeTargetY = Math.max(character.radius, Math.min(canvas.height - character.radius, targetY));
        }

        // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô
        function updatePlayer() {
            const now = Date.now();
            
            // ÏãúÍ∞ÑÏ†ïÏßÄ ÏÉÅÌÉú Ï≤¥ÌÅ¨ (ÏÉÅÎåÄÍ∞Ä ÏãúÍ∞ÑÏ†ïÏßÄ Ï§ëÏù¥Î©¥ ÏòÅÌñ• ÏóÜÏùå)
            // ÏãúÍ∞ÑÏ†ïÏßÄÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ ÏïÑÎ¨¥Í≤ÉÎèÑ Ìï† Ïàò ÏóÜÏùå
            
            // Íµ¨Î•¥Í∏∞ ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (player.isDodging) {
                if (now >= player.dodgeEndTime) {
                    // Íµ¨Î•¥Í∏∞ ÏôÑÎ£å
                    player.x = player.dodgeTargetX;
                    player.y = player.dodgeTargetY;
                    player.isDodging = false;
                    player.dodgeTrail = [];
                } else {
                    // Íµ¨Î•¥Îäî ÎèôÏïà Îπ†Î•∏ ÏÜçÎèÑÎ°ú Ïù¥Îèô
                    const elapsed = now - player.dodgeStartTime; // ÏãúÏûë ÏãúÍ∞ÑÏúºÎ°úÎ∂ÄÌÑ∞Ïùò Í≤ΩÍ≥º ÏãúÍ∞Ñ
                    const progress = Math.min(elapsed / 300, 1); // 0~1 (300ms = 0.3Ï¥à)
                    
                    // ÏãúÏûë ÏúÑÏπòÏóêÏÑú Î™©Ìëú ÏúÑÏπòÎ°ú ÏÑ†Ìòï Î≥¥Í∞Ñ
                    player.x = player.dodgeStartX + (player.dodgeTargetX - player.dodgeStartX) * progress;
                    player.y = player.dodgeStartY + (player.dodgeTargetY - player.dodgeStartY) * progress;
                    
                    // ÏûîÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏ (Îß§ ÌîÑÎ†àÏûÑÎßàÎã§)
                    if (!player.dodgeTrail) player.dodgeTrail = [];
                    player.dodgeTrail.push({ x: player.x, y: player.y, alpha: 0.3 });
                    // ÏûîÏÉÅÏù¥ ÎÑàÎ¨¥ ÎßéÏïÑÏßÄÎ©¥ Ï†úÍ±∞
                    if (player.dodgeTrail.length > 5) {
                        player.dodgeTrail.shift();
                    }
                }
                return; // Íµ¨Î•¥Îäî Ï§ëÏóêÎäî ÏùºÎ∞ò Ïù¥Îèô Î∂àÍ∞Ä
            }

            // Î∂ÄÌôú Ï≤òÎ¶¨
            if (player.isReviving) {
                if (now >= player.reviveTime) {
                    player.isReviving = false;
                    player.health = 1;
                    // displayHealthÎäî Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏Îê®
                    player.isInvincible = true;
                    player.invincibleEndTime = now + 1000; // 1Ï¥à Î¨¥Ï†Å
                    // Î∂ÄÌôú ÌöüÏàò ÌôïÏù∏ - ÏïÑÏßÅ Îçî Î∂ÄÌôúÌï† Ïàò ÏûàÏúºÎ©¥ Í≥ÑÏÜç ÏßÑÌñâ
                    const reviveCount = player.reviveCount || 1;
                    const hasRevivedCount = (typeof player.hasRevived === 'number' ? player.hasRevived : (player.hasRevived ? 1 : 0));
                    if (hasRevivedCount >= reviveCount) {
                        // Îçî Ïù¥ÏÉÅ Î∂ÄÌôú Î∂àÍ∞Ä
                    }
                }
                return; // Î∂ÄÌôú Ï§ëÏóêÎäî Ïù¥Îèô Î∂àÍ∞Ä
            }

            // Î¨¥Ï†Å ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (player.isInvincible && now >= player.invincibleEndTime) {
                player.isInvincible = false;
            }

            // ÏïΩÌôî ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (player.isWeakened && now >= player.weakenEndTime) {
                player.isWeakened = false;
                // ÏïΩÌôîÎäî Ï¥ùÏïå ÏÉùÏÑ± ÏãúÏóêÎßå Îç∞ÎØ∏ÏßÄÎ•º Í∞êÏÜåÏãúÌÇ§ÎØÄÎ°ú, damage ÏûêÏ≤¥Îäî Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå
            }

            // Í∏∞Ï†à ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (player.isStunned && now >= player.stunEndTime) {
                player.isStunned = false;
            }

            // Î∞©Ïñ¥Îßâ Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨
            if (player.hasShield && !player.shieldReady && now >= player.shieldCooldown) {
                player.shieldReady = true;
            }
            
            // Î∞òÏÇ¨ Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨
            if (player.hasReflect && !player.reflectActive && now >= player.reflectCooldown) {
                player.reflectCooldown = 0; // Ïø®ÌÉÄÏûÑ ÏôÑÎ£å
            }
            
            // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
            if (player.reflectActive && now >= player.reflectEndTime) {
                player.reflectActive = false;
                player.reflectCooldown = now + 5000; // 5Ï¥à Ïø®ÌÉÄÏûÑ
            }
            
            // ÏãúÍ∞ÑÏ†ïÏßÄ Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨
            if (player.hasTimeStop && now >= player.timeStopCooldown) {
                player.timeStopCooldown = 0; // Ïø®ÌÉÄÏûÑ ÏôÑÎ£å
            }
            
            // ÏãúÍ∞ÑÏ†ïÏßÄ Ï¢ÖÎ£å Ï≤¥ÌÅ¨
            if (player.timeStopActive && now >= player.timeStopEndTime) {
                player.timeStopActive = false;
                player.timeStopCooldown = now + 10000; // 10Ï¥à Ïø®ÌÉÄÏûÑ
            }

            // Ïû¨ÏÉù: 1Ï¥àÎßàÎã§ Ï≤¥Î†• 0.1 ÌöåÎ≥µ (ÌöåÎ≥µÎüâ Ï§ëÏ≤©)
            if (player.hasRegeneration) {
                if (now - player.lastRegenTime >= 1000) {
                    const regenerationCount = player.regenerationCount || 1;
                    player.health = Math.min(player.health + (0.1 * regenerationCount), player.maxHealth);
                    player.lastRegenTime = now;
                }
            }

            // Í∏∞Ï†à Ï§ëÏóêÎäî Ïù¥Îèô Î∂àÍ∞Ä
            if (player.isStunned) {
                return;
            }
            
            // ÏÑ†Í≥†: Î∞ÄÎ†§ÎÇòÎäî Ìö®Í≥º Ï≤òÎ¶¨
            if (player.isJudgmentPushing) {
                const elapsed = now - player.judgmentPushStartTime;
                const progress = Math.min(1, elapsed / player.judgmentPushDuration);
                
                // Î∂ÄÎìúÎü¨Ïö¥ Ïù¥Îèô (ease-out)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                player.x = player.judgmentPushStartX + (player.judgmentPushTargetX - player.judgmentPushStartX) * easeProgress;
                player.y = player.judgmentPushStartY + (player.judgmentPushTargetY - player.judgmentPushStartY) * easeProgress;
                
                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                player.x = Math.max(gameState.mapBounds.minX + player.radius, Math.min(gameState.mapBounds.maxX - player.radius, player.x));
                player.y = Math.max(gameState.mapBounds.minY + player.radius, Math.min(gameState.mapBounds.maxY - player.radius, player.y));
                
                if (progress >= 1) {
                    player.isJudgmentPushing = false;
                } else {
                    return; // Î∞ÄÎ†§ÎÇòÎäî Ï§ëÏóêÎäî Îã§Î•∏ Ïù¥Îèô Î∂àÍ∞Ä
                }
            }

            // Ïù¥ÎèôÏÜçÎèÑ Í∞êÏÜå Ï≤òÎ¶¨ (ÍπäÏùÄ ÏÉÅÏ≤ò)
            let currentSpeed = player.speed;
            if (now < player.slowEndTime) {
                    currentSpeed *= 0.75; // -25%
                }
            
            // ÌöåÌîºÍ∏∞Îèô: Ïû¨Ïû•Ï†Ñ Ï§ë Ïù¥ÎèôÏÜçÎèÑ +75% (Ï§ëÏ≤©)
            if (player.hasEvasiveManeuver && player.isReloading) {
                const evasiveManeuverCount = player.evasiveManeuverCount || 1;
                currentSpeed *= (1 + 0.75 * evasiveManeuverCount);
            }
            
            // ÏÉùÏ°¥Î≥∏Îä•: Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ïù¥ÎèôÏÜçÎèÑ +50% (Ï§ëÏ≤©)
            if (player.hasSurvivalInstinct && player.health === 1) {
                const survivalInstinctCount = player.survivalInstinctCount || 1;
                currentSpeed *= (1 + 0.5 * survivalInstinctCount);
            }
            
            // ÌöåÎ≥µÍ≥ÑÏïΩ: Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ï≤¥Î†• 2ÌöåÎ≥µ (ÌöåÎ≥µÎüâ Ï§ëÏ≤©)
            if (player.hasRecoveryContract && !player.hasRecoveryContractUsed && player.health === 1) {
                const recoveryContractCount = player.recoveryContractCount || 1;
                player.health = Math.min(player.health + (2 * recoveryContractCount), player.maxHealth);
                player.hasRecoveryContractUsed = true;
            }

            let dx = 0;
            let dy = 0;

            // Î¨¥ÎπôÏõåÌÅ¨Î™®Îìú: 5Ï¥àÎßàÎã§ Î∞îÎÄåÎäî Î∞©Ìñ•ÏúºÎ°ú Ï¥àÎãπ 25px Ïù¥Îèô + WASD ÏûÖÎ†•ÎèÑ Í∞ÄÎä•
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'movingWork') {
                // ÏúÑ, ÏïÑÎûò, Ï¢å, Ïö∞ 4Î∞©Ìñ• Ï§ë 1Í∞ú ÏÑ†ÌÉù
                if (!gameState.movingWorkDirection) {
                    const directions = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2]; // Ïö∞, ÏïÑÎûò, Ï¢å, ÏúÑ
                    gameState.movingWorkDirection = directions[Math.floor(Math.random() * 4)];
                    gameState.movingWorkLastChange = now;
                }
                
                // 5Ï¥àÎßàÎã§ Î∞©Ìñ• Î≥ÄÍ≤Ω
                if (now - gameState.movingWorkLastChange >= 5000) {
                    const directions = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2]; // Ïö∞, ÏïÑÎûò, Ï¢å, ÏúÑ
                    gameState.movingWorkDirection = directions[Math.floor(Math.random() * 4)];
                    gameState.movingWorkLastChange = now;
                }
                
                // Ï¥àÎãπ 25px Ïù¥Îèô (Î∂ÄÎìúÎüΩÍ≤å)
                const moveSpeed = 25 / 60; // 60fps Í∏∞Ï§Ä
                let autoDx = Math.cos(gameState.movingWorkDirection) * moveSpeed;
                let autoDy = Math.sin(gameState.movingWorkDirection) * moveSpeed;
                
                // WASD ÏûÖÎ†•ÎèÑ Î∞õÍ∏∞
                if (keys['w']) dy -= 1;
                if (keys['s']) dy += 1;
                if (keys['a']) dx -= 1;
                if (keys['d']) dx += 1;
                
                // ÎåÄÍ∞ÅÏÑ† Ïù¥Îèô Ï†ïÍ∑úÌôî
                if (dx !== 0 && dy !== 0) {
                    dx *= 0.707;
                    dy *= 0.707;
                }
                
                // ÏûêÎèô Ïù¥ÎèôÍ≥º WASD ÏûÖÎ†• Ìï©ÏÇ∞
                dx += autoDx;
                dy += autoDy;
            } else {
                // ÏùºÎ∞ò Ïù¥Îèô
                if (keys['w']) dy -= 1;
                if (keys['s']) dy += 1;
                if (keys['a']) dx -= 1;
                if (keys['d']) dx += 1;
                
                // ÎåÄÍ∞ÅÏÑ† Ïù¥Îèô Ï†ïÍ∑úÌôî
                if (dx !== 0 && dy !== 0) {
                    dx *= 0.707;
                    dy *= 0.707;
                }
            }

            // Í±∞Ï†êÌôïÎ≥¥: ÏúÑÏπò Î≥ÄÌôî Ï≤¥ÌÅ¨
            if (player.hasFortify) {
                const moved = Math.abs(player.x - (player.lastPosition?.x || player.x)) > 0.1 || 
                             Math.abs(player.y - (player.lastPosition?.y || player.y)) > 0.1;
                
                if (moved) {
                    // ÏõÄÏßÅÏûÑ: Í±∞Ï†ê ÌôïÎ≥¥ Ìï¥Ï†ú
                    player.isFortified = false;
                    player.stationaryTime = 0;
                    if (!player.lastPosition) player.lastPosition = { x: player.x, y: player.y };
                    player.lastPosition.x = player.x;
                    player.lastPosition.y = player.y;
                } else {
                    // Ï†ïÏßÄ: ÏãúÍ∞Ñ ÎàÑÏ†Å
                    if (!player.lastPosition) player.lastPosition = { x: player.x, y: player.y };
                    player.stationaryTime += 16; // ÏïΩ 60fps Í∏∞Ï§Ä
                    
                    // 3Ï¥à(3000ms) ÎèôÏïà Ï†ïÏßÄÌïòÎ©¥ Í±∞Ï†ê ÌôïÎ≥¥
                    if (player.stationaryTime >= 3000 && !player.isFortified) {
                        player.isFortified = true;
                        player.fortifyStartTime = now;
                    }
                }
            }

            // ÎπôÌåêÎ™®Îìú: ÎØ∏ÎÅÑÎü¨Ïßê Ìö®Í≥º
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'ice') {
                // ÏÜçÎèÑ Î≤°ÌÑ∞ Ï¥àÍ∏∞Ìôî
                if (!player.velocityX) player.velocityX = 0;
                if (!player.velocityY) player.velocityY = 0;
                
                // ÏûÖÎ†•Ïù¥ ÏûàÏúºÎ©¥ ÏÜçÎèÑ Î≤°ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (dx !== 0 || dy !== 0) {
                    player.velocityX = dx * currentSpeed;
                    player.velocityY = dy * currentSpeed;
                }
                
                // ÎßàÏ∞∞ Ï†ÅÏö© (ÏÜçÎèÑ Í∞êÏÜå) - ÎπôÌåêÎ™®ÎìúÏóêÏÑúÎäî Ìõ®Ïî¨ Îçî Ïûò ÎØ∏ÎÅÑÎü¨Ïßê
                player.velocityX *= 0.995;
                player.velocityY *= 0.995;
                
                // ÏÜçÎèÑÍ∞Ä Îß§Ïö∞ ÏûëÏúºÎ©¥ Ï†ïÏßÄ
                if (Math.abs(player.velocityX) < 0.01) player.velocityX = 0;
                if (Math.abs(player.velocityY) < 0.01) player.velocityY = 0;
                
                // ÏÜçÎèÑ Î≤°ÌÑ∞Î°ú Ïù¥Îèô
                let newX = player.x + player.velocityX;
                let newY = player.y + player.velocityY;
                
                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ (Îßµ Í≤ΩÍ≥Ñ ÏÇ¨Ïö©) - Í≤ΩÍ≥ÑÎ•º ÎÑòÏñ¥Í∞ÄÎ©¥ Í∞ïÏ†úÎ°ú Í≤ΩÍ≥Ñ ÏïàÏúºÎ°ú Ï†úÌïú
                newX = Math.max(gameState.mapBounds.minX + player.radius, Math.min(gameState.mapBounds.maxX - player.radius, newX));
                newY = Math.max(gameState.mapBounds.minY + player.radius, Math.min(gameState.mapBounds.maxY - player.radius, newY));
                
                // Í≤ΩÍ≥ÑÏóê ÎãøÏúºÎ©¥ ÏÜçÎèÑ Î∞òÏÇ¨
                if (newX !== player.x + player.velocityX) player.velocityX *= -0.5;
                if (newY !== player.y + player.velocityY) player.velocityY *= -0.5;
                
                player.x = newX;
                player.y = newY;
            } else {
                // ÏùºÎ∞ò Ïù¥Îèô
                let newX = player.x + dx * currentSpeed;
                let newY = player.y + dy * currentSpeed;

                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ (Îßµ Í≤ΩÍ≥Ñ ÏÇ¨Ïö©) - Í≤ΩÍ≥ÑÎ•º ÎÑòÏñ¥Í∞ÄÎ©¥ Í∞ïÏ†úÎ°ú Í≤ΩÍ≥Ñ ÏïàÏúºÎ°ú Ï†úÌïú
                newX = Math.max(gameState.mapBounds.minX + player.radius, Math.min(gameState.mapBounds.maxX - player.radius, newX));
                newY = Math.max(gameState.mapBounds.minY + player.radius, Math.min(gameState.mapBounds.maxY - player.radius, newY));
                
                player.x = newX;
                player.y = newY;
            }

            // Í∞ÅÎèÑ Í≥ÑÏÇ∞ (ÎßàÏö∞Ïä§ Î∞©Ìñ•)
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
        }


        // AI Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
        function updateEnemy() {
            const now = Date.now();
            
            // Î∂ÄÌôú Ï≤òÎ¶¨
            if (enemy.isReviving) {
                if (now >= enemy.reviveTime) {
                    enemy.isReviving = false;
                    enemy.health = 1;
                    // displayHealthÎäî Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏Îê®
                    enemy.isInvincible = true;
                    enemy.invincibleEndTime = now + 1000; // 1Ï¥à Î¨¥Ï†Å
                    // Î∂ÄÌôú ÌöüÏàò ÌôïÏù∏ - ÏïÑÏßÅ Îçî Î∂ÄÌôúÌï† Ïàò ÏûàÏúºÎ©¥ Í≥ÑÏÜç ÏßÑÌñâ
                    const reviveCount = enemy.reviveCount || 1;
                    const hasRevivedCount = (typeof enemy.hasRevived === 'number' ? enemy.hasRevived : (enemy.hasRevived ? 1 : 0));
                    if (hasRevivedCount >= reviveCount) {
                        // Îçî Ïù¥ÏÉÅ Î∂ÄÌôú Î∂àÍ∞Ä
                    }
                }
                return; // Î∂ÄÌôú Ï§ëÏóêÎäî Ïù¥Îèô Î∂àÍ∞Ä
            }

            // Î¨¥Ï†Å ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (enemy.isInvincible && now >= enemy.invincibleEndTime) {
                enemy.isInvincible = false;
            }

            // ÏïΩÌôî ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (enemy.isWeakened && now >= enemy.weakenEndTime) {
                enemy.isWeakened = false;
                // ÏïΩÌôîÎäî Ï¥ùÏïå ÏÉùÏÑ± ÏãúÏóêÎßå Îç∞ÎØ∏ÏßÄÎ•º Í∞êÏÜåÏãúÌÇ§ÎØÄÎ°ú, damage ÏûêÏ≤¥Îäî Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå
            }

            // Í∏∞Ï†à ÏÉÅÌÉú Ï≤¥ÌÅ¨
            if (enemy.isStunned && now >= enemy.stunEndTime) {
                enemy.isStunned = false;
            }

            // Î∞©Ïñ¥Îßâ Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨
            if (enemy.hasShield && !enemy.shieldReady && now >= enemy.shieldCooldown) {
                enemy.shieldReady = true;
            }

            // Ïû¨ÏÉù: 1Ï¥àÎßàÎã§ Ï≤¥Î†• 0.1 ÌöåÎ≥µ (ÌöåÎ≥µÎüâ Ï§ëÏ≤©)
            if (enemy.hasRegeneration) {
                if (now - enemy.lastRegenTime >= 1000) {
                    const regenerationCount = enemy.regenerationCount || 1;
                    enemy.health = Math.min(enemy.health + (0.1 * regenerationCount), enemy.maxHealth);
                    enemy.health = roundToMaxTwoDecimals(enemy.health);
                    enemy.lastRegenTime = now;
                }
            }

            // Í∏∞Ï†à Ï§ëÏóêÎäî Ïù¥Îèô Î∂àÍ∞Ä
            if (enemy.isStunned) {
                return;
            }
            
            // ÏãúÍ∞ÑÏ†ïÏßÄ: ÏÉÅÎåÄÍ∞Ä ÏãúÍ∞ÑÏ†ïÏßÄÎ•º ÏÇ¨Ïö© Ï§ëÏù¥Î©¥ ÏõÄÏßÅÏù¥ÏßÄ Î™ªÌï®
            if (player.timeStopActive) {
                return;
            }
            
            // ÏÑ†Í≥†: Î∞ÄÎ†§ÎÇòÎäî Ìö®Í≥º Ï≤òÎ¶¨
            if (enemy.isJudgmentPushing) {
                const elapsed = now - enemy.judgmentPushStartTime;
                const progress = Math.min(1, elapsed / enemy.judgmentPushDuration);
                
                // Î∂ÄÎìúÎü¨Ïö¥ Ïù¥Îèô (ease-out)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                enemy.x = enemy.judgmentPushStartX + (enemy.judgmentPushTargetX - enemy.judgmentPushStartX) * easeProgress;
                enemy.y = enemy.judgmentPushStartY + (enemy.judgmentPushTargetY - enemy.judgmentPushStartY) * easeProgress;
                
                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                enemy.x = Math.max(gameState.mapBounds.minX + enemy.radius, Math.min(gameState.mapBounds.maxX - enemy.radius, enemy.x));
                enemy.y = Math.max(gameState.mapBounds.minY + enemy.radius, Math.min(gameState.mapBounds.maxY - enemy.radius, enemy.y));
                
                if (progress >= 1) {
                    enemy.isJudgmentPushing = false;
                } else {
                    return; // Î∞ÄÎ†§ÎÇòÎäî Ï§ëÏóêÎäî Îã§Î•∏ Ïù¥Îèô Î∂àÍ∞Ä
                }
            }

            // Ïù¥ÎèôÏÜçÎèÑ Í∞êÏÜå Ï≤òÎ¶¨ (ÍπäÏùÄ ÏÉÅÏ≤ò)
            let currentSpeed = enemy.speed;
            if (now < enemy.slowEndTime) {
                    currentSpeed *= 0.75; // -25%
                }
            
            // ÌöåÌîºÍ∏∞Îèô: Ïû¨Ïû•Ï†Ñ Ï§ë Ïù¥ÎèôÏÜçÎèÑ +75% (Ï§ëÏ≤©)
            if (enemy.hasEvasiveManeuver && enemy.isReloading) {
                const evasiveManeuverCount = enemy.evasiveManeuverCount || 1;
                currentSpeed *= (1 + 0.75 * evasiveManeuverCount);
            }
            
            // ÏÉùÏ°¥Î≥∏Îä•: Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ïù¥ÎèôÏÜçÎèÑ +50% (Ï§ëÏ≤©)
            if (enemy.hasSurvivalInstinct && enemy.health === 1) {
                const survivalInstinctCount = enemy.survivalInstinctCount || 1;
                currentSpeed *= (1 + 0.5 * survivalInstinctCount);
            }
            
            // ÌöåÎ≥µÍ≥ÑÏïΩ: Ï≤¥Î†•Ïù¥ 1Ïùº Îïå Ï≤¥Î†• 2ÌöåÎ≥µ (ÌöåÎ≥µÎüâ Ï§ëÏ≤©)
            if (enemy.hasRecoveryContract && !enemy.hasRecoveryContractUsed && enemy.health === 1) {
                const recoveryContractCount = enemy.recoveryContractCount || 1;
                enemy.health = Math.min(enemy.health + (2 * recoveryContractCount), enemy.maxHealth);
                enemy.hasRecoveryContractUsed = true;
            }

            enemy.aiTimer++;

            // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï¥ùÏùÑ ÏèòÎäîÏßÄ Í∞êÏßÄ
            const currentPlayerBulletCount = player.bullets.length;
            if (currentPlayerBulletCount > enemy.lastPlayerBulletCount) {
                // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï¥ùÏùÑ ÏêàÏùå
                const dodgeProbability = 0.8; // 80% ÌôïÎ•†
                if (Math.random() < dodgeProbability) {
                    // 80% ÌôïÎ•†Î°ú ÌöåÌîº
                    enemy.isDodgingBullet = true;
                    // Ï¥ùÏïå Î∞©Ìñ•ÏóêÏÑú +90ÎèÑ ÎòêÎäî -90ÎèÑÎ°ú Ïù¥Îèô
                    const bulletAngle = player.angle; // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ïèú Ï¥ùÏïåÏùò Î∞©Ìñ•
                    const dodgeDirection = Math.random() < 0.5 ? 1 : -1; // 1 = +90ÎèÑ, -1 = -90ÎèÑ
                    const dodgeAngle = bulletAngle + (dodgeDirection * Math.PI / 2); // ¬±90ÎèÑ
                    const dodgeDistance = 50;
                    
                    // ¬±90ÎèÑ Î∞©Ìñ•ÏúºÎ°ú 50px Ïù¥ÎèôÌïú Î™©Ìëú ÏúÑÏπò Í≥ÑÏÇ∞
                    const targetX = enemy.x + Math.cos(dodgeAngle) * dodgeDistance;
                    const targetY = enemy.y + Math.sin(dodgeAngle) * dodgeDistance;
                    
                    // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
                    enemy.bulletDodgeTargetX = Math.max(
                        enemy.radius,
                        Math.min(canvas.width - enemy.radius, targetX)
                    );
                    enemy.bulletDodgeTargetY = Math.max(
                        enemy.radius,
                        Math.min(canvas.height - enemy.radius, targetY)
                    );
                    // ÌòÑÏû¨ ÏõÄÏßÅÏûÑ Î©àÏ∂îÍ∏∞
                    enemy.aiTimer = 0;
                }
            }
            enemy.lastPlayerBulletCount = currentPlayerBulletCount;

            // Ï¥ùÏïå ÌöåÌîº Ï§ëÏù¥Î©¥ Î™©Ìëú ÏúÑÏπòÎ°ú Ïù¥Îèô
            if (enemy.isDodgingBullet) {
                const dxToTarget = enemy.bulletDodgeTargetX - enemy.x;
                const dyToTarget = enemy.bulletDodgeTargetY - enemy.y;
                const distanceToTarget = Math.sqrt(dxToTarget * dxToTarget + dyToTarget * dyToTarget);
                
                if (distanceToTarget > 2) {
                    // Î™©Ìëú ÏúÑÏπòÎ°ú Ïù¥Îèô
                    enemy.aiDirection = Math.atan2(dyToTarget, dxToTarget);
                } else {
                    // Î™©Ìëú ÏúÑÏπòÏóê ÎèÑÎã¨ÌñàÏúºÎ©¥ ÌöåÌîº Ï¢ÖÎ£å
                    enemy.isDodgingBullet = false;
                    enemy.aiTimer = 0; // ÏÉàÎ°úÏö¥ Î∞©Ìñ• ÏÑ†ÌÉù
                }
            }

            // ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Îèô Î∞©Ìñ• Ï∂îÏ†Å (ÏòàÏ∏° Î∞úÏÇ¨Ïö©)
            if (enemy.lastPlayerX === 0 && enemy.lastPlayerY === 0) {
                enemy.lastPlayerX = player.x;
                enemy.lastPlayerY = player.y;
            }
            // ÌîåÎ†àÏù¥Ïñ¥ ÏÜçÎèÑ Í≥ÑÏÇ∞ (ÌîÑÎ†àÏûÑÎãπ Ïù¥ÎèôÎüâ)
            enemy.playerVelocity.x = player.x - enemy.lastPlayerX;
            enemy.playerVelocity.y = player.y - enemy.lastPlayerY;
            enemy.lastPlayerX = player.x;
            enemy.lastPlayerY = player.y;

            // ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ•ÏúºÎ°ú Í∞ÅÎèÑ ÏÑ§Ï†ï
            const dxToPlayer = player.x - enemy.x;
            const dyToPlayer = player.y - enemy.y;
            enemy.angle = Math.atan2(dyToPlayer, dxToPlayer);

            // ÌîåÎ†àÏù¥Ïñ¥ÏôÄÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞
            const distance = Math.sqrt(dxToPlayer * dxToPlayer + dyToPlayer * dyToPlayer);
            const safeDistance = 500; // ÏïàÏ†Ñ Í±∞Î¶¨ (500px)

            const aiTimerThreshold = 30; // ÏõêÎûòÎåÄÎ°ú Î≥µÍµ¨ (30ÌîÑÎ†àÏûÑ = ÏïΩ 0.5Ï¥à)
            
            // Ï†Å Ïù¥Îèô Ìå®ÌÑ¥ Í∞úÏÑ† - ÏúÑÏïÑÎûòÎ°ú Îçî ÏûêÏ£º ÏõÄÏßÅÏûÑ (ÌöåÌîº Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå)
            if (!enemy.isDodgingBullet && enemy.aiTimer > aiTimerThreshold) {
                let targetAngle;
                
                // ÎûúÎç§ÌïòÍ≤å Îã§ÏñëÌïú ÏõÄÏßÅÏûÑ Ìå®ÌÑ¥ ÏÇ¨Ïö©
                const movementPattern = Math.random();
                
                if (movementPattern < 0.2) {
                    // 20% ÌôïÎ•†: ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ•ÏúºÎ°ú Ïù¥Îèô
                    targetAngle = Math.atan2(dyToPlayer, dxToPlayer);
                } else if (movementPattern < 0.35) {
                    // 15% ÌôïÎ•†: ÌîåÎ†àÏù¥Ïñ¥ Î∞òÎåÄ Î∞©Ìñ•ÏúºÎ°ú Ïù¥Îèô
                    targetAngle = Math.atan2(-dyToPlayer, -dxToPlayer);
                } else if (movementPattern < 0.45) {
                    // 10% ÌôïÎ•†: Ï∏°Î©¥ Ïù¥Îèô (ÏôºÏ™Ω/Ïò§Î•∏Ï™Ω)
                    targetAngle = Math.atan2(dyToPlayer, dxToPlayer) + (Math.random() < 0.5 ? Math.PI / 2 : -Math.PI / 2);
                } else if (movementPattern < 0.75) {
                    // 30% ÌôïÎ•†: ÏúÑÏïÑÎûò Ïù¥Îèô (ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ• Í∏∞Ï§Ä ÏúÑ/ÏïÑÎûò)
                    const playerAngle = Math.atan2(dyToPlayer, dxToPlayer);
                    targetAngle = playerAngle + (Math.random() < 0.5 ? Math.PI / 2 : -Math.PI / 2);
                } else {
                    // 25% ÌôïÎ•†: ÏôÑÏ†Ñ ÎûúÎç§ Î∞©Ìñ•
                    targetAngle = Math.random() * Math.PI * 2;
                }
                
                // Í±∞Î¶¨ Í∏∞Î∞ò Ï°∞Ï†ï (ÏÑ†ÌÉùÏ†Å)
                if (distance < safeDistance * 0.7) {
                    // ÎÑàÎ¨¥ Í∞ÄÍπåÏö∞Î©¥ Î©ÄÏñ¥ÏßÄÎäî Í≤ΩÌñ•
                    if (movementPattern < 0.5) {
                        targetAngle = Math.atan2(-dyToPlayer, -dxToPlayer);
                    }
                }
                
                // ÎûúÎç§ Í∞ÅÎèÑ Ï∂îÍ∞ÄÎ°ú Îçî ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏõÄÏßÅÏûÑ
                const randomAngle = (Math.random() - 0.5) * Math.PI * 0.5; // ¬±45ÎèÑ ÎûúÎç§
                enemy.aiDirection = targetAngle + randomAngle;
                enemy.aiTimer = 0;
            }

            // Í≤ΩÍ≥ÑÏóê ÎãøÏúºÎ©¥ Î∞©Ìñ• Î≥ÄÍ≤Ω (Îßµ Í≤ΩÍ≥Ñ ÏÇ¨Ïö©)
            if (enemy.x < gameState.mapBounds.minX + enemy.radius || enemy.x > gameState.mapBounds.maxX - enemy.radius ||
                enemy.y < gameState.mapBounds.minY + enemy.radius || enemy.y > gameState.mapBounds.maxY - enemy.radius) {
                enemy.aiDirection = Math.random() * Math.PI * 2;
                enemy.aiTimer = 0;
            }

            // Ïù¥Îèô Í≥ÑÏÇ∞
            let dx = Math.cos(enemy.aiDirection) * currentSpeed;
            let dy = Math.sin(enemy.aiDirection) * currentSpeed;
            
            // Î¨¥ÎπôÏõåÌÅ¨Î™®Îìú: 5Ï¥àÎßàÎã§ Î∞îÎÄåÎäî Î∞©Ìñ•ÏúºÎ°ú Ï¥àÎãπ 25px Ïù¥Îèô Ï∂îÍ∞Ä (ÌîåÎ†àÏù¥Ïñ¥ÏôÄ Í∞ôÏùÄ Î∞©Ìñ•)
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'movingWork') {
                // ÏúÑ, ÏïÑÎûò, Ï¢å, Ïö∞ 4Î∞©Ìñ• Ï§ë 1Í∞ú ÏÑ†ÌÉù (ÌîåÎ†àÏù¥Ïñ¥ÏôÄ Í∞ôÏùÄ Î∞©Ìñ• ÏÇ¨Ïö©)
                if (!gameState.movingWorkDirection) {
                    const directions = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2]; // Ïö∞, ÏïÑÎûò, Ï¢å, ÏúÑ
                    gameState.movingWorkDirection = directions[Math.floor(Math.random() * 4)];
                    gameState.movingWorkLastChange = now;
                }
                
                // 5Ï¥àÎßàÎã§ Î∞©Ìñ• Î≥ÄÍ≤Ω
                if (now - gameState.movingWorkLastChange >= 5000) {
                    const directions = [0, Math.PI / 2, Math.PI, 3 * Math.PI / 2]; // Ïö∞, ÏïÑÎûò, Ï¢å, ÏúÑ
                    gameState.movingWorkDirection = directions[Math.floor(Math.random() * 4)];
                    gameState.movingWorkLastChange = now;
                }
                
                // Ï¥àÎãπ 25px Ïù¥Îèô (Î∂ÄÎìúÎüΩÍ≤å) - currentSpeedÎ•º Í≥±ÌïòÏßÄ ÏïäÍ≥† ÏßÅÏ†ë Ï∂îÍ∞Ä
                const moveSpeed = 25 / 60; // 60fps Í∏∞Ï§Ä
                const moveDx = Math.cos(gameState.movingWorkDirection) * moveSpeed;
                const moveDy = Math.sin(gameState.movingWorkDirection) * moveSpeed;
                
                // AI Ïù¥ÎèôÍ≥º Î¨¥ÎπôÏõåÌÅ¨ Ïù¥Îèô Ìï©ÏÇ∞
                dx += moveDx;
                dy += moveDy;
            }

            // ÎπôÌåêÎ™®Îìú: ÎØ∏ÎÅÑÎü¨Ïßê Ìö®Í≥º
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'ice') {
                // ÏÜçÎèÑ Î≤°ÌÑ∞ Ï¥àÍ∏∞Ìôî
                if (enemy.velocityX === undefined) enemy.velocityX = 0;
                if (enemy.velocityY === undefined) enemy.velocityY = 0;
                
                // ÏûÖÎ†•Ïù¥ ÏûàÏúºÎ©¥ ÏÜçÎèÑ Î≤°ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ (Ìï≠ÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏)
                enemy.velocityX = dx;
                enemy.velocityY = dy;
                
                // ÎßàÏ∞∞ Ï†ÅÏö© (ÏÜçÎèÑ Í∞êÏÜå) - ÎπôÌåêÎ™®ÎìúÏóêÏÑúÎäî Ìõ®Ïî¨ Îçî Ïûò ÎØ∏ÎÅÑÎü¨Ïßê
                enemy.velocityX *= 0.995;
                enemy.velocityY *= 0.995;
                
                // ÏÜçÎèÑÍ∞Ä Îß§Ïö∞ ÏûëÏúºÎ©¥ Ï†ïÏßÄ
                if (Math.abs(enemy.velocityX) < 0.01) enemy.velocityX = 0;
                if (Math.abs(enemy.velocityY) < 0.01) enemy.velocityY = 0;
                
                // ÏÜçÎèÑ Î≤°ÌÑ∞Î°ú Ïù¥Îèô
                let newX = enemy.x + enemy.velocityX;
                let newY = enemy.y + enemy.velocityY;
                
                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ (Îßµ Í≤ΩÍ≥Ñ ÏÇ¨Ïö©) - Í≤ΩÍ≥ÑÎ•º ÎÑòÏñ¥Í∞ÄÎ©¥ Í∞ïÏ†úÎ°ú Í≤ΩÍ≥Ñ ÏïàÏúºÎ°ú Ï†úÌïú
                newX = Math.max(gameState.mapBounds.minX + enemy.radius, Math.min(gameState.mapBounds.maxX - enemy.radius, newX));
                newY = Math.max(gameState.mapBounds.minY + enemy.radius, Math.min(gameState.mapBounds.maxY - enemy.radius, newY));
                
                // Í≤ΩÍ≥ÑÏóê ÎãøÏúºÎ©¥ ÏÜçÎèÑ Î∞òÏÇ¨
                if (newX !== enemy.x + enemy.velocityX) enemy.velocityX *= -0.5;
                if (newY !== enemy.y + enemy.velocityY) enemy.velocityY *= -0.5;
                
                enemy.x = newX;
                enemy.y = newY;
            } else {
                // ÏùºÎ∞ò Ïù¥Îèô
                enemy.x = Math.max(gameState.mapBounds.minX + enemy.radius, Math.min(gameState.mapBounds.maxX - enemy.radius, enemy.x + dx));
                enemy.y = Math.max(gameState.mapBounds.minY + enemy.radius, Math.min(gameState.mapBounds.maxY - enemy.radius, enemy.y + dy));
                // ÎπôÌåêÎ™®ÎìúÍ∞Ä ÏïÑÎãê ÎïåÎäî ÏÜçÎèÑ Î≤°ÌÑ∞ Ï¥àÍ∏∞Ìôî
                enemy.velocityX = 0;
                enemy.velocityY = 0;
            }
            
            // Í∞ÅÎèÑ Í≥ÑÏÇ∞ (ÌîåÎ†àÏù¥Ïñ¥ Î∞©Ìñ•)
            enemy.angle = Math.atan2(dyToPlayer, dxToPlayer);


            // Í∑ºÏ†ëÏ†ÑÎ™®Îìú: ÌîåÎ†àÏù¥Ïñ¥Í∞Ä 500px ÏïàÏóê Îì§Ïñ¥ÏôîÏùÑ ÎïåÎßå Î∞úÏÇ¨
            const isMeleeMode = gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'melee';
            const maxDistance = isMeleeMode ? 500 : Math.max(canvas.width, canvas.height) * 0.8; // Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÎ©¥ 500px, ÏïÑÎãàÎ©¥ ÌôîÎ©¥ ÌÅ¨Í∏∞Ïùò 80%
            const shootProbability = isMeleeMode ? 0.6 : 0.3; // Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÎ©¥ Îçî Ï†ÅÍ∑πÏ†ÅÏúºÎ°ú Î∞úÏÇ¨ (60%)
            const nowForShoot = Date.now();
            // Ïø®ÌÉÄÏûÑ Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä (Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÎ©¥ Ïø®ÌÉÄÏûÑ Í∞êÏÜå)
            const shootCooldown = isMeleeMode ? enemy.shootCooldown * 0.7 : enemy.shootCooldown; // Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÎ©¥ Ïø®ÌÉÄÏûÑ 30% Í∞êÏÜå
            const canShoot = !enemy.lastShot || (nowForShoot - enemy.lastShot >= shootCooldown);
            if (distance < maxDistance && enemy.ammo > 0 && !enemy.isReloading && canShoot && Math.random() < shootProbability) {
                // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏõÄÏßÅÏù¥Í≥† ÏûàÎäîÏßÄ ÌôïÏù∏
                const playerSpeed = Math.sqrt(enemy.playerVelocity.x * enemy.playerVelocity.x + enemy.playerVelocity.y * enemy.playerVelocity.y);
                const isPlayerMoving = playerSpeed > 0.1; // 0.1px Ïù¥ÏÉÅ ÏõÄÏßÅÏù¥Î©¥ ÏõÄÏßÅÏù¥Îäî Í≤ÉÏúºÎ°ú Í∞ÑÏ£º
                
                const originalAngle = enemy.angle;
                const currentAngle = Math.atan2(dyToPlayer, dxToPlayer);
                
                // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Î©àÏ∂∞ÏûàÏúºÎ©¥ Ìï≠ÏÉÅ Ï†ïÌôïÌûà ÏèòÍ≥†, ÏõÄÏßÅÏù¥Î©¥ 70% Ï†ïÌôïÌûà, 30% ¬±5ÎèÑ ÎûúÎç§
                if (!isPlayerMoving) {
                    // Î©àÏ∂∞ÏûàÏùÑ Îïå: Ìï≠ÏÉÅ Ï†ïÌôïÌûà
                    enemy.angle = currentAngle;
                } else {
                    // ÏõÄÏßÅÏùº Îïå: 70% Ï†ïÌôïÌûà, 30% ¬±5ÎèÑ ÎûúÎç§
                    if (Math.random() < 0.7) {
                        // 70% ÌôïÎ•†: Ï†ïÌôïÌûà ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò
                        enemy.angle = currentAngle;
                    } else {
                        // 30% ÌôïÎ•†: ¬±5ÎèÑ ÎûúÎç§
                        const randomOffset = (Math.random() - 0.5) * 10 * Math.PI / 180; // ¬±5ÎèÑ
                        enemy.angle = currentAngle + randomOffset;
                    }
                }
                
                shoot(enemy);
                enemy.lastShot = nowForShoot; // Î∞úÏÇ¨ ÏãúÍ∞Ñ Í∏∞Î°ù
                // Î∞úÏÇ¨ ÌõÑ Í∞ÅÎèÑ Î≥µÏõê (Ïù¥Îèô Î∞©Ìñ• Ïú†ÏßÄ)
                enemy.angle = originalAngle;
            }

            // ÏûêÎèô Ïû¨Ïû•Ï†Ñ
            if (enemy.ammo === 0 && !enemy.isReloading) {
                reload(enemy);
            }
        }

        // Ï¥ùÏïå ÏóÖÎç∞Ïù¥Ìä∏
        function updateBullets(character) {
            for (let i = character.bullets.length - 1; i >= 0; i--) {
                const bullet = character.bullets[i];
                
                // ÏãúÍ∞ÑÏ†ïÏßÄ: ÏÉÅÎåÄÏùò Ï¥ùÏïåÏùÄ Î©àÏ∂§ (ÏÇ¨Ïö©ÏûêÎäî ÏòÅÌñ• ÏóÜÏùå)
                const target = character === player ? enemy : player;
                if (target.timeStopActive && character !== target) {
                    continue; // Ï¥ùÏïå ÏóÖÎç∞Ïù¥Ìä∏ Ïïà Ìï® (Î©àÏ∂§)
                }
                
                // ÏãúÍ∞ÑÏû•Îßâ: Ï†ÅÏùò Ï¥ùÏïåÏù¥ ÌîåÎ†àÏù¥Ïñ¥Ïùò ÏãúÍ∞ÑÏû•Îßâ ÏïàÏóê ÏûàÏúºÎ©¥ ÏÜçÎèÑ 35% ÎëîÌôî
                if (character === enemy && player.hasTimeBarrier) {
                    const dx = bullet.x - player.x;
                    const dy = bullet.y - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance <= player.timeBarrierRadius) {
                        // ÏÜçÎèÑ 65%Î°ú ÏÑ§Ï†ï (35% Í∞êÏÜå) - ÌôòÍ∞ÅÏù¥ ÏûàÏúºÎ©¥ ÌôòÍ∞Å ÏÜçÎèÑ Í∏∞Ï§ÄÏúºÎ°ú
                        const baseSpeedForBarrier = bullet.hallucinationSpeed !== undefined ? bullet.hallucinationSpeed : (bullet.baseSpeed || bullet.speed);
                        bullet.speed = baseSpeedForBarrier * 0.65;
                        bullet.isInTimeBarrier = true;
                    } else {
                        // ÏãúÍ∞ÑÏû•Îßâ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎ©¥ ÏõêÎûò ÏÜçÎèÑÎ°ú Î≥µÏõê (ÌôòÍ∞ÅÏù¥ ÏûàÏúºÎ©¥ ÌôòÍ∞Å ÏÜçÎèÑ)
                        bullet.isInTimeBarrier = false;
                        if (bullet.hallucinationSpeed !== undefined) {
                            bullet.speed = bullet.hallucinationSpeed;
                        } else {
                            bullet.speed = bullet.baseSpeed || bullet.speed;
                        }
                    }
                }
                // ÏãúÍ∞ÑÏû•Îßâ: ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï¥ùÏïåÏù¥ Ï†ÅÏùò ÏãúÍ∞ÑÏû•Îßâ ÏïàÏóê ÏûàÏúºÎ©¥ ÏÜçÎèÑ 35% ÎëîÌôî
                if (character === player && enemy.hasTimeBarrier) {
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance <= enemy.timeBarrierRadius) {
                        // ÏÜçÎèÑ 65%Î°ú ÏÑ§Ï†ï (35% Í∞êÏÜå) - ÌôòÍ∞ÅÏù¥ ÏûàÏúºÎ©¥ ÌôòÍ∞Å ÏÜçÎèÑ Í∏∞Ï§ÄÏúºÎ°ú
                        const baseSpeedForBarrier = bullet.hallucinationSpeed !== undefined ? bullet.hallucinationSpeed : (bullet.baseSpeed || bullet.speed);
                        bullet.speed = baseSpeedForBarrier * 0.65;
                        bullet.isInTimeBarrier = true;
                    } else {
                        // ÏãúÍ∞ÑÏû•Îßâ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎ©¥ ÏõêÎûò ÏÜçÎèÑÎ°ú Î≥µÏõê (ÌôòÍ∞ÅÏù¥ ÏûàÏúºÎ©¥ ÌôòÍ∞Å ÏÜçÎèÑ)
                        bullet.isInTimeBarrier = false;
                        if (bullet.hallucinationSpeed !== undefined) {
                            bullet.speed = bullet.hallucinationSpeed;
                        } else {
                            bullet.speed = bullet.baseSpeed || bullet.speed;
                        }
                    }
                }
                
                // Í∑ºÏ†ëÏ†ÑÎ™®Îìú: Ï¥ùÏïåÏù¥ 500px Ïù¥ÎèôÌñàÎäîÏßÄ Ï≤¥ÌÅ¨
                if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'melee') {
                    if (!bullet.isStopped) {
                        // ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Í±∞Î¶¨ Í≥ÑÏÇ∞
                        const currentDistance = Math.sqrt(
                            Math.pow(bullet.x - bullet.startX, 2) + 
                            Math.pow(bullet.y - bullet.startY, 2)
                        );
                        
                        if (currentDistance >= 500) {
                            // Ï¥ùÏïåÏù¥ 500pxÎ•º ÎÑòÏóàÏúºÎ©¥ Ï†ïÌôïÌûà 500px ÏúÑÏπòÎ°ú Ï°∞Ï†ï
                            const angle = Math.atan2(bullet.y - bullet.startY, bullet.x - bullet.startX);
                            bullet.x = bullet.startX + Math.cos(angle) * 500;
                            bullet.y = bullet.startY + Math.sin(angle) * 500;
                            
                            // Ï¥ùÏïå Î©àÏ∂îÍ∏∞
                            bullet.isStopped = true;
                            bullet.stopTime = Date.now();
                            bullet.speed = 0; // ÏÜçÎèÑ 0ÏúºÎ°ú ÏÑ§Ï†ï
                        } else {
                            // ÏïÑÏßÅ 500px ÎØ∏ÎßåÏù¥Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
                            bullet.update();
                            
                            // update ÌõÑ Îã§Ïãú Ï≤¥ÌÅ¨ (500pxÎ•º ÎÑòÏóàÎäîÏßÄ)
                            const newDistance = Math.sqrt(
                                Math.pow(bullet.x - bullet.startX, 2) + 
                                Math.pow(bullet.y - bullet.startY, 2)
                            );
                            if (newDistance >= 500) {
                                // Ï†ïÌôïÌûà 500px ÏúÑÏπòÎ°ú Ï°∞Ï†ï
                                const angle = Math.atan2(bullet.y - bullet.startY, bullet.x - bullet.startX);
                                bullet.x = bullet.startX + Math.cos(angle) * 500;
                                bullet.y = bullet.startY + Math.sin(angle) * 500;
                                
                                bullet.isStopped = true;
                                bullet.stopTime = Date.now();
                                bullet.speed = 0;
                            }
                        }
                    } else {
                        // Î©àÏ∂ò Ï¥ùÏïå: 0.7Ï¥à ÌõÑ ÌéòÏù¥Îìú ÏïÑÏõÉ ÏãúÏûë, 1Ï¥à ÌõÑ Ï†úÍ±∞
                        const now = Date.now();
                        const elapsed = now - bullet.stopTime;
                        
                        if (elapsed >= 700 && bullet.fadeStartTime === 0) {
                            // ÌéòÏù¥Îìú ÏïÑÏõÉ ÏãúÏûë
                            bullet.fadeStartTime = now;
                        }
                        
                        if (elapsed >= 1000) {
                            character.bullets.splice(i, 1);
                            continue;
                        }
                    }
                } else {
                    // Í∑ºÏ†ëÏ†ÑÎ™®ÎìúÍ∞Ä ÏïÑÎãàÎ©¥ ÏùºÎ∞ò ÏóÖÎç∞Ïù¥Ìä∏
                    bullet.update();
                }

                // Î∂ÄÎß§Îûë: ÎêòÎèåÏïÑÏò§Îäî Ï¥ùÏïåÏù¥ ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å ÎãøÏúºÎ©¥ ÏÇ≠Ï†ú
                if (bullet.hasBoomerang && bullet.isReturning && bullet.owner) {
                    if (checkCollision(bullet, bullet.owner)) {
                        character.bullets.splice(i, 1);
                        continue;
                    }
                }
                
                // Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ (Î©àÏ∂ò Ï¥ùÏïåÏùÄ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ Ïïà Ìï®, Î∂ÄÎß§Îûë Ï¥ùÏïåÏùÄ Îßµ Î∞ñÏúºÎ°ú ÎÇòÍ∞ÄÎèÑ ÎêòÎèåÏïÑÏò§ÎØÄÎ°ú Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨ Ïïà Ìï®)
                if (!bullet.isStopped && !bullet.hasBoomerang && bullet.isOutOfBounds()) {
                    character.bullets.splice(i, 1);
                    continue;
                }

                // Ï∂©Îèå Ï≤¥ÌÅ¨ (targetÏùÄ ÏúÑÏóêÏÑú Ïù¥ÎØ∏ ÏÑ†Ïñ∏Îê®)
                if (checkCollision(bullet, target)) {
                    // Í≤åÏûÑÏù¥ ÏùºÏãúÏ†ïÏßÄÎêú ÏÉÅÌÉúÎ©¥ Îç∞ÎØ∏ÏßÄ Î¨¥Ïãú (Ï¶ùÍ∞ï ÏÑ†ÌÉù ÏãúÍ∞Ñ ÎèôÏïà)
                    if (gameState.isPaused) {
                        character.bullets.splice(i, 1);
                        continue;
                    }
                    // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ: Ï†ÅÏùò Ï¥ùÏïåÏùÑ Î∞òÏÇ¨
                    if (target.reflectActive && character !== target) {
                        // Ï¥ùÏïå Î∞©Ìñ•ÏùÑ Î∞òÎåÄÎ°ú (ÏÉÅÎåÄ Ï™ΩÏúºÎ°ú)
                        const dxToTarget = character.x - target.x;
                        const dyToTarget = character.y - target.y;
                        bullet.angle = Math.atan2(dyToTarget, dxToTarget);
                        bullet.owner = target; // Ï¥ùÏïå ÏÜåÏú†ÏûêÎ•º Î≥ÄÍ≤Ω
                        // Ï¥ùÏïåÏùÑ targetÏùò bullets Î∞∞Ïó¥Î°ú Ïù¥Îèô
                        character.bullets.splice(i, 1);
                        target.bullets.push(bullet);
                        continue; // Îç∞ÎØ∏ÏßÄ Ï†ÅÏö© Ïïà Ìï®
                    }
                    // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ: Ï†ÅÏùò Ï¥ùÏïåÏùÑ Î∞òÏÇ¨
                    if (target.reflectActive && character !== target) {
                        // Ï¥ùÏïå Î∞©Ìñ•ÏùÑ Î∞òÎåÄÎ°ú (ÏÉÅÎåÄ Ï™ΩÏúºÎ°ú)
                        const dxToTarget = character.x - target.x;
                        const dyToTarget = character.y - target.y;
                        bullet.angle = Math.atan2(dyToTarget, dxToTarget);
                        bullet.owner = target; // Ï¥ùÏïå ÏÜåÏú†ÏûêÎ•º Î≥ÄÍ≤Ω
                        // Ï¥ùÏïåÏùÑ targetÏùò bullets Î∞∞Ïó¥Î°ú Ïù¥Îèô
                        character.bullets.splice(i, 1);
                        target.bullets.push(bullet);
                        continue; // Îç∞ÎØ∏ÏßÄ Ï†ÅÏö© Ïïà Ìï®
                    }
                    
                    // Íµ¨Î•¥Îäî Ï§ëÏù¥Í±∞ÎÇò Î¨¥Ï†Å ÏÉÅÌÉúÎ©¥ Îç∞ÎØ∏ÏßÄ Î¨¥Ïãú
                    if (target.isDodging || target.isInvincible || target.isReviving) {
                        character.bullets.splice(i, 1);
                        continue;
                    }

                    // Î∞©Ïñ¥Îßâ: Îç∞ÎØ∏ÏßÄ 1Ìöå Î¨¥Ïãú (Ïø®ÌÉÄÏûÑ 7.5Ï¥à)
                    if (target.hasShield && target.shieldReady) {
                        target.shieldReady = false;
                        target.shieldCooldown = Date.now() + 7500; // 7.5Ï¥à Ïø®ÌÉÄÏûÑ
                        character.bullets.splice(i, 1);
                        // "Î¨¥Ïãú" ÌÖçÏä§Ìä∏ ÌëúÏãú
                        target.damageNumbers.push({
                            x: target.x,
                            y: target.y,
                            damage: 0,
                            isCritical: false,
                            isShield: true, // Î∞©Ïñ¥Îßâ Î¨¥Ïãú Ïó¨Î∂Ä
                            startTime: Date.now(),
                            duration: 1000,
                            offsetY: 0
                        });
                        continue; // Îç∞ÎØ∏ÏßÄ Ï†ÅÏö© Ïïà Ìï®
                    }

                    // Ïú†Î†π Ï¶ùÍ∞ï: ÌôïÎ•† Ï§ëÏ≤© (25% * count)
                    const ghostCount = target.ghostCount || 1;
                    if (target.hasGhost && Math.random() < (0.25 * ghostCount)) {
                        // "Î¨¥Ïãú" ÌÖçÏä§Ìä∏ ÌëúÏãú
                        target.damageNumbers.push({
                            x: target.x,
                            y: target.y,
                            damage: 0,
                            isCritical: false,
                            isGhost: true, // Ïú†Î†π Î¨¥Ïãú Ïó¨Î∂Ä
                            startTime: Date.now(),
                            duration: 1000,
                            offsetY: 0
                        });
                        // Ï¥ùÏïå Ï†úÍ±∞ÌïòÍ≥† Îç∞ÎØ∏ÏßÄ Ï†ÅÏö© Ïïà Ìï®
                        character.bullets.splice(i, 1);
                        i--; // Ïù∏Îç±Ïä§ Ï°∞Ï†ï
                        continue; // Îç∞ÎØ∏ÏßÄ Ï†ÅÏö© Ïïà Ìï®
                    }

                    // ÌÅ¨Î¶¨Ìã∞Ïª¨ Í≥ÑÏÇ∞ (ÌôïÎ•† Ï§ëÏ≤©: 25% * count)
                    let finalDamage = bullet.damage;
                    let isCritical = false;
                    const criticalCount = character.criticalCount || 1;
                    if (character.hasCritical && Math.random() < (0.25 * criticalCount)) {
                        finalDamage *= 2;
                        isCritical = true;
                    }
                    
                    // Ï∑®ÏïΩ ÏÉÅÌÉú: Îã§Ïùå Îç∞ÎØ∏ÏßÄ 1.5Î∞∞
                    if (target.isVulnerable && !target.vulnerabilityUsed) {
                        finalDamage *= 1.5;
                        target.vulnerabilityUsed = true; // Ï∑®ÏïΩ ÏÇ¨Ïö©Îê®
                        target.isVulnerable = false; // Ï∑®ÏïΩ ÏÉÅÌÉú Ìï¥Ï†ú
                    }

                    // Í±∞Ï†êÌôïÎ≥¥: Îç∞ÎØ∏ÏßÄ *0.5
                    if (target.hasFortify && target.isFortified) {
                        finalDamage *= 0.5;
                    }

                    // Í≥ºÏó¥: Ïó∞ÏÜç ÌûàÌä∏ Ïãú Îç∞ÎØ∏ÏßÄ Î∞∞Ïú® Ï†ÅÏö©
                    if (character.hasOverheat) {
                        const now = Date.now();
                        // 2Ï¥à Ïù¥ÎÇ¥Ïóê ÌûàÌä∏ÌïòÎ©¥ Ïó∞ÏÜç ÌûàÌä∏Î°ú Í∞ÑÏ£º
                        if (now - character.lastHitTime < 2000) {
                            character.overheatHitCount++;
                        } else {
                            // 2Ï¥à Ïù¥ÏÉÅ ÏßÄÎÇòÎ©¥ Ï¥àÍ∏∞Ìôî
                            character.overheatHitCount = 0;
                        }
                        // Îç∞ÎØ∏ÏßÄ Î∞∞Ïú®: 1 + hitCount * 0.5 (Ï≤´Î≤àÏß∏Îäî 1Î∞∞, ÎëêÎ≤àÏß∏Îäî 1.5Î∞∞, ÏÑ∏Î≤àÏß∏Îäî 2Î∞∞...)
                        finalDamage *= (1 + character.overheatHitCount * 0.5);
                        character.lastHitTime = now;
                    }

                    // ÏïΩÌôî: ÏÉÅÎåÄÏóêÍ≤å ÏïΩÌôî ÏÉÅÌÉú Î∂ÄÏó¨ (3Ï¥à ÎèôÏïà Î™®Îì† Í≥µÍ≤© Îç∞ÎØ∏ÏßÄ -0.25, Ï§ëÏ≤© ÏïàÎê®)
                    // ÏïΩÌôî: ÏÉÅÎåÄÏóêÍ≤å Ï¥ùÏïåÏùÑ ÎßûÏ∂ú Ïãú 3Ï¥àÎèôÏïà ÏÉÅÎåÄ Îç∞ÎØ∏ÏßÄ -0.25 (Ï§ëÏ≤©)
                    if (character.hasWeaken && !target.isWeakened) {
                        target.isWeakened = true;
                        target.weakenEndTime = Date.now() + 3000;
                    }

                    // ÏÜåÏàòÏ†ê 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º, 1~2ÏûêÎ¶¨Îäî Ïú†ÏßÄ
                    finalDamage = roundToMaxTwoDecimals(finalDamage);
                    target.health -= finalDamage;
                    target.health = roundToMaxTwoDecimals(target.health);
                    
                    // ÌîºÏùò Îßõ: Ï†ÅÏóêÍ≤å ÏûÖÌûå ÌîºÌï¥Ïùò 20%ÎßåÌÅº ÌöåÎ≥µ (20%Ïî© Ï§ëÏ≤©)
                    if (character.hasTasteOfBlood) {
                        const tasteOfBloodCount = character.tasteOfBloodCount || 1;
                        let healAmount = finalDamage * (0.2 * tasteOfBloodCount);
                        healAmount = roundToMaxTwoDecimals(healAmount);
                        const oldHealth = character.health;
                        character.health = Math.min(character.health + healAmount, character.maxHealth);
                        character.health = roundToMaxTwoDecimals(character.health);
                        const actualHeal = character.health - oldHealth;
                        if (actualHeal > 0) {
                            // ÌöåÎ≥µ Ïà´Ïûê ÌëúÏãú (Îπ®Í∞ÑÏÉâ)
                            character.damageNumbers.push({
                                x: character.x,
                                y: character.y,
                                damage: roundToMaxTwoDecimals(actualHeal),
                                isCritical: false,
                                isHeal: true, // ÌöåÎ≥µ Ïó¨Î∂Ä
                                startTime: Date.now(),
                                duration: 1000,
                                offsetY: 0
                            });
                        }
                    }
                    
                    // ÏÑ†Í≥†: Ï†ÅÏùÑ ÎßûÏùÄ Î∞©Ìñ•ÏúºÎ°ú 75px Î∞ÄÎ†§ÎÇ® (0.1Ï¥à ÏÜåÏöî)
                    if (character.hasJudgment) {
                        const bulletAngle = bullet.angle;
                        const pushDistance = 75;
                        const pushDuration = 100; // 0.1Ï¥à
                        const pushDx = Math.cos(bulletAngle) * pushDistance;
                        const pushDy = Math.sin(bulletAngle) * pushDistance;
                        
                        // Î∞ÄÎ†§ÎÇòÎäî Î™©Ìëú ÏúÑÏπò
                        const targetPushX = Math.max(
                            gameState.mapBounds.minX + target.radius,
                            Math.min(gameState.mapBounds.maxX - target.radius, target.x + pushDx)
                        );
                        const targetPushY = Math.max(
                            gameState.mapBounds.minY + target.radius,
                            Math.min(gameState.mapBounds.maxY - target.radius, target.y + pushDy)
                        );
                        
                        // Î∞ÄÎ†§ÎÇòÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
                        target.judgmentPushStartX = target.x;
                        target.judgmentPushStartY = target.y;
                        target.judgmentPushTargetX = targetPushX;
                        target.judgmentPushTargetY = targetPushY;
                        target.judgmentPushStartTime = Date.now();
                        target.judgmentPushDuration = pushDuration;
                        target.isJudgmentPushing = true;
                    }
                    
                    character.bullets.splice(i, 1);

                    // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌëúÏãú Ï∂îÍ∞Ä
                    target.damageNumbers.push({
                        x: target.x,
                        y: target.y,
                        damage: finalDamage,
                        isCritical: isCritical, // ÌÅ¨Î¶¨Ìã∞Ïª¨ Ïó¨Î∂Ä
                        startTime: Date.now(),
                        duration: 1000, // 1Ï¥à ÎèôÏïà ÌëúÏãú
                        offsetY: 0 // ÏúÑÎ°ú Ïò¨ÎùºÍ∞ÄÎäî Ïò§ÌîÑÏÖã
                    });

                    // Î≤àÍ∞ú: ÌôïÎ•† Ï§ëÏ≤© (25% * count)
                    const lightningCount = character.lightningCount || 1;
                    if (character.hasLightning && Math.random() < (0.25 * lightningCount)) {
                        target.isStunned = true;
                        target.stunEndTime = Date.now() + 750; // 0.75Ï¥à
                        // Í∏∞Ï†à ÌÖçÏä§Ìä∏ ÌëúÏãú (Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÏúÑÏóê ÌëúÏãú)
                        target.damageNumbers.push({
                            x: target.x,
                            y: target.y,
                            damage: 0,
                            isCritical: false,
                            isStunned: true, // Í∏∞Ï†à Ïó¨Î∂Ä
                            startTime: Date.now(),
                            duration: 1000,
                            offsetY: -40 // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÏúÑÏóê ÌëúÏãú
                        });
                    }

                    // ÍπäÏùÄ ÏÉÅÏ≤ò (ÌîºÍ≤© Ïãú ÏÉÅÎåÄ Ïù¥ÎèôÏÜçÎèÑ -25% (ÏãúÍ∞Ñ Ï§ëÏ≤©))
                    if (character.hasDeepWound) {
                        const deepWoundCount = character.deepWoundCount || 1;
                        target.slowEndTime = Date.now() + (500 * deepWoundCount);
                    }
                    
                    // ÎèÖ ÌÉÑÌôò Ìö®Í≥º (1Ï¥àÍ∞ÑÍ≤©ÏúºÎ°ú 3Î≤à, Îç∞ÎØ∏ÏßÄ Ï§ëÏ≤©)
                    if (bullet.hasPoison) {
                        const poisonCount = character.poisonBulletCount || 1;
                        character.poisonEffects.push({
                            target: target,
                            startTime: Date.now(),
                            duration: 3000, // 3Ï¥à (1Ï¥àÍ∞ÑÍ≤©ÏúºÎ°ú 3Î≤à)
                            damagePerSecond: 0.2 * poisonCount, // Ï§ëÏ≤©Îêú Îç∞ÎØ∏ÏßÄ
                            lastDamageTime: Date.now(),
                            hitCount: 0, // ÌûàÌä∏ ÌöüÏàò
                            maxHits: 3 // ÏµúÎåÄ ÌûàÌä∏ ÌöüÏàò
                        });
                    }
                    
                    // ÏßëÏ§ë ÏÇ¨Í≤©: ÌîºÍ≤©Ïãú 50% ÌôïÎ•†Î°ú ÏÉÅÎåÄÏóêÍ≤å Ï∑®ÏïΩ Î∂ÄÏó¨
                    if (target.hasFocusedFire && Math.random() < 0.5) {
                        character.isVulnerable = true;
                        character.vulnerabilityUsed = false;
                    }

                    if (target.health <= 0) {
                        target.health = 0;
                        
                        // Î∂ÄÌôú Ï≤¥ÌÅ¨ (ÌöüÏàò Ï§ëÏ≤©)
                        const reviveCount = target.reviveCount || 1;
                        const hasRevivedCount = (typeof target.hasRevived === 'number' ? target.hasRevived : (target.hasRevived ? 1 : 0));
                        if (target.hasRevive && hasRevivedCount < reviveCount && !target.isReviving) {
                            target.hasRevived = hasRevivedCount + 1; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¶ùÍ∞Ä
                            target.isReviving = true;
                            target.reviveTime = Date.now() + 2000; // 2Ï¥à
                        } else {
                            endRound(character === player ? 'player' : 'enemy');
                        }
                    }
                    // Ï≤¥Î†•Ïù¥ ÏùåÏàòÍ∞Ä ÎêòÏßÄ ÏïäÎèÑÎ°ù
                    if (target.health < 0) target.health = 0;
                }
            }
        }

        // ÎùºÏö¥Îìú Ï¢ÖÎ£å
        function endRound(winner) {
            gameState.isPaused = true;


            // ÎùºÏö¥Îìú ÏäπÎ¶¨ Í∏∞Î°ùÏóê Ï∂îÍ∞Ä (ÏàúÏÑúÎåÄÎ°ú)
            gameState.roundWins.push(winner);

            if (winner === 'player') {
                gameState.playerWins++;
            } else {
                gameState.enemyWins++;
            }

            // ÏäπÎ¶¨ Ï≤¥ÌÅ¨ (5ÎùºÏö¥Îìú ÏÑ†ÏäπÏ†ú)
            if (gameState.playerWins >= gameState.winsNeeded || gameState.enemyWins >= gameState.winsNeeded) {
                const finalWinner = winner === 'player' ? 'player' : 'enemy';
                endGame(finalWinner);
                return;
            }

            // Ìå®Î∞∞ÏûêÍ∞Ä Ï¶ùÍ∞ï ÏÑ†ÌÉù, ÏäπÎ¶¨ÏûêÎäî ÌôïÏù∏Îßå
            if (winner === 'player') {
                // ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨: AIÍ∞Ä ÏÑ†ÌÉù
                    gameState.showOpponentSelecting = true;
            selectAugmentForEnemy();
            } else {
                // enemy ÏäπÎ¶¨: ÌîåÎ†àÏù¥Ïñ¥Îäî ÏÑ†ÌÉù
                showAugmentModal(player);
            }
        }

        // Ï†ÅÏùÑ ÏúÑÌïú Ï¶ùÍ∞ï ÏûêÎèô ÏÑ†ÌÉù
        function selectAugmentForEnemy() {
            const enemySelectionDiv = document.getElementById('enemySelection');
            const opponentSelectionDiv = document.getElementById('opponentSelection');
            
            if (enemySelectionDiv) {
            enemySelectionDiv.style.display = 'block';
            enemySelectionDiv.innerHTML = '<p style="color: #e94560; margin: 0;">ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉù Ï§ë...</p>';
            }
            
            if (opponentSelectionDiv) {
                opponentSelectionDiv.innerHTML = '<p style="color: #e94560; margin: 0;">ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉù Ï§ë...</p>';
            }
            
            // 3Ï¥à ÎåÄÍ∏∞ ÌõÑ ÏÑ†ÌÉù
            setTimeout(() => {
                // AIÎäî Íµ¨Î•¥Í∏∞, Í±∞Ï†êÌôïÎ≥¥, ÏãúÍ∞ÑÏ†ïÏßÄ Ï¶ùÍ∞ïÏùÑ ÎΩëÏßÄ ÏïäÏùå
                const availableAugments = augmentations.filter(aug => aug.id !== 'dodge' && aug.id !== 'fortify' && aug.id !== 'timeStop');
                const shuffled = [...availableAugments].sort(() => Math.random() - 0.5);
                const selectedAugment = shuffled[0]; // ÎûúÎç§ÏúºÎ°ú ÌïòÎÇò ÏÑ†ÌÉù
                selectedAugment.effect(enemy);
                enemy.augmentations.push(selectedAugment);
                incrementAugmentSelectCount(selectedAugment.id); // ÏÑ†ÌÉù ÌöüÏàò Ï¶ùÍ∞Ä
                
                // ÏÑ†ÌÉùÌïú Ï¶ùÍ∞ï ÌëúÏãú
                if (enemySelectionDiv) {
                enemySelectionDiv.innerHTML = `<p style="color: #e94560; margin: 0;">ÏÉÅÎåÄ ÏÑ†ÌÉù: <strong style="color: #ffc107;">${selectedAugment.name}</strong></p>`;
                }
                if (opponentSelectionDiv) {
                    opponentSelectionDiv.innerHTML = `<p style="color: #e94560; margin: 0;">ÏÉÅÎåÄ ÏÑ†ÌÉù: <strong style="color: #ffc107;">${selectedAugment.name}</strong></p>`;
                }
                
                // Î≥∏ Ï¶ùÍ∞ï Î™©Î°ùÏóê Ï∂îÍ∞Ä (Ï†ÅÏù¥ ÏÑ†ÌÉùÌïú Ï¶ùÍ∞ïÎèÑ)
                markAugmentAsSeen(selectedAugment.id);
                
                // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏäπÎ¶¨Ìïú Í≤ΩÏö∞: ÏÉÅÎåÄ ÏÑ†ÌÉù ÏôÑÎ£å ÌõÑ ÏûêÎèôÏúºÎ°ú Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
                if (gameState.showOpponentSelecting) {
                    gameState.showOpponentSelecting = false;
                    // ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
                    setTimeout(() => {
                        nextRound();
                    }, 500);
                }
            }, 3000);
        }

        // Ï¶ùÍ∞ï Î™®Îã¨ ÌëúÏãú (ÌîåÎ†àÏù¥Ïñ¥Ïö© - ÏÑ†ÌÉù Í∞ÄÎä•)
        function showAugmentModal(character) {
            const modal = document.getElementById('augmentModal');
            const optionsDiv = document.getElementById('augmentOptions');
            optionsDiv.innerHTML = '';

            // ÎûúÎç§ Ï¶ùÍ∞ï 3Í∞ú ÏÑ†ÌÉù (Ï§ëÎ≥µ ÏÑ†ÌÉù Í∞ÄÎä•)
            const shuffled = [...augmentations].sort(() => Math.random() - 0.5);
            const selectedAugments = shuffled.slice(0, 3);

            // ÏÑ†ÌÉù Í∞ÄÎä•Ìïú 3Í∞ú Ï¶ùÍ∞ï Î™®Îëê ÎèÑÍ∞êÏóê Ï†ÄÏû•
            selectedAugments.forEach(aug => {
                markAugmentAsSeen(aug.id);
            });

            let timeLeft = 15;
            let isSelected = false;
            let timerInterval;

            // 2XÎ™®Îìú Ï≤¥ÌÅ¨
            const isDoubleAugmentMode = gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'doubleAugment';
            
            // 2XÎ™®ÎìúÏóêÏÑú ÌòÑÏû¨ ÎùºÏö¥ÎìúÏóê ÏÑ†ÌÉùÌïú Ï¶ùÍ∞ï Í∞úÏàò Ï¥àÍ∏∞Ìôî (Ï≤òÏùå Ìò∏Ï∂ú ÏãúÏóêÎßå)
            if (isDoubleAugmentMode && gameState.doubleAugmentSelectedCount === undefined) {
                gameState.doubleAugmentSelectedCount = 0;
            }
            
            const maxSelections = isDoubleAugmentMode ? 2 : 1;
            const currentSelectedCount = isDoubleAugmentMode ? (gameState.doubleAugmentSelectedCount || 0) : 0;

            // Ï¶ùÍ∞ï ÏÑ†ÌÉù Ìï®Ïàò
            const selectAugment = (aug) => {
                if (isDoubleAugmentMode && gameState.doubleAugmentSelectedCount >= maxSelections) return;
                if (!isDoubleAugmentMode && isSelected) return;
                
                aug.effect(character);
                character.augmentations.push(aug);
                incrementAugmentSelectCount(aug.id); // ÏÑ†ÌÉù ÌöüÏàò Ï¶ùÍ∞Ä
                
                if (isDoubleAugmentMode) {
                    gameState.doubleAugmentSelectedCount = (gameState.doubleAugmentSelectedCount || 0) + 1;
                }
                
                // 2XÎ™®ÎìúÏù¥Í≥† Ï≤´ Î≤àÏß∏ ÏÑ†ÌÉùÏù¥Î©¥ Ï∞ΩÏùÑ Îã´Í≥† ÏÉàÎ°úÏö¥ Ï∞Ω ÎùÑÏö∞Í∏∞
                if (isDoubleAugmentMode && gameState.doubleAugmentSelectedCount === 1) {
                    isSelected = true;
                    clearInterval(timerInterval);
                    gameState.augmentCountdown = 0;
                    modal.style.display = 'none';
                    
                    // ÏïΩÍ∞ÑÏùò ÎîúÎ†àÏù¥ ÌõÑ ÏÉàÎ°úÏö¥ Ï∞Ω ÎùÑÏö∞Í∏∞
                    setTimeout(() => {
                        showAugmentModal(character);
                    }, 300);
                    
                    return; // ÏïÑÏßÅ ÏÑ†ÌÉù Ï§ë
                }
                
                // ÏÑ†ÌÉù ÏôÑÎ£å
                if (isDoubleAugmentMode && gameState.doubleAugmentSelectedCount >= maxSelections) {
                    isSelected = true;
                    clearInterval(timerInterval);
                    gameState.augmentCountdown = 0;
                    gameState.doubleAugmentSelectedCount = 0; // Îã§Ïùå ÎùºÏö¥ÎìúÎ•º ÏúÑÌï¥ Ï¥àÍ∏∞Ìôî
                    modal.style.display = 'none';
                    const viewModal = document.getElementById('augmentViewModal');
                    if (viewModal) {
                        viewModal.style.display = 'none';
                    }
                    nextRound();
                } else if (!isDoubleAugmentMode) {
                    isSelected = true;
                    clearInterval(timerInterval);
                    gameState.augmentCountdown = 0;
                    modal.style.display = 'none';
                    const viewModal = document.getElementById('augmentViewModal');
                    if (viewModal) {
                        viewModal.style.display = 'none';
                    }
                    nextRound();
                }
            };

            // Ï¶ùÍ∞ï ÏòµÏÖò ÏÉùÏÑ±
            selectedAugments.forEach(aug => {
                const option = document.createElement('div');
                option.className = 'augment-option';
                option.innerHTML = `
                    <h4>${aug.name}</h4>
                    <p>${aug.description}</p>
                `;
                option.onclick = () => selectAugment(aug);
                optionsDiv.appendChild(option);
            });

            // Î™®Îã¨ ÌëúÏãú
            modal.style.display = 'block';
            const enemySelectionDiv = document.getElementById('enemySelection');
            // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ìå®Î∞∞Ìïú Í≤ΩÏö∞: Ï†ÅÏùÄ ÏäπÎ¶¨ÏûêÏù¥ÎØÄÎ°ú Ï¶ùÍ∞ïÏùÑ ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùå, Î©îÏãúÏßÄ ÌëúÏãú ÏïàÌï®
            enemySelectionDiv.style.display = 'none';
            
            // ÌôîÎ©¥ Í∞ÄÏö¥Îç∞ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
            gameState.augmentCountdown = 15;
            timerInterval = setInterval(() => {
                timeLeft--;
                gameState.augmentCountdown = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    gameState.augmentCountdown = 0;
                    if (!isSelected) {
                        // ÏãúÍ∞Ñ Ï¥àÍ≥º Ïãú ÎûúÎç§ ÏÑ†ÌÉù
                        const randomAug = selectedAugments[Math.floor(Math.random() * selectedAugments.length)];
                        selectAugment(randomAug);
                    }
                }
            }, 1000);
        }

        // Ï¶ùÍ∞ï ÌôïÏù∏ Î™®Îã¨ ÌëúÏãú (ÏäπÎ¶¨ÏûêÏö© - ÌôïÏù∏Îßå Í∞ÄÎä•)
        function showAugmentViewModal(winnerCharacter, loserType) {
            const modal = document.getElementById('augmentViewModal');
            const opponentSelectionDiv = document.getElementById('opponentSelection');
            
            // Î™®Îã¨ ÌëúÏãú
            modal.style.display = 'block';
            opponentSelectionDiv.innerHTML = '<p style="color: #e94560; margin: 0;">ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉù Ï§ë...</p>';
        }

        // Ï¶ùÍ∞ï ÌôïÏù∏ Î™®Îã¨ Îã´Í∏∞
        function closeAugmentViewModal() {
            const modal = document.getElementById('augmentViewModal');
            modal.style.display = 'none';
            
            // ÏÉÅÎåÄ ÏÑ†ÌÉùÏù¥ ÏôÑÎ£åÎêòÏóàÏúºÎ©¥ Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
            if (enemy.augmentations.length > 0) {
                nextRound();
            } else {
                // ÏïÑÏßÅ Ï†ÅÏù¥ ÏÑ†ÌÉù Ï§ëÏù¥Î©¥ ÎåÄÍ∏∞
                const checkEnemySelection = setInterval(() => {
                    if (enemy.augmentations.length > 0) {
                        clearInterval(checkEnemySelection);
                        nextRound();
                    }
                }, 100);
            }
        }

        // Îã§Ïùå ÎùºÏö¥Îìú
        function nextRound() {
            resizeCanvas();
            gameState.round++;
            gameState.gameTime = 180;
            gameState.showOpponentSelecting = false;
            // 2XÎ™®Îìú ÏÑ†ÌÉù Ïπ¥Ïö¥Ìä∏ Ï¥àÍ∏∞Ìôî
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'doubleAugment') {
                gameState.doubleAugmentSelectedCount = 0;
            }
            
            // Ï†ÑÌà¨ Í≤ΩÌóò: ÏßÑ ÎùºÏö¥Îìú ÏàòÎßàÎã§ ÏµúÎåÄÏ≤¥Î†• 0.5, Îç∞ÎØ∏ÏßÄ 0.1 Ï¶ùÍ∞Ä (Ï§ëÏ≤©)
            if (player.hasCombatExperience) {
                player.combatExperienceRounds = gameState.enemyWins; // ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏßÑ ÎùºÏö¥Îìú Ïàò (Ï†ÅÏù¥ Ïù¥Í∏¥ ÎùºÏö¥Îìú)
                const combatExperienceCount = player.combatExperienceCount || 1;
                player.maxHealth = 5 + player.combatExperienceRounds * (0.5 * combatExperienceCount);
                player.damage = 1 + player.combatExperienceRounds * (0.1 * combatExperienceCount);
            }
            if (enemy.hasCombatExperience) {
                enemy.combatExperienceRounds = gameState.playerWins; // Ï†ÅÏù¥ ÏßÑ ÎùºÏö¥Îìú Ïàò (ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ïù¥Í∏¥ ÎùºÏö¥Îìú)
                const combatExperienceCount = enemy.combatExperienceCount || 1;
                enemy.maxHealth = 5 + enemy.combatExperienceRounds * (0.5 * combatExperienceCount);
                enemy.damage = 1 + enemy.combatExperienceRounds * (0.1 * combatExperienceCount);
            }

            // ÌîåÎ†àÏù¥Ïñ¥ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            player.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.2;
            player.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
            player.health = player.maxHealth;
            player.displayHealth = player.maxHealth;
            player.ammo = player.maxAmmo;
            player.bullets = [];
            player.isReloading = false;
            player.isDodging = false;
            player.dodgeStartTime = 0;
            player.dodgeEndTime = 0;
            player.dodgeStartX = 0;
            player.dodgeStartY = 0;
            player.dodgeTargetX = 0;
            player.dodgeTargetY = 0;
            player.dodgeTrail = [];
            player.lastDodgeTime = 0;
            player.isReviving = false;
            player.reviveTime = 0;
            player.hasRevived = 0; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
            player.isInvincible = false;
            player.invincibleEndTime = 0;
            player.slowEndTime = 0;
            player.damageNumbers = [];
            player.poisonEffects = [];
            player.hasRecoveryContractUsed = false; // ÌöåÎ≥µÍ≥ÑÏïΩ Ï¥àÍ∏∞Ìôî
            player.isVulnerable = false;
            player.vulnerabilityUsed = false;
            player.isStunned = false;
            player.stunEndTime = 0;
            player.shieldReady = true; // Î∞©Ïñ¥Îßâ Ï§ÄÎπÑ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî
            player.shieldCooldown = 0;
            player.isWeakened = false;
            player.weakenEndTime = 0;
            player.lastRegenTime = Date.now(); // Ïû¨ÏÉù ÏãúÏûë ÏãúÍ∞Ñ
            // ÏÉàÎ°úÏö¥ Ï¶ùÍ∞ï ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (ÎùºÏö¥Îìú Ï¥àÍ∏∞Ìôî)
            player.gatlingBullets = 0;
            player.gatlingNextShot = 0;
            player.reflectActive = false;
            player.reflectCooldown = 0;
            player.reflectEndTime = 0;
            player.timeStopActive = false;
            player.timeStopCooldown = 0;
            player.timeStopEndTime = 0;

            // Ï†Å ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            enemy.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.8;
            enemy.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
            enemy.health = enemy.maxHealth;
            enemy.displayHealth = enemy.maxHealth;
            enemy.ammo = enemy.maxAmmo;
            enemy.bullets = [];
            enemy.isReloading = false;
            enemy.isDodging = false;
            enemy.dodgeStartTime = 0;
            enemy.dodgeEndTime = 0;
            enemy.dodgeStartX = 0;
            enemy.dodgeStartY = 0;
            enemy.dodgeTargetX = 0;
            enemy.dodgeTargetY = 0;
            enemy.bulletDodgeTargetY = 0;
            enemy.isDodgingBullet = false;
            enemy.lastPlayerBulletCount = 0;
            enemy.dodgeTrail = [];
            enemy.lastDodgeTime = 0;
            enemy.isReviving = false;
            enemy.reviveTime = 0;
            enemy.hasRevived = 0; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
            enemy.isInvincible = false;
            enemy.invincibleEndTime = 0;
            enemy.slowEndTime = 0;
            enemy.damageNumbers = [];
            enemy.usePrediction = false;
            enemy.lastPlayerX = 0;
            enemy.lastPlayerY = 0;
            enemy.playerVelocity = { x: 0, y: 0 };
            enemy.poisonEffects = [];
            enemy.hasRecoveryContractUsed = false; // ÌöåÎ≥µÍ≥ÑÏïΩ Ï¥àÍ∏∞Ìôî
            enemy.isVulnerable = false;
            enemy.vulnerabilityUsed = false;
            enemy.isStunned = false;
            enemy.stunEndTime = 0;
            enemy.shieldReady = true; // Î∞©Ïñ¥Îßâ Ï§ÄÎπÑ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî
            enemy.shieldCooldown = 0;
            enemy.isWeakened = false;
            enemy.weakenEndTime = 0;
            enemy.lastRegenTime = Date.now(); // Ïû¨ÏÉù ÏãúÏûë ÏãúÍ∞Ñ
            // ÏÉàÎ°úÏö¥ Ï¶ùÍ∞ï ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî (ÎùºÏö¥Îìú Ï¥àÍ∏∞Ìôî)
            enemy.gatlingBullets = 0;
            enemy.gatlingNextShot = 0;
            enemy.reflectActive = false;
            enemy.reflectCooldown = 0;
            enemy.reflectEndTime = 0;
            enemy.timeStopActive = false;
            enemy.timeStopCooldown = 0;
            enemy.timeStopEndTime = 0;

            // 3Ï¥à Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë (Í≤åÏûÑ ÏôÑÏ†ÑÌûà Î©àÏ∂§)
            gameState.countdown = 3;
            gameState.isPaused = true;
            
            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï≤òÎ¶¨
            const countdownInterval = setInterval(() => {
                gameState.countdown--;
                if (gameState.countdown <= 0) {
                    clearInterval(countdownInterval);
                    gameState.isPaused = false;
                }
            }, 1000);
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        function endGame(winner) {
            gameState.isGameOver = true;
            const modal = document.getElementById('gameOverModal');
            const title = document.getElementById('gameOverTitle');
            const message = document.getElementById('gameOverMessage');

            if (winner === 'player') {
                title.textContent = 'ÏäπÎ¶¨';
                title.style.color = '#4a9eff'; // ÌååÎûÄÏÉâ
                message.textContent = 'ÏäπÎ¶¨';
                message.style.color = '#4a9eff'; // ÌååÎûÄÏÉâ
            } else {
                title.textContent = 'Ìå®Î∞∞';
                title.style.color = '#e94560'; // Îπ®Í∞ÑÏÉâ
                message.textContent = 'Ìå®Î∞∞';
                message.style.color = '#e94560'; // Îπ®Í∞ÑÏÉâ
            }

            modal.style.display = 'block';
            
            // 10Ï¥à ÌõÑ Î©îÏù∏ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
            setTimeout(() => {
                // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú Ïù¥Îèô
                window.scrollTo(0, 0);
                restartGame();
            }, 10000);
        }

        // Í≤åÏûÑ Ïû¨ÏãúÏûë
        function restartGame() {
            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú Ïù¥Îèô
            window.scrollTo(0, 0);
            // Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            gameState.isMenu = true;
            gameState.isGameOver = false;
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            
            // Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞
            collapseModeSelection();
            
            // Ï≤´ ÎùºÏö¥Îìú Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
            gameState.isPaused = true;
            const countdownInterval = setInterval(() => {
                gameState.countdown--;
                if (gameState.countdown <= 0) {
                    clearInterval(countdownInterval);
                    gameState.isPaused = false;
                }
            }, 1000);

            player.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.2;
            player.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
            player.health = 5;
            player.displayHealth = 5;
            player.maxHealth = 5;
            player.ammo = 6;
            player.maxAmmo = 6;
            player.bullets = [];
            player.augmentations = [];
            player.bulletSpeedMultiplier = 1;
            player.bulletSizeMultiplier = 1;
            player.hasCritical = false;
            player.hasDoubleShot = false;
            player.hasDodge = false;
            player.hasRevive = false;
            player.hasDeepWound = false;
            player.hasOneShotOneKill = false;
            player.hasPoisonBullet = false;
            player.hasReloadHeal = false;
            player.hasSurvivalInstinct = false;
            player.hasLastBullet = false;
            player.hasRecoveryContract = false;
            player.hasRecoveryContractUsed = false;
            player.hasFocusedFire = false;
            player.hasShotgun = false;
            player.hasRagged = false;
            player.hasGhost = false;
            player.hasFortify = false;
            player.isFortified = false;
            player.fortifyStartTime = 0;
            player.lastPosition = { x: player.x, y: player.y };
            player.stationaryTime = 0;
            player.hasOverheat = false;
            player.overheatHitCount = 0;
            player.lastHitTime = 0;
            player.hasGamble = false;
            player.hasWeaken = false;
            player.isWeakened = false;
            player.weakenEndTime = 0;
            player.hasDamageBoost = false;
            player.hasLightning = false;
            player.isStunned = false;
            player.stunEndTime = 0;
            player.hasShield = false;
            player.shieldReady = false;
            player.shieldCooldown = 0;
            player.hasRegeneration = false;
            player.lastRegenTime = 0;
            player.hasEvasiveManeuver = false;
            player.hasCombatExperience = false;
            player.combatExperienceRounds = 0;
            player.hasHallucination = false;
            player.hasTasteOfBlood = false;
            player.hasCannon = false;
            player.hasTimeBarrier = false;
            player.timeBarrierRadius = 150;
            player.hasBouncyBullet = false;
            player.isVulnerable = false;
            player.vulnerabilityUsed = false;
            player.poisonEffects = [];
            player.isDodging = false;
            player.dodgeStartTime = 0;
            player.dodgeEndTime = 0;
            player.dodgeStartX = 0;
            player.dodgeStartY = 0;
            player.dodgeTargetX = 0;
            player.dodgeTargetY = 0;
            player.dodgeTrail = [];
            player.lastDodgeTime = 0;
            player.isReviving = false;
            player.reviveTime = 0;
            player.hasRevived = 0; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
            player.isInvincible = false;
            player.invincibleEndTime = 0;
            player.slowEndTime = 0;
            player.damageNumbers = [];
            player.damage = 1;
            player.speed = 3;
            player.reloadTime = 3000;
            player.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
            player.reloadStartTime = 0;
            player.shootCooldown = 1000;

            enemy.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.8;
            enemy.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
            enemy.health = 5;
            enemy.displayHealth = 5;
            enemy.maxHealth = 5;
            enemy.ammo = 6;
            enemy.maxAmmo = 6;
            enemy.bullets = [];
            enemy.augmentations = [];
            enemy.bulletSpeedMultiplier = 1;
            enemy.bulletSizeMultiplier = 1;
            enemy.hasCritical = false;
            enemy.hasDoubleShot = false;
            enemy.hasDodge = false;
            enemy.hasRevive = false;
            enemy.hasRevived = 0; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
            enemy.hasDeepWound = false;
            enemy.hasOneShotOneKill = false;
            enemy.hasPoisonBullet = false;
            enemy.hasReloadHeal = false;
            enemy.hasSurvivalInstinct = false;
            enemy.hasLastBullet = false;
            enemy.hasRecoveryContract = false;
            enemy.hasRecoveryContractUsed = false;
            enemy.hasFocusedFire = false;
            enemy.hasEvasiveManeuver = false;
            enemy.hasCombatExperience = false;
            enemy.combatExperienceRounds = 0;
            enemy.hasHallucination = false;
            enemy.hasTasteOfBlood = false;
            enemy.hasCannon = false;
            enemy.hasTimeBarrier = false;
            enemy.timeBarrierRadius = 150;
            enemy.hasBouncyBullet = false;
            enemy.hasGatling = false;
            enemy.gatlingBullets = 0;
            enemy.gatlingNextShot = 0;
            enemy.hasReflect = false;
            enemy.reflectActive = false;
            enemy.reflectCooldown = 0;
            enemy.reflectEndTime = 0;
            enemy.hasTimeStop = false;
            enemy.timeStopCooldown = 0;
            enemy.timeStopActive = false;
            enemy.timeStopEndTime = 0;
            enemy.hasScatter = false;
            enemy.hasGamble2 = false;
            enemy.hasRocket = false;
            enemy.hasTrinity = false;
            enemy.hasJudgment = false;
            enemy.isJudgmentPushing = false;
            enemy.judgmentPushStartX = 0;
            enemy.judgmentPushStartY = 0;
            enemy.judgmentPushTargetX = 0;
            enemy.judgmentPushTargetY = 0;
            enemy.judgmentPushStartTime = 0;
            enemy.judgmentPushDuration = 0;
            enemy.hasBoomerang = false;
            enemy.isVulnerable = false;
            enemy.vulnerabilityUsed = false;
            enemy.poisonEffects = [];
            enemy.isDodging = false;
            enemy.dodgeStartTime = 0;
            enemy.dodgeEndTime = 0;
            enemy.dodgeStartX = 0;
            enemy.dodgeStartY = 0;
            enemy.dodgeTargetX = 0;
            enemy.dodgeTargetY = 0;
            enemy.bulletDodgeTargetY = 0;
            enemy.isDodgingBullet = false;
            enemy.lastPlayerBulletCount = 0;
            enemy.dodgeTrail = [];
            enemy.lastDodgeTime = 0;
            enemy.isReviving = false;
            enemy.reviveTime = 0;
            enemy.hasRevived = 0; // Î∂ÄÌôú ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
            enemy.isInvincible = false;
            enemy.invincibleEndTime = 0;
            enemy.slowEndTime = 0;
            enemy.damageNumbers = [];
            enemy.usePrediction = false;
            enemy.lastPlayerX = 0;
            enemy.lastPlayerY = 0;
            enemy.playerVelocity = { x: 0, y: 0 };
            enemy.damage = 1;
            enemy.reloadTime = 3000;
            enemy.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
            enemy.reloadStartTime = 0;
            enemy.shootCooldown = 1000;

            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('augmentModal').style.display = 'none';
        }

        // Îë•Í∑º ÏÇ¨Í∞ÅÌòï Í∑∏Î¶¨Í∏∞ Ìó¨Ìçº Ìï®Ïàò
        function drawRoundedRect(x, y, width, height, radius) {
            ctx.beginPath();
            // ÏÉÅÎã® ÏôºÏ™Ω
            ctx.moveTo(x + radius, y);
            // ÏÉÅÎã® Ïò§Î•∏Ï™Ω
            ctx.lineTo(x + width - radius, y);
            ctx.arcTo(x + width, y, x + width, y + radius, radius);
            // Ïò§Î•∏Ï™Ω ÏïÑÎûò
            ctx.lineTo(x + width, y + height - radius);
            ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
            // ÏïÑÎûò ÏôºÏ™Ω
            ctx.lineTo(x + radius, y + height);
            ctx.arcTo(x, y + height, x, y + height - radius, radius);
            // ÏôºÏ™Ω ÏúÑ
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
        }

        // Ï≤¥Î†• ÌëúÏãú Í∑∏Î¶¨Í∏∞ (ÏßÅÏÇ¨Í∞ÅÌòï Î∞î)
        function drawHealthHearts(character, x, y, isPlayer) {
            const fixedBarWidth = 150; // Í≥†Ï†ïÎêú Î∞î Í∏∏Ïù¥ (200 -> 150)
            const barHeight = 20;
            const borderRadius = 4;
            const color = isPlayer ? '#4a9eff' : '#e94560';
            
            // Î∞∞Í≤Ω (Îπà Î∞î)
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            drawRoundedRect(x, y, fixedBarWidth, barHeight, borderRadius);
            ctx.fill();
            ctx.restore();
            
            // Ï±ÑÏõåÏßÑ Î∂ÄÎ∂Ñ (Ïï†ÎãàÎ©îÏù¥ÏÖò) - Ìï≠ÏÉÅ ÎÑ§Ïò® Ìö®Í≥º Ï†ÅÏö©
            const fillRatio = Math.max(0, Math.min(1, character.displayHealth / character.maxHealth));
            const fillWidth = fixedBarWidth * fillRatio;
            
            if (fillWidth > 0) {
                ctx.save();
                ctx.shadowBlur = 15;
                ctx.shadowColor = color;
                ctx.fillStyle = color;
                // Î∂ÄÎ∂Ñ Ï±ÑÏö∞Í∏∞Î•º ÏúÑÌï¥ ÌÅ¥Î¶¨Ìïë ÏÇ¨Ïö©
                if (fillWidth < fixedBarWidth) {
                    ctx.save();
                    ctx.beginPath();
                    drawRoundedRect(x, y, fillWidth, barHeight, borderRadius);
                    ctx.clip();
                    drawRoundedRect(x, y, fixedBarWidth, barHeight, borderRadius);
                    ctx.fill();
                    ctx.restore();
                } else {
                    drawRoundedRect(x, y, fixedBarWidth, barHeight, borderRadius);
                    ctx.fill();
                }
                ctx.restore();
            }
            
            // ÌÖåÎëêÎ¶¨ - Ìï≠ÏÉÅ ÎÑ§Ïò® Ìö®Í≥º Ï†ÅÏö©
            ctx.save();
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            drawRoundedRect(x, y, fixedBarWidth, barHeight, borderRadius);
            ctx.stroke();
            ctx.restore();
        }

        // Ï¶ùÍ∞ï ÏïÑÏù¥ÏΩò Í∑∏Î¶¨Í∏∞
        function drawAugmentIcon(ctx, x, y, size, augId) {
            ctx.save();
            ctx.translate(x, y);
            ctx.shadowBlur = 8; // Í∏∞Î≥∏ ÎÑ§Ïò® Ìö®Í≥º
            
            switch(augId) {
                case 'health':
                    // Ï≤¥Î†•: ÌïòÌä∏ Î™®Ïñë (Ï§ëÏïô Ï†ïÎ†¨, Ï°∞Í∏à Îçî ÏúÑÎ°ú)
                    ctx.fillStyle = '#ff006e';
                    ctx.shadowColor = '#ff006e';
                    ctx.beginPath();
                    ctx.moveTo(0, size * -0.05);
                    ctx.bezierCurveTo(0, -size * 0.35, -size * 0.4, -size * 0.35, -size * 0.4, size * -0.05);
                    ctx.bezierCurveTo(-size * 0.4, size * 0.2, 0, size * 0.45, 0, size * 0.45);
                    ctx.bezierCurveTo(0, size * 0.45, size * 0.4, size * 0.2, size * 0.4, size * -0.05);
                    ctx.bezierCurveTo(size * 0.4, -size * 0.35, 0, -size * 0.35, 0, size * -0.05);
                    ctx.fill();
                    break;
                case 'speed':
                    // ÏÜçÎèÑ: ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#00ff88';
                    ctx.shadowColor = '#00ff88';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.3, 0);
                    ctx.lineTo(size * 0.3, 0);
                    ctx.lineTo(0, -size * 0.4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.3, 0);
                    ctx.lineTo(0, size * 0.4);
                    ctx.lineTo(size * 0.3, 0);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'bulletSpeed':
                    // Ï¥ùÏïå ÏÜçÎèÑ: Î≤àÍ∞ú
                    ctx.fillStyle = '#ffaa00'; // ÌååÏä§ÌÖî Ïò§Î†åÏßÄ
                    ctx.shadowColor = '#ffaa00';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.2, -size * 0.4);
                    ctx.lineTo(size * 0.1, 0);
                    ctx.lineTo(-size * 0.1, 0);
                    ctx.lineTo(size * 0.2, size * 0.4);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'ammo':
                    // ÌÉÑÏïΩ: Ïõê
                    ctx.fillStyle = '#ffffff'; // ÌååÏä§ÌÖî ÌôîÏù¥Ìä∏
                    ctx.shadowColor = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'fireRate':
                    // Î∞úÏÇ¨ ÏÜçÎèÑ: Î≥Ñ
                    ctx.fillStyle = '#ff00ff'; // ÌååÏä§ÌÖî ÎßàÏ††ÌÉÄ
                    ctx.shadowColor = '#ff00ff';
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
                        const r = i % 2 === 0 ? size * 0.4 : size * 0.2;
                        const x = Math.cos(angle) * r;
                        const y = Math.sin(angle) * r;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'reload':
                    // Ïû¨Ïû•Ï†Ñ: ÏãúÍ≥Ñ
                    ctx.strokeStyle = '#00ffff'; // ÌååÏä§ÌÖî ÏãúÏïà
                    ctx.shadowColor = '#00ffff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(0, -size * 0.3);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(size * 0.2, 0);
                    ctx.stroke();
                    break;
                case 'critical':
                    // ÌÅ¨Î¶¨Ìã∞Ïª¨: X ÌëúÏãú
                    ctx.strokeStyle = '#ff0000'; // ÌååÏä§ÌÖî Î†àÎìú
                    ctx.shadowColor = '#ff0000';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.3, -size * 0.3);
                    ctx.lineTo(size * 0.3, size * 0.3);
                    ctx.moveTo(size * 0.3, -size * 0.3);
                    ctx.lineTo(-size * 0.3, size * 0.3);
                    ctx.stroke();
                    break;
                case 'doubleShot':
                    // ÎçîÎ∏îÏÉ∑: Îëê Í∞úÏùò Ïõê
                    ctx.fillStyle = '#ffc107'; // ÌååÏä§ÌÖî ÏòêÎ°úÏö∞
                    ctx.beginPath();
                    ctx.arc(-size * 0.2, 0, size * 0.25, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.2, 0, size * 0.25, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'dodge':
                    // Íµ¨Î•¥Í∏∞: ÎåÄÏãúÏÑ†
                    ctx.strokeStyle = '#8888ff'; // ÌååÏä§ÌÖî Î∏îÎ£®
                    ctx.lineWidth = 2;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.4, 0);
                    ctx.lineTo(size * 0.4, 0);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    break;
                case 'revive':
                    // Î∂ÄÌôú: Ïã≠ÏûêÍ∞Ä
                    ctx.fillStyle = '#00ff88'; // ÌååÏä§ÌÖî Í∑∏Î¶∞
                    ctx.fillRect(-size * 0.15, -size * 0.4, size * 0.3, size * 0.8);
                    ctx.fillRect(-size * 0.4, -size * 0.15, size * 0.8, size * 0.3);
                    break;
                case 'deepWound':
                    // ÍπäÏùÄ ÏÉÅÏ≤ò: Ïπº
                    ctx.fillStyle = '#880000';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.1, size * 0.2);
                    ctx.lineTo(0, size * 0.3);
                    ctx.lineTo(size * 0.1, size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'giant':
                    // Í±∞ÎåÄÌôî: ÌÅ∞ ÏÇ¨Í∞ÅÌòï
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-size * 0.4, -size * 0.4, size * 0.8, size * 0.8);
                    // ÎÇ¥Î∂Ä ÏûëÏùÄ ÏÇ¨Í∞ÅÌòï
                    ctx.fillStyle = '#A0522D';
                    ctx.fillRect(-size * 0.25, -size * 0.25, size * 0.5, size * 0.5);
                    break;
                case 'sniper':
                    // Ï†ÄÍ≤©Ïàò: Ïä§ÏΩîÌîÑ
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 2;
                    // Ïô∏Î∂Ä Ïõê
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.stroke();
                    // Ïã≠ÏûêÏÑ†
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.4, 0);
                    ctx.lineTo(size * 0.4, 0);
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(0, size * 0.4);
                    ctx.stroke();
                    // Ï§ëÏïô Ï†ê
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.1, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'oneShotOneKill':
                    // ÏõêÏÉ∑ÏõêÌÇ¨: ÌÅ∞ Ï¥ùÏïå
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.35, 0, Math.PI * 2);
                    ctx.fill();
                    // Ï§ëÏïô X
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.2, -size * 0.2);
                    ctx.lineTo(size * 0.2, size * 0.2);
                    ctx.moveTo(size * 0.2, -size * 0.2);
                    ctx.lineTo(-size * 0.2, size * 0.2);
                    ctx.stroke();
                    break;
                case 'poisonBullet':
                    // ÎèÖ ÌÉÑÌôò: ÎèÖ Î∞©Ïö∏
                    ctx.fillStyle = '#006600';
                    ctx.beginPath();
                    ctx.arc(0, -size * 0.1, size * 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    // ÏûëÏùÄ Î∞©Ïö∏
                    ctx.beginPath();
                    ctx.arc(-size * 0.15, size * 0.15, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.15, size * 0.15, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'reloadHeal':
                    // Ïû¨Ïû•Ï†Ñ ÌöåÎ≥µ: ÌïòÌä∏ + ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#ff006e';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.1);
                    ctx.bezierCurveTo(0, -size * 0.1, -size * 0.3, -size * 0.1, -size * 0.3, size * 0.1);
                    ctx.bezierCurveTo(-size * 0.3, size * 0.3, 0, size * 0.5, 0, size * 0.5);
                    ctx.bezierCurveTo(0, size * 0.5, size * 0.3, size * 0.3, size * 0.3, size * 0.1);
                    ctx.bezierCurveTo(size * 0.3, -size * 0.1, 0, -size * 0.1, 0, size * 0.1);
                    ctx.fill();
                    // ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.moveTo(size * 0.2, 0);
                    ctx.lineTo(0, -size * 0.2);
                    ctx.lineTo(0, size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'bigBullet':
                    // ÌÅ∞ ÌÉÑÌôò: ÌÅ∞ Ïõê
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    // ÎÇ¥Î∂Ä ÏûëÏùÄ Ïõê
                    ctx.fillStyle = '#888888';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.25, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'survivalInstinct':
                    // ÏÉùÏ°¥Î≥∏Îä•: Î≤àÍ∞ú + ÌïòÌä∏
                    ctx.fillStyle = '#ffaa00';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.2, -size * 0.3);
                    ctx.lineTo(size * 0.1, 0);
                    ctx.lineTo(-size * 0.1, 0);
                    ctx.lineTo(size * 0.2, size * 0.3);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#ff006e';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.1);
                    ctx.bezierCurveTo(0, -size * 0.1, -size * 0.25, -size * 0.1, -size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(-size * 0.25, size * 0.3, 0, size * 0.5, 0, size * 0.5);
                    ctx.bezierCurveTo(0, size * 0.5, size * 0.25, size * 0.3, size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(size * 0.25, -size * 0.1, 0, -size * 0.1, 0, size * 0.1);
                    ctx.fill();
                    break;
                case 'lastBullet':
                    // ÎπÑÏû•Ïùò ÌïúÎ∞ú: ÌÅ∞ Ï¥ùÏïå + Î≥Ñ
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(-size * 0.3, -size * 0.15, size * 0.6, size * 0.3);
                    ctx.fillStyle = '#ffc107';
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
                        const r = i % 2 === 0 ? size * 0.2 : size * 0.1;
                        const x = Math.cos(angle) * r;
                        const y = Math.sin(angle) * r;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'recoveryContract':
                    // ÌöåÎ≥µÍ≥ÑÏïΩ: ÌïòÌä∏ + ÌôîÏÇ¥Ìëú ÏúÑ
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.1);
                    ctx.bezierCurveTo(0, -size * 0.1, -size * 0.3, -size * 0.1, -size * 0.3, size * 0.1);
                    ctx.bezierCurveTo(-size * 0.3, size * 0.3, 0, size * 0.5, 0, size * 0.5);
                    ctx.bezierCurveTo(0, size * 0.5, size * 0.3, size * 0.3, size * 0.3, size * 0.1);
                    ctx.bezierCurveTo(size * 0.3, -size * 0.1, 0, -size * 0.1, 0, size * 0.1);
                    ctx.fill();
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.3);
                    ctx.lineTo(-size * 0.15, -size * 0.1);
                    ctx.lineTo(size * 0.15, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'focusedFire':
                    // ÏßëÏ§ë ÏÇ¨Í≤©: Îàà Î™®Ïñë
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(-size * 0.15, 0, size * 0.2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.15, 0, size * 0.2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.15, 0, size * 0.1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.15, 0, size * 0.1, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'ghost':
                    // Ïú†Î†π: Î∞òÌà¨Î™Ö Ïõê + ÏûëÏùÄ ÏõêÎì§
                    ctx.globalAlpha = 0.7;
                    ctx.fillStyle = '#cccccc';
                    ctx.beginPath();
                    ctx.arc(0, -size * 0.1, size * 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    // ÏûëÏùÄ ÏõêÎì§ (Ïú†Î†π ÎäêÎÇå)
                    ctx.beginPath();
                    ctx.arc(-size * 0.15, size * 0.1, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.15, size * 0.1, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                    break;
                case 'fortify':
                    // Í±∞Ï†êÌôïÎ≥¥: Î∞©Ìå® Î™®Ïñë
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    // Î∞©Ìå® Î≥∏Ï≤¥
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.3, -size * 0.2);
                    ctx.lineTo(-size * 0.3, size * 0.2);
                    ctx.lineTo(0, size * 0.3);
                    ctx.lineTo(size * 0.3, size * 0.2);
                    ctx.lineTo(size * 0.3, -size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    // Ïã≠ÏûêÍ∞Ä
                    ctx.strokeStyle = '#000000';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.2);
                    ctx.lineTo(0, size * 0.1);
                    ctx.moveTo(-size * 0.15, -size * 0.05);
                    ctx.lineTo(size * 0.15, -size * 0.05);
                    ctx.stroke();
                    break;
                case 'overheat':
                    // Í≥ºÏó¥: Î∂àÍΩÉ Î™®Ïñë
                    ctx.fillStyle = '#ff6600';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.2, -size * 0.1);
                    ctx.lineTo(-size * 0.15, size * 0.1);
                    ctx.lineTo(0, size * 0.2);
                    ctx.lineTo(size * 0.15, size * 0.1);
                    ctx.lineTo(size * 0.2, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    // ÏûëÏùÄ Î∂àÍΩÉÎì§
                    ctx.fillStyle = '#ffaa00';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.1, -size * 0.2);
                    ctx.lineTo(-size * 0.05, 0);
                    ctx.lineTo(0, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(size * 0.1, -size * 0.2);
                    ctx.lineTo(size * 0.05, 0);
                    ctx.lineTo(0, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'gamble':
                    // ÎèÑÎ∞ï: Ï£ºÏÇ¨ÏúÑ Î™®Ïñë
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(-size * 0.3, -size * 0.3, size * 0.6, size * 0.6);
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-size * 0.3, -size * 0.3, size * 0.6, size * 0.6);
                    // Ï£ºÏÇ¨ÏúÑ Îàà
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(-size * 0.15, -size * 0.15, size * 0.05, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(size * 0.15, size * 0.15, size * 0.05, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                case 'weaken':
                    // ÏïΩÌôî: ÏïÑÎûò ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#888888';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.3);
                    ctx.lineTo(-size * 0.2, size * 0.1);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.2, size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    // Í∞êÏÜå ÌëúÏãú
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.15, size * 0.2);
                    ctx.lineTo(size * 0.15, size * 0.2);
                    ctx.stroke();
                    break;
                case 'damageBoost':
                    // Îç∞ÎØ∏ÏßÄ 1.2Î∞∞: ÏúÑ ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#ff6600';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.3);
                    ctx.lineTo(-size * 0.2, -size * 0.1);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.2, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    // Ï¶ùÍ∞Ä ÌëúÏãú
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.15, -size * 0.2);
                    ctx.lineTo(size * 0.15, -size * 0.2);
                    ctx.stroke();
                    break;
                case 'lightning':
                    // Î≤àÍ∞ú: Î≤àÍ∞ú Î™®Ïñë
                    ctx.fillStyle = '#ffff00';
                    ctx.strokeStyle = '#ffaa00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.1, -size * 0.4);
                    ctx.lineTo(size * 0.1, -size * 0.2);
                    ctx.lineTo(-size * 0.05, -size * 0.1);
                    ctx.lineTo(size * 0.15, size * 0.2);
                    ctx.lineTo(-size * 0.1, size * 0.3);
                    ctx.lineTo(0, size * 0.1);
                    ctx.lineTo(-size * 0.05, 0);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                case 'shield':
                    // Î∞©Ïñ¥Îßâ: Î∞©Ìå® Î™®Ïñë
                    ctx.fillStyle = '#0066ff';
                    ctx.strokeStyle = '#0044cc';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.3, -size * 0.2);
                    ctx.lineTo(-size * 0.3, size * 0.1);
                    ctx.lineTo(0, size * 0.3);
                    ctx.lineTo(size * 0.3, size * 0.1);
                    ctx.lineTo(size * 0.3, -size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                case 'regeneration':
                    // Ïû¨ÏÉù: ÌïòÌä∏ + ÌîåÎü¨Ïä§
                    ctx.fillStyle = '#ff006e';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.1);
                    ctx.bezierCurveTo(0, -size * 0.1, -size * 0.25, -size * 0.1, -size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(-size * 0.25, size * 0.3, 0, size * 0.5, 0, size * 0.5);
                    ctx.bezierCurveTo(0, size * 0.5, size * 0.25, size * 0.3, size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(size * 0.25, -size * 0.1, 0, -size * 0.1, 0, size * 0.1);
                    ctx.fill();
                    // ÌîåÎü¨Ïä§ ÌëúÏãú
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(-size * 0.1, -size * 0.05, size * 0.2, size * 0.03);
                    ctx.fillRect(-size * 0.05, -size * 0.1, size * 0.03, size * 0.2);
                    break;
                case 'shotgun':
                    // ÏÉ∑Í±¥: ÏÇ∞ÌÉÑÏ¥ù Î™®Ïñë
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-size * 0.4, -size * 0.1, size * 0.8, size * 0.2);
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(-size * 0.35, -size * 0.05, size * 0.7, size * 0.1);
                    break;
                case 'ragged':
                    // Îã§Îã§ÏùµÏÑ†: Íπ®ÏßÑ Ï¥ùÏïå
                    ctx.fillStyle = '#888888';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.2, -size * 0.2);
                    ctx.lineTo(size * 0.2, size * 0.2);
                    ctx.stroke();
                    break;
                case 'evasiveManeuver':
                    // ÌöåÌîºÍ∏∞Îèô: ÌôîÏÇ¥Ìëú + Î≤àÍ∞ú
                    ctx.fillStyle = '#4a9eff';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.3);
                    ctx.lineTo(-size * 0.2, size * 0.1);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.2, size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#ffff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.1, -size * 0.1);
                    ctx.lineTo(size * 0.1, size * 0.1);
                    ctx.moveTo(size * 0.1, -size * 0.1);
                    ctx.lineTo(-size * 0.1, size * 0.1);
                    ctx.stroke();
                    break;
                case 'combatExperience':
                    // Ï†ÑÌà¨ Í≤ΩÌóò: Î≥Ñ
                    ctx.fillStyle = '#ffaa00';
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
                        const r = i % 2 === 0 ? size * 0.3 : size * 0.15;
                        const x = Math.cos(angle) * r;
                        const y = Math.sin(angle) * r;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'hallucination':
                    // ÌôòÍ∞Å: Î¨ºÍ≤∞ Î™®Ïñë
                    ctx.strokeStyle = '#ff00ff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = -size * 0.4; i <= size * 0.4; i += 5) {
                        const y = Math.sin(i * 0.2) * size * 0.2;
                        if (i === -size * 0.4) ctx.moveTo(i, y);
                        else ctx.lineTo(i, y);
                    }
                    ctx.stroke();
                    break;
                case 'tasteOfBlood':
                    // ÌîºÏùò Îßõ: Îπ®Í∞Ñ ÌïòÌä∏
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.1);
                    ctx.bezierCurveTo(0, -size * 0.1, -size * 0.25, -size * 0.1, -size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(-size * 0.25, size * 0.3, 0, size * 0.5, 0, size * 0.5);
                    ctx.bezierCurveTo(0, size * 0.5, size * 0.25, size * 0.3, size * 0.25, size * 0.1);
                    ctx.bezierCurveTo(size * 0.25, -size * 0.1, 0, -size * 0.1, 0, size * 0.1);
                    ctx.fill();
                    break;
                case 'cannon':
                    // ÎåÄÌè¨: ÌÅ∞ Ïõê
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#654321';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    break;
                case 'timeBarrier':
                    // ÏãúÍ∞ÑÏû•Îßâ: Ïõê + ÏãúÍ≥Ñ
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.globalAlpha = 0.5;
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.4, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.globalAlpha = 1.0;
                    // ÏãúÍ≥Ñ Î∞îÎäò
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(0, -size * 0.2);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(size * 0.15, size * 0.1);
                    ctx.stroke();
                    break;
                case 'bouncyBullet':
                    // ÌÜµÌÜµÌÉÑ: ÌäïÍ∏∞Îäî ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#ffaa00';
                    ctx.beginPath();
                    // ÏúÑÏ™Ω ÌôîÏÇ¥Ìëú
                    ctx.moveTo(0, -size * 0.3);
                    ctx.lineTo(-size * 0.15, -size * 0.1);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.15, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    // ÏïÑÎûòÏ™Ω ÌôîÏÇ¥Ìëú (Î∞òÎåÄ Î∞©Ìñ•)
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.3);
                    ctx.lineTo(-size * 0.15, size * 0.1);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.15, size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'gamble2':
                    // Ïä§ÎÑ§Ïù¥ÌÅ¨: Îã®ÏàúÌïú ÌôîÏÇ¥Ìëú (Î∞©Ìñ• Ï†ÑÌôò)
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.25, 0);
                    ctx.lineTo(size * 0.25, 0);
                    ctx.moveTo(size * 0.2, -size * 0.15);
                    ctx.lineTo(size * 0.25, 0);
                    ctx.lineTo(size * 0.2, size * 0.15);
                    ctx.stroke();
                    break;
                case 'reflect':
                    // Î∞òÏÇ¨: Î∞©Ìå® + ÌôîÏÇ¥Ìëú Î∞òÏÇ¨
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.3, -size * 0.2);
                    ctx.lineTo(-size * 0.3, size * 0.2);
                    ctx.lineTo(0, size * 0.3);
                    ctx.lineTo(size * 0.3, size * 0.2);
                    ctx.lineTo(size * 0.3, -size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    // Î∞òÏÇ¨ ÌôîÏÇ¥Ìëú
                    ctx.strokeStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.2, 0);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(size * 0.2, 0);
                    ctx.moveTo(size * 0.15, -size * 0.1);
                    ctx.lineTo(size * 0.2, 0);
                    ctx.lineTo(size * 0.15, size * 0.1);
                    ctx.stroke();
                    break;
                case 'gatling':
                    // Í≤åÌãÄÎßÅ: ÌöåÏ†ÑÌïòÎäî Ï¥ùÏó¥
                    ctx.fillStyle = '#666666';
                    ctx.fillRect(-size * 0.4, -size * 0.2, size * 0.8, size * 0.4);
                    ctx.fillStyle = '#000000';
                    // Ï¥ùÏó¥ Íµ¨Î©çÎì§
                    for (let i = -2; i <= 2; i++) {
                        ctx.beginPath();
                        ctx.arc(i * size * 0.15, 0, size * 0.05, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    break;
                case 'timeStop':
                    // ÏãúÍ∞ÑÏ†ïÏßÄ: ÌöåÏÉâ Î©àÏ∂§ ÏïÑÏù¥ÏΩò (pause icon)
                    ctx.fillStyle = '#888888';
                    ctx.shadowColor = '#888888';
                    // Îëê Í∞úÏùò ÏÑ∏Î°ú ÎßâÎåÄ (pause icon)
                    ctx.fillRect(-size * 0.15, -size * 0.2, size * 0.1, size * 0.4);
                    ctx.fillRect(size * 0.05, -size * 0.2, size * 0.1, size * 0.4);
                    break;
                case 'scatter':
                    // ÎπÑÏÇ∞ÌÉÑ: 4Î∞©Ìñ• ÌôîÏÇ¥Ìëú
                    ctx.fillStyle = '#ffaa00';
                    for (let i = 0; i < 4; i++) {
                        const angle = (i * Math.PI * 2 / 4) - Math.PI / 2;
                        const x = Math.cos(angle) * size * 0.25;
                        const y = Math.sin(angle) * size * 0.25;
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle);
                        ctx.beginPath();
                        ctx.moveTo(0, -size * 0.15);
                        ctx.lineTo(-size * 0.08, -size * 0.05);
                        ctx.lineTo(0, 0);
                        ctx.lineTo(size * 0.08, -size * 0.05);
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore();
                    }
                    break;
                case 'rocket':
                    // Î°úÏºìÌÉÑ: Î°úÏºì Î™®Ïñë
                    ctx.fillStyle = '#ff6600';
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.4);
                    ctx.lineTo(-size * 0.2, size * 0.2);
                    ctx.lineTo(0, size * 0.3);
                    ctx.lineTo(size * 0.2, size * 0.2);
                    ctx.closePath();
                    ctx.fill();
                    // Î∂àÍΩÉ
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.15, size * 0.3);
                    ctx.lineTo(-size * 0.05, size * 0.4);
                    ctx.lineTo(0, size * 0.35);
                    ctx.lineTo(size * 0.05, size * 0.4);
                    ctx.lineTo(size * 0.15, size * 0.3);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'trinity':
                    // ÏÇºÏúÑÏùºÏ≤¥: ÏÑ∏ Í∞úÏùò ÏõêÏù¥ Ïó∞Í≤∞Îêú Î™®Ïñë (ÏÇºÍ∞ÅÌòï Î∞∞Ïπò)
                    ctx.fillStyle = '#9b59b6'; // Î≥¥ÎùºÏÉâ
                    ctx.shadowColor = '#9b59b6';
                    // ÏúÑÏ™Ω Ïõê
                    ctx.beginPath();
                    ctx.arc(0, -size * 0.2, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    // ÏôºÏ™Ω ÏïÑÎûò Ïõê
                    ctx.beginPath();
                    ctx.arc(-size * 0.2, size * 0.2, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    // Ïò§Î•∏Ï™Ω ÏïÑÎûò Ïõê
                    ctx.beginPath();
                    ctx.arc(size * 0.2, size * 0.2, size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    // Ïó∞Í≤∞ÏÑ†
                    ctx.strokeStyle = '#9b59b6';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, -size * 0.05);
                    ctx.lineTo(-size * 0.2, size * 0.05);
                    ctx.moveTo(0, -size * 0.05);
                    ctx.lineTo(size * 0.2, size * 0.05);
                    ctx.moveTo(-size * 0.2, size * 0.05);
                    ctx.lineTo(size * 0.2, size * 0.05);
                    ctx.stroke();
                    break;
                case 'judgment':
                    // ÏÑ†Í≥†: Ï∂©Í≤©Ìåå Î™®Ïñë (ÏõêÌòï ÌååÎèô)
                    ctx.strokeStyle = '#ff4444'; // Îπ®Í∞ÑÏÉâ
                    ctx.shadowColor = '#ff4444';
                    ctx.lineWidth = 3;
                    // Î∞îÍπ•Ï™Ω Ïõê
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.35, 0, Math.PI * 2);
                    ctx.stroke();
                    // Ï§ëÍ∞Ñ Ïõê
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.25, 0, Math.PI * 2);
                    ctx.stroke();
                    // ÏïàÏ™Ω Ïõê
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.15, 0, Math.PI * 2);
                    ctx.stroke();
                    // Ï§ëÏïô ÌôîÏÇ¥Ìëú (Î∞ÄÏñ¥ÎÇ¥Îäî Î∞©Ìñ•)
                    ctx.fillStyle = '#ff4444';
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(size * 0.2, -size * 0.15);
                    ctx.lineTo(size * 0.15, -size * 0.1);
                    ctx.lineTo(size * 0.25, -size * 0.1);
                    ctx.lineTo(size * 0.25, -size * 0.2);
                    ctx.lineTo(size * 0.35, 0);
                    ctx.lineTo(size * 0.25, size * 0.2);
                    ctx.lineTo(size * 0.25, size * 0.1);
                    ctx.lineTo(size * 0.15, size * 0.1);
                    ctx.lineTo(size * 0.2, size * 0.15);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'boomerang':
                    // Î∂ÄÎß§Îûë: Î∂ÄÎ©îÎûë Î™®Ïñë (Í≥°ÏÑ† ÌôîÏÇ¥Ìëú)
                    ctx.strokeStyle = '#00aaff'; // ÌïòÎäòÏÉâ
                    ctx.shadowColor = '#00aaff';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    // Î∂ÄÎ©îÎûë Î≥∏Ï≤¥ (Í≥°ÏÑ†)
                    ctx.beginPath();
                    ctx.arc(0, 0, size * 0.3, -Math.PI * 0.3, Math.PI * 1.3);
                    ctx.stroke();
                    // ÌôîÏÇ¥Ìëú Î®∏Î¶¨ (ÎêòÎèåÏïÑÏò§Îäî Î∞©Ìñ•)
                    ctx.fillStyle = '#00aaff';
                    ctx.beginPath();
                    ctx.moveTo(size * 0.25, -size * 0.15);
                    ctx.lineTo(size * 0.35, -size * 0.25);
                    ctx.lineTo(size * 0.3, -size * 0.2);
                    ctx.lineTo(size * 0.4, -size * 0.15);
                    ctx.lineTo(size * 0.3, -size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    // Î∞òÎåÄ Î∞©Ìñ• ÌôîÏÇ¥Ìëú (ÎèåÏïÑÏò§Îäî Î∞©Ìñ•)
                    ctx.beginPath();
                    ctx.moveTo(-size * 0.25, size * 0.15);
                    ctx.lineTo(-size * 0.35, size * 0.25);
                    ctx.lineTo(-size * 0.3, size * 0.2);
                    ctx.lineTo(-size * 0.4, size * 0.15);
                    ctx.lineTo(-size * 0.3, size * 0.1);
                    ctx.closePath();
                    ctx.fill();
                    break;
                default:
                    // Í∏∞Î≥∏: ÏÇ¨Í∞ÅÌòï
                    ctx.fillStyle = '#888888';
                    ctx.fillRect(-size * 0.3, -size * 0.3, size * 0.6, size * 0.6);
            }
            
            ctx.restore();
        }

        // Ï¶ùÍ∞ï ÏïÑÏù¥ÏΩò Î™©Î°ù Í∑∏Î¶¨Í∏∞
        function drawAugmentIcons(character, x, y, align = 'left') {
            const iconSize = 32; // 2Î∞∞ Ï¶ùÍ∞Ä (16 -> 32)
            const spacing = 8; // Í∞ÑÍ≤©ÎèÑ 2Î∞∞ Ï¶ùÍ∞Ä
            const bgSize = iconSize + 4; // Î∞∞Í≤Ω ÌÅ¨Í∏∞
            
            // ÎßàÏö∞Ïä§ Ìò∏Î≤Ñ Í∞êÏßÄ
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseCanvasX = (mouse.x - rect.left) * scaleX;
            const mouseCanvasY = (mouse.y - rect.top) * scaleY;
            
            character.augmentations.forEach((aug, index) => {
                let iconX;
                if (align === 'right') {
                    iconX = x - (character.augmentations.length - index - 1) * (iconSize + spacing) - iconSize / 2;
                } else {
                    iconX = x + index * (iconSize + spacing) + iconSize / 2;
                }
                
                // ÎßàÏö∞Ïä§ Ìò∏Î≤Ñ Ï≤¥ÌÅ¨
                const iconLeft = iconX - bgSize / 2;
                const iconRight = iconX + bgSize / 2;
                const iconTop = y - bgSize / 2;
                const iconBottom = y + bgSize / 2;
                
                if (mouseCanvasX >= iconLeft && mouseCanvasX <= iconRight &&
                    mouseCanvasY >= iconTop && mouseCanvasY <= iconBottom) {
                    hoveredAugment = {
                        aug: aug,
                        x: iconX,
                        y: y
                    };
                }
                
                // Î∞∞Í≤Ω ÏÇ¨Í∞ÅÌòï (Ìò∏Î≤Ñ Ïãú Í∞ïÏ°∞)
                if (hoveredAugment && hoveredAugment.aug === aug) {
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                } else {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                }
                ctx.fillRect(iconX - bgSize / 2, y - bgSize / 2, bgSize, bgSize);
                
                // ÏïÑÏù¥ÏΩò Í∑∏Î¶¨Í∏∞
                drawAugmentIcon(ctx, iconX, y, iconSize, aug.id);
            });
        }

        // ÌÉÑÌôòÏàò ÌëúÏãú (Ï≤¥Î†• ÏïÑÎûò - ÌïòÏñÄÏÉâ Ïõê)
        function drawAmmoCount(character, x, y, align = 'left') {
            const circleSize = 12; // Ï≤¥Î†•Î∞î(30px)Î≥¥Îã§ Îçî ÏûëÏùÄ Ïõê
            const spacing = 4;
            const radius = circleSize / 2;
            const centerY = y + radius; // ÏõêÏùò Ï§ëÏã¨ Y Ï¢åÌëú
            
            // Ï¥ù ÌÉÑÌôòÏàòÎßåÌÅº Ïõê Í∑∏Î¶¨Í∏∞ (ÏÇ¨Ïö©Ìïú ÌÉÑÌôòÏùÄ Î∞òÌà¨Î™Ö)
            for (let i = 0; i < character.maxAmmo; i++) {
                ctx.save();
                if (i < character.ammo) {
                    // ÎÇ®ÏùÄ ÌÉÑÌôò: Î∂àÌà¨Î™Ö ÌïòÏñÄÏÉâ + ÎÑ§Ïò® Ìö®Í≥º
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#ffffff';
                    ctx.fillStyle = '#ffffff'; // ÌååÏä§ÌÖî ÌôîÏù¥Ìä∏
                } else {
                    // ÏÇ¨Ïö©Ìïú ÌÉÑÌôò: Î∞òÌà¨Î™Ö
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                }
                
                let centerX;
                if (align === 'right') {
                    // Ïò§Î•∏Ï™Ω Ï†ïÎ†¨: Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞ ÏôºÏ™ΩÏúºÎ°ú
                    centerX = x - (character.maxAmmo - i - 1) * (circleSize + spacing) - radius;
                } else {
                    // ÏôºÏ™Ω Ï†ïÎ†¨: ÏôºÏ™ΩÎ∂ÄÌÑ∞ Ïò§Î•∏Ï™ΩÏúºÎ°ú
                    centerX = x + i * (circleSize + spacing) + radius;
                }
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // ÎßàÎ¶ÑÎ™® Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
        function drawDiamond(x, y, size, color) {
            ctx.save();
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x, y - size / 2); // ÏúÑ
            ctx.lineTo(x + size / 2, y); // Ïò§Î•∏Ï™Ω
            ctx.lineTo(x, y + size / 2); // ÏïÑÎûò
            ctx.lineTo(x - size / 2, y); // ÏôºÏ™Ω
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌëúÏãú (ÎßàÎ¶ÑÎ™® ÏïÑÎûò)
        function drawCountdown() {
            const countdownValue = gameState.countdown > 0 ? gameState.countdown : gameState.augmentCountdown;
            if (countdownValue <= 0) return;
            
            ctx.save();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.font = 'bold 72px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const y = 100; // ÎßàÎ¶ÑÎ™® ÏïÑÎûò
            
            // Î∞òÌà¨Î™Ö Î∞∞Í≤Ω
            const textWidth = ctx.measureText(countdownValue).width;
            const padding = 30;
            ctx.fillRect(
                canvas.width / 2 - textWidth / 2 - padding,
                y - 50,
                textWidth + padding * 2,
                100
            );
            
            // Ïà´Ïûê ÌëúÏãú (ÎÑ§Ïò® Ìö®Í≥º)
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ffffff';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(countdownValue, canvas.width / 2, y);
            ctx.restore();
        }

        // ÏäπÎ¶¨ ÌëúÏãú ÎßàÎ¶ÑÎ™® Í∑∏Î¶¨Í∏∞ (ÌôîÎ©¥ ÏúÑÏ™Ω Í∞ÄÏö¥Îç∞)
        function drawWinIndicators() {
            const diamondSize = 20;
            const spacing = 5;
            const groupSpacing = 15; // Í∑∏Î£π ÏÇ¨Ïù¥ Í∞ÑÍ≤© (ÏñáÏùÄ ÏÑ† Ìè¨Ìï®)
            const diamondsPerGroup = 5;
            
            // Ï≤´ Î≤àÏß∏ Í∑∏Î£π ÎÑàÎπÑ Í≥ÑÏÇ∞
            const groupWidth = (diamondsPerGroup * diamondSize) + ((diamondsPerGroup - 1) * spacing);
            // Ï†ÑÏ≤¥ ÎÑàÎπÑ Í≥ÑÏÇ∞ (Îëê Í∑∏Î£π + Í∑∏Î£π ÏÇ¨Ïù¥ Í∞ÑÍ≤©)
            const totalWidth = (groupWidth * 2) + groupSpacing;
            const startX = (canvas.width - totalWidth) / 2;
            const y = 35; // ÏÇ¥Ïßù ÏïÑÎûòÎ°ú ÎÇ¥Î¶º

            // ÏôºÏ™Ω Í∑∏Î£π: ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨ (ÌååÎûÄÏÉâ)
            for (let i = 0; i < diamondsPerGroup; i++) {
                let color;
                if (i < gameState.playerWins) {
                    // ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨: ÌååÎûÄÏÉâ
                    color = 'rgba(74, 158, 255, 0.8)';
                } else {
                    // ÏïÑÏßÅ ÏßÑÌñâÎêòÏßÄ ÏïäÏùÄ ÎùºÏö¥Îìú: Î∞òÌà¨Î™Ö ÌöåÏÉâ
                    color = 'rgba(255, 255, 255, 0.2)';
                }
                
                const x = startX + i * (diamondSize + spacing) + diamondSize / 2;
                drawDiamond(x, y, diamondSize, color);
            }
            
            // Ïò§Î•∏Ï™Ω Í∑∏Î£π: AI ÏäπÎ¶¨ (Îπ®Í∞ÑÏÉâ) - Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞ Ï±ÑÏõåÏßê
            for (let i = 0; i < diamondsPerGroup; i++) {
                let color;
                // Ïò§Î•∏Ï™ΩÎ∂ÄÌÑ∞ Ï±ÑÏö∞Í∏∞ ÏúÑÌï¥ Ïó≠ÏàúÏúºÎ°ú Í≥ÑÏÇ∞
                if ((diamondsPerGroup - 1 - i) < gameState.enemyWins) {
                    // AI ÏäπÎ¶¨: Îπ®Í∞ÑÏÉâ
                    color = 'rgba(233, 69, 96, 0.8)';
                } else {
                    // ÏïÑÏßÅ ÏßÑÌñâÎêòÏßÄ ÏïäÏùÄ ÎùºÏö¥Îìú: Î∞òÌà¨Î™Ö ÌöåÏÉâ
                    color = 'rgba(255, 255, 255, 0.2)';
                }
                
                const x = startX + groupWidth + groupSpacing + i * (diamondSize + spacing) + diamondSize / 2;
                drawDiamond(x, y, diamondSize, color);
            }
            
            // Í∑∏Î£π ÏÇ¨Ïù¥ ÏñáÏùÄ ÏÑ† Í∑∏Î¶¨Í∏∞
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 1;
            const lineX = startX + groupWidth + groupSpacing / 2;
            ctx.beginPath();
            ctx.moveTo(lineX, y - diamondSize / 2 - 5);
            ctx.lineTo(lineX, y + diamondSize / 2 + 5);
            ctx.stroke();
            ctx.restore();
        }

        // Ïû¨Ïû•Ï†Ñ ÏßÑÌñâÎ•† Î∞î Í∑∏Î¶¨Í∏∞ (ÎèôÍ∑∏ÎûÄ Î∞îÎ°ú)
        function drawReloadBar(character, x, y) {
            if (!character.isReloading) return;
            
            const now = Date.now();
            const elapsed = now - character.reloadStartTime;
            const progress = Math.min(elapsed / character.reloadTime, 1); // 0~1 ÏÇ¨Ïù¥ Í∞í
            
            const radius = 8; // ÏõêÏùò Î∞òÏßÄÎ¶Ñ (20% Ï§ÑÏûÑ: 10 -> 8)
            const lineWidth = 4; // ÏÑ† ÎëêÍªò (30% ÎäòÎ¶º: 3 -> 4)
            
            ctx.save();
            // Î∞∞Í≤Ω Ïõê (ÌöåÏÉâ)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = lineWidth;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ÏßÑÌñâÎ•† Ïõê (ÌïòÏñÄÏÉâ + ÎÑ§Ïò® Ìö®Í≥º)
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ffffff';
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.arc(x, y, radius, -Math.PI / 2, -Math.PI / 2 + (progress * Math.PI * 2));
            ctx.stroke();
            ctx.restore();
        }

        // Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
        // Í≤åÏûÑ ÏãúÏûë Ìï®ÏàòÎì§
        // Î≥∏ Ï¶ùÍ∞ï Î™©Î°ù Í¥ÄÎ¶¨ (localStorage ÏÇ¨Ïö©)
        function getSeenAugments() {
            const seen = localStorage.getItem('seenAugments');
            return seen ? JSON.parse(seen) : [];
        }

        function markAugmentAsSeen(augmentId) {
            const seen = getSeenAugments();
            if (!seen.includes(augmentId)) {
                seen.push(augmentId);
                localStorage.setItem('seenAugments', JSON.stringify(seen));
            }
        }

        // Ï¶ùÍ∞ï ÏÑ†ÌÉù ÌöüÏàò Í¥ÄÎ¶¨ (localStorage ÏÇ¨Ïö©)
        function getAugmentSelectCounts() {
            const counts = localStorage.getItem('augmentSelectCounts');
            return counts ? JSON.parse(counts) : {};
        }

        function incrementAugmentSelectCount(augmentId) {
            const counts = getAugmentSelectCounts();
            counts[augmentId] = (counts[augmentId] || 0) + 1;
            localStorage.setItem('augmentSelectCounts', JSON.stringify(counts));
        }

        function getAugmentSelectCount(augmentId) {
            const counts = getAugmentSelectCounts();
            return counts[augmentId] || 0;
        }

        // ÎèÑÍ∞ê Î™®Îã¨ Ïó¥Í∏∞
        function openCollectionModal() {
            // Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞
            collapseModeSelection();
            
            const modal = document.getElementById('collectionModal');
            const content = document.getElementById('collectionContent');
            const seenAugments = getSeenAugments();
            const canvas = document.getElementById('gameCanvas');
            
            content.innerHTML = '';
            
            augmentations.forEach(aug => {
                const isSeen = seenAugments.includes(aug.id);
                const selectCount = getAugmentSelectCount(aug.id);
                const item = document.createElement('div');
                item.className = 'collection-item' + (isSeen ? '' : ' locked');
                item.innerHTML = `
                    ${selectCount > 0 ? `<span class="select-count">${selectCount}Ìöå ÏÑ†ÌÉù</span>` : ''}
                    <h4>${isSeen ? aug.name : '???'}</h4>
                    <p>${isSeen ? aug.description : '??? (ÏïÑÏßÅ Î∞úÍ≤¨ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§)'}</p>
                `;
                content.appendChild(item);
            });
            
            // Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶≠ Ï∞®Îã®
            if (canvas) {
                canvas.style.pointerEvents = 'none';
            }
            
            modal.style.display = 'block';
        }

        // ÎèÑÍ∞ê Î™®Îã¨ Îã´Í∏∞
        function closeCollectionModal() {
            const modal = document.getElementById('collectionModal');
            const canvas = document.getElementById('gameCanvas');
            
            modal.style.display = 'none';
            
            // Í≤åÏûÑ Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶≠ Î≥µÍµ¨
            if (canvas) {
                canvas.style.pointerEvents = 'auto';
            }
        }

        // Ï°∞ÏûëÎ≤ï Î™®Îã¨ Ïó¥Í∏∞
        function openControlsModal() {
            // Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞
            collapseModeSelection();
            
            const modal = document.getElementById('controlsModal');
            modal.style.display = 'block';
            }

        // Ï°∞ÏûëÎ≤ï Î™®Îã¨ Îã´Í∏∞
        function closeControlsModal() {
            const modal = document.getElementById('controlsModal');
            modal.style.display = 'none';
        }


        // Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞ Ìï®Ïàò
        function collapseModeSelection() {
            const modeSelection = document.getElementById('modeSelection');
            if (modeSelection.classList.contains('expanded')) {
                modeSelection.classList.remove('expanded');
                // Î©ÄÌã∞ ÌîåÎ†àÏù¥ ÏõêÎûò ÏúÑÏπòÎ°ú
                document.getElementById('multiPlayText').classList.remove('moved-down');
            }
        }

        function showModeSelection() {
            const modeSelection = document.getElementById('modeSelection');
            const isExpanded = modeSelection.classList.contains('expanded');
            
            if (isExpanded) {
                // Ï†ëÍ∏∞: Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
                collapseModeSelection();
            } else {
                // ÌéºÏπòÍ∏∞: Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú
                modeSelection.classList.add('expanded');
                // Î©ÄÌã∞ ÌîåÎ†àÏù¥Îßå ÎÇ¥Î¶¨Í∏∞
                document.getElementById('multiPlayText').classList.add('moved-down');
                // ÎÇòÎ®∏ÏßÄ Î©îÎâ¥Îäî ÏõêÎûò ÏúÑÏπò Ïú†ÏßÄ
                document.getElementById('collectionText').classList.remove('moved-down');
                document.getElementById('settingsText').classList.remove('moved-down');
                document.getElementById('controlsText').classList.remove('moved-down');
            }
        }

        // ÎûúÎç§ Î™®Îìú Ï†ïÏùò
        const randomModes = [
            {
                id: 'doubleAugment',
                name: '2XÎ™®Îìú',
                description: 'Ï¶ùÍ∞ïÏùÑ 2Í∞úÏî© ÏÑ†ÌÉùÌï©ÎãàÎã§'
            },
            {
                id: 'hp1',
                name: 'HP1Î™®Îìú',
                description: 'Ï¥àÍ∏∞ ÏµúÎåÄÏ≤¥Î†•Ïù¥ 1Ïù¥ Îê©ÎãàÎã§'
            },
            {
                id: 'movingWork',
                name: 'Î¨¥ÎπôÏõåÌÅ¨Î™®Îìú',
                description: 'Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä 5Ï¥àÎßàÎã§ Î∞îÎÄåÎäî Î∞©Ìñ•ÏúºÎ°ú Ï¥àÎãπ 25pxÏî© Ïù¥ÎèôÌï©ÎãàÎã§'
            },
            {
                id: 'turtle',
                name: 'Í±∞Î∂ÅÏù¥Î™®Îìú',
                description: 'Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Ïùò Ïù¥ÎèôÏÜçÎèÑÍ∞Ä 50% Í∞êÏÜåÌï©ÎãàÎã§'
            },
            {
                id: 'flame',
                name: 'Ïö©ÏïîÎ™®Îìú',
                description: 'Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä 5Ï¥àÎßàÎã§ 0.5 Îç∞ÎØ∏ÏßÄÎ•º ÏûÖÏäµÎãàÎã§'
            },
            {
                id: 'noReload',
                name: 'Î¶¨Î°úÎìú!Î™®Îìú',
                description: 'Ïû¨Ïû•Ï†Ñ ÏãúÍ∞ÑÏù¥ 0.3Ï¥àÍ∞Ä Îê©ÎãàÎã§'
            },
            {
                id: 'melee',
                name: 'Í∑ºÏ†ëÏ†ÑÎ™®Îìú',
                description: 'Î™®Îì† Ï¥ùÏïåÏù¥ 500pxÍπåÏßÄÎßå Î∞úÏÇ¨Îê©ÎãàÎã§'
            },
            {
                id: 'smallMap',
                name: '-25%Î™®Îìú',
                description: 'Îßµ ÌÅ¨Í∏∞Í∞Ä 25% Ï§ÑÏñ¥Îì≠ÎãàÎã§'
            },
            {
                id: 'ice',
                name: 'ÎπôÌåêÎ™®Îìú',
                description: 'Î™®Îì† ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ïù¥ÎèôÎ∞©Ìñ•ÏúºÎ°ú ÎØ∏ÎÅÑÎü¨ÏßëÎãàÎã§'
            },
            {
                id: 'superAI',
                name: 'ÏäàÌçºAIÎ™®Îìú',
                description: 'AIÍ∞Ä Ï¶ùÍ∞ïÏùÑ ÎûúÎç§ÏúºÎ°ú 2Í∞ú ÏÑ†ÌÉùÌïòÍ≥† Í≤åÏûÑÏùÑ ÏãúÏûëÌï©ÎãàÎã§'
            }
        ];

        function startSoloGame(mode) {
            // Î™®Îìú ÏÑ†ÌÉù Ï†ëÍ∏∞
            collapseModeSelection();
            
            gameState.gameMode = mode || 'classic'; // 'classic' ÎòêÎäî 'random'
            
            // ÎûúÎç§ Î™®ÎìúÏù∏ Í≤ΩÏö∞ Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë (ÏãúÍ∞Ñ Î©àÏ∂îÍ∏∞)
            if (mode === 'random') {
                gameState.isPaused = true; // Ïä¨Î°ØÎ®∏Ïã† Ï§ë ÏãúÍ∞Ñ Î©àÏ∂îÍ∏∞
                gameState.isSlotMachine = true;
                gameState.slotMachineStartTime = Date.now();
                gameState.slotMachineCurrentIndex = 0;
                gameState.slotMachineSelectedMode = null;
                gameState.selectedRandomMode = null; // ÏïÑÏßÅ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå
            } else {
                gameState.selectedRandomMode = null;
                gameState.isSlotMachine = false;
            }
            
            gameState.isMenu = false;
            document.getElementById('mainMenu').style.display = 'none';
            initGame();
        }

        // ÎûúÎç§ Î™®Îìú Ï†ÅÏö© Ìï®Ïàò
        function applyRandomMode(modeId) {
            switch(modeId) {
                case 'hp1':
                    // HP1Î™®Îìú: ÏµúÎåÄÏ≤¥Î†• 1Î°ú ÏãúÏûë
                    player.maxHealth = 1;
                    player.health = 1;
                    player.displayHealth = 1;
                    enemy.maxHealth = 1;
                    enemy.health = 1;
                    break;
                case 'turtle':
                    // Í±∞Î∂ÅÏù¥Î™®Îìú: Ïù¥ÎèôÏÜçÎèÑ 50% Í∞êÏÜå
                    player.speed *= 0.5;
                    enemy.speed *= 0.5;
                    break;
                case 'noReload':
                    // ÎÖ∏Î¶¨Î°úÎìúÎ™®Îìú: Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ 0.3Ï¥à
                    player.reloadTime = 300;
                    player.baseReloadTime = 300; // Reload! Î™®Îìú: Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ 0.3Ï¥à
                    enemy.reloadTime = 300;
                    enemy.baseReloadTime = 300; // Reload! Î™®Îìú: Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ 0.3Ï¥à
                    break;
                case 'smallMap':
                    // -25%Î™®Îìú: Îßµ ÌÅ¨Í∏∞ 25% Í∞êÏÜå
                    const mapScale = 0.75;
                    const mapWidth = canvas.width * mapScale;
                    const mapHeight = canvas.height * mapScale;
                    const mapOffsetX = (canvas.width - mapWidth) / 2;
                    const mapOffsetY = (canvas.height - mapHeight) / 2;
                    
                    gameState.mapBounds.minX = mapOffsetX;
                    gameState.mapBounds.minY = mapOffsetY;
                    gameState.mapBounds.maxX = mapOffsetX + mapWidth;
                    gameState.mapBounds.maxY = mapOffsetY + mapHeight;
                    
                    // ÌîåÎ†àÏù¥Ïñ¥ÏôÄ Ï†Å ÏúÑÏπòÎ•º Ï§ÑÏñ¥Îì† Îßµ ÏïàÏúºÎ°ú Ï°∞Ï†ï
                    player.x = Math.max(gameState.mapBounds.minX + player.radius, 
                                      Math.min(gameState.mapBounds.maxX - player.radius, player.x));
                    player.y = Math.max(gameState.mapBounds.minY + player.radius, 
                                      Math.min(gameState.mapBounds.maxY - player.radius, player.y));
                    enemy.x = Math.max(gameState.mapBounds.minX + enemy.radius, 
                                     Math.min(gameState.mapBounds.maxX - enemy.radius, enemy.x));
                    enemy.y = Math.max(gameState.mapBounds.minY + enemy.radius, 
                                     Math.min(gameState.mapBounds.maxY - enemy.radius, enemy.y));
                    break;
                case 'superAI':
                    // ÏäàÌçºAIÎ™®Îìú: AIÍ∞Ä Ï¶ùÍ∞ï 2Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
                    const availableAugments = augmentations.filter(aug => aug.id !== 'dodge' && aug.id !== 'fortify' && aug.id !== 'timeStop');
                    const shuffled = [...availableAugments].sort(() => Math.random() - 0.5);
                    // 2Í∞ú ÏÑ†ÌÉù
                    for (let i = 0; i < 2 && i < shuffled.length; i++) {
                        const selectedAugment = shuffled[i];
                        selectedAugment.effect(enemy);
                        enemy.augmentations.push(selectedAugment);
                        incrementAugmentSelectCount(selectedAugment.id);
                    }
                    break;
            }
        }

        function initGame() {
            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ïû¨ÌôïÏù∏
            resizeCanvas();
            
            // Îßµ Í≤ΩÍ≥Ñ Ï¥àÍ∏∞Ìôî (Ï†ÑÏ≤¥ Ï∫îÎ≤ÑÏä§)
            gameState.mapBounds.minX = 0;
            gameState.mapBounds.minY = 0;
            gameState.mapBounds.maxX = canvas.width;
            gameState.mapBounds.maxY = canvas.height;
            
            // Îßµ Í≤ΩÍ≥Ñ Ï¥àÍ∏∞Ìôî (Ï†ÑÏ≤¥ Ï∫îÎ≤ÑÏä§)
            gameState.mapBounds.minX = 0;
            gameState.mapBounds.minY = 0;
            gameState.mapBounds.maxX = canvas.width;
            gameState.mapBounds.maxY = canvas.height;
            
            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            gameState.round = 1;
            gameState.playerWins = 0;
            gameState.enemyWins = 0;
            gameState.gameTime = 180;
            gameState.isGameOver = false;
            gameState.isPaused = true;
            gameState.countdown = 3;
            gameState.roundWins = [];
            gameState.augmentCountdown = 0;
            gameState.showOpponentSelecting = false;

            // ÎûúÎç§ Î™®Îìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (Ïä¨Î°ØÎ®∏Ïã† Ï§ëÏù¥ ÏïÑÎãê ÎïåÎßå)
            if (!gameState.isSlotMachine) {
                const randomModeDisplay = document.getElementById('randomModeDisplay');
                const randomModeName = document.getElementById('randomModeName');
                const randomModeTooltip = document.getElementById('randomModeTooltip');
                
                if (gameState.selectedRandomMode) {
                    randomModeDisplay.style.display = 'block';
                    randomModeName.textContent = gameState.selectedRandomMode.name;
                    randomModeTooltip.textContent = gameState.selectedRandomMode.description;
                    
                } else {
                    randomModeDisplay.style.display = 'none';
                }
            }

            // ÌîåÎ†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
            player.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.2;
            player.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
            player.health = 5;
            player.displayHealth = 5;
            player.maxHealth = 5;
            player.ammo = 6;
            player.maxAmmo = 6;
            player.bullets = [];
            player.augmentations = [];
            player.angle = 0;
            player.bulletSpeedMultiplier = 1;
            player.bulletSizeMultiplier = 1;
            player.speed = 3; // Í∏∞Î≥∏ ÏÜçÎèÑ ÏÑ§Ï†ï
            player.hasCritical = false;
            player.hasDoubleShot = false;
            player.hasDodge = false;
            player.hasRevive = false;
            player.hasRevived = false;
            player.hasDeepWound = false;
            player.hasOneShotOneKill = false;
            player.hasPoisonBullet = false;
            player.hasReloadHeal = false;
            player.hasSurvivalInstinct = false;
            player.hasLastBullet = false;
            player.hasRecoveryContract = false;
            player.hasRecoveryContractUsed = false;
            player.hasFocusedFire = false;
            player.hasShotgun = false;
            player.hasRagged = false;
            player.hasGhost = false;
            player.hasFortify = false;
            player.isFortified = false;
            player.fortifyStartTime = 0;
            player.lastPosition = { x: player.x, y: player.y };
            player.stationaryTime = 0;
            player.hasOverheat = false;
            player.overheatHitCount = 0;
            player.lastHitTime = 0;
            player.hasGamble = false;
            player.hasWeaken = false;
            player.isWeakened = false;
            player.weakenEndTime = 0;
            player.hasDamageBoost = false;
            player.hasLightning = false;
            player.isStunned = false;
            player.stunEndTime = 0;
            player.hasShield = false;
            player.shieldReady = false;
            player.shieldCooldown = 0;
            player.hasRegeneration = false;
            player.lastRegenTime = 0;
            player.hasEvasiveManeuver = false;
            player.hasCombatExperience = false;
            player.combatExperienceRounds = 0;
            player.hasHallucination = false;
            player.hasTasteOfBlood = false;
            player.hasCannon = false;
            player.hasTimeBarrier = false;
            player.timeBarrierRadius = 150;
            player.hasBouncyBullet = false;
            player.hasGatling = false;
            player.gatlingBullets = 0;
            player.gatlingNextShot = 0;
            player.hasReflect = false;
            player.reflectActive = false;
            player.reflectCooldown = 0;
            player.reflectEndTime = 0;
            player.hasTimeStop = false;
            player.timeStopCooldown = 0;
            player.timeStopActive = false;
            player.timeStopEndTime = 0;
            player.hasScatter = false;
            player.hasGamble2 = false;
            player.hasRocket = false;
            player.hasTrinity = false;
            player.hasJudgment = false;
            player.isJudgmentPushing = false;
            player.judgmentPushStartX = 0;
            player.judgmentPushStartY = 0;
            player.judgmentPushTargetX = 0;
            player.judgmentPushTargetY = 0;
            player.judgmentPushStartTime = 0;
            player.judgmentPushDuration = 0;
            player.hasBoomerang = false;
            player.isVulnerable = false;
            player.vulnerabilityUsed = false;
            player.poisonEffects = [];
            player.isDodging = false;
            player.isReviving = false;
            player.isInvincible = false;
            player.slowEndTime = 0;
            player.damageNumbers = [];
            player.damage = 1;
            player.speed = 3;
            player.reloadTime = 3000;
            player.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
            player.isReloading = false;
            player.reloadStartTime = 0;
            player.shootCooldown = 1000;
            player.lastShot = 0;

            // enemy Ï¥àÍ∏∞Ìôî
                enemy.x = gameState.mapBounds.minX + (gameState.mapBounds.maxX - gameState.mapBounds.minX) * 0.8;
                enemy.y = gameState.mapBounds.minY + (gameState.mapBounds.maxY - gameState.mapBounds.minY) * 0.5;
                enemy.health = 5;
                enemy.displayHealth = 5;
                enemy.maxHealth = 5;
                enemy.ammo = 6;
                enemy.maxAmmo = 6;
                enemy.bullets = [];
                enemy.augmentations = [];
                enemy.angle = Math.PI;
                enemy.bulletSpeedMultiplier = 1;
                enemy.bulletSizeMultiplier = 1;
                enemy.hasCritical = false;
                enemy.hasDoubleShot = false;
                enemy.hasDodge = false;
                enemy.hasRevive = false;
                enemy.hasRevived = false;
                enemy.hasDeepWound = false;
                enemy.hasOneShotOneKill = false;
                enemy.hasPoisonBullet = false;
                enemy.hasReloadHeal = false;
                enemy.hasSurvivalInstinct = false;
                enemy.hasLastBullet = false;
                enemy.hasRecoveryContract = false;
                enemy.hasRecoveryContractUsed = false;
                enemy.hasFocusedFire = false;
            enemy.hasShotgun = false;
            enemy.hasRagged = false;
            enemy.hasGhost = false;
            enemy.hasFortify = false;
            enemy.isFortified = false;
            enemy.fortifyStartTime = 0;
            enemy.lastPosition = { x: enemy.x, y: enemy.y };
            enemy.stationaryTime = 0;
            enemy.hasOverheat = false;
            enemy.overheatHitCount = 0;
            enemy.lastHitTime = 0;
            enemy.hasGamble = false;
            enemy.hasWeaken = false;
            enemy.isWeakened = false;
            enemy.weakenEndTime = 0;
            enemy.hasDamageBoost = false;
            enemy.hasLightning = false;
            enemy.isStunned = false;
            enemy.stunEndTime = 0;
            enemy.hasShield = false;
            enemy.shieldReady = false;
            enemy.shieldCooldown = 0;
            enemy.hasRegeneration = false;
            enemy.lastRegenTime = 0;
            enemy.hasEvasiveManeuver = false;
            enemy.hasCombatExperience = false;
            enemy.combatExperienceRounds = 0;
            enemy.hasHallucination = false;
            enemy.hasTasteOfBlood = false;
            enemy.hasCannon = false;
            enemy.hasTimeBarrier = false;
            enemy.timeBarrierRadius = 150;
            enemy.hasBouncyBullet = false;
                enemy.isVulnerable = false;
                enemy.vulnerabilityUsed = false;
                enemy.poisonEffects = [];
                enemy.isDodging = false;
                enemy.isReviving = false;
                enemy.isInvincible = false;
                enemy.slowEndTime = 0;
                enemy.damageNumbers = [];
                enemy.usePrediction = false;
                enemy.lastPlayerX = 0;
                enemy.lastPlayerY = 0;
                enemy.playerVelocity = { x: 0, y: 0 };
                enemy.damage = 1;
                enemy.speed = 2.5; // Í∏∞Î≥∏ ÏÜçÎèÑ ÏÑ§Ï†ï
            enemy.reloadTime = 3000;
                enemy.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
                enemy.isReloading = false;
                enemy.reloadStartTime = 0;
                enemy.shootCooldown = 1000;
                enemy.lastShot = 0;
                
                // Î™®ÎìúÎ≥Ñ Ï¥àÍ∏∞Ìôî (ÏÜçÎèÑ ÏÑ§Ï†ï ÌõÑÏóê Ï†ÅÏö©)
                if (gameState.selectedRandomMode) {
                    applyRandomMode(gameState.selectedRandomMode.id);
                }

            // Ï≤´ ÎùºÏö¥Îìú Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë (ÎûúÎç§ Î™®ÎìúÏù¥Í≥† Ïä¨Î°ØÎ®∏Ïã† Ï§ëÏù¥Î©¥ Ïä¨Î°ØÎ®∏Ïã†Ïù¥ ÎÅùÎÇú ÌõÑ ÏãúÏûë)
            if (gameState.gameMode !== 'random' || !gameState.isSlotMachine) {
                const initialCountdown = setInterval(() => {
                    gameState.countdown--;
                    if (gameState.countdown <= 0) {
                        clearInterval(initialCountdown);
                        gameState.isPaused = false;
                    }
                }, 1000);
            }
        }

        function draw() {
            // Î©îÎâ¥ ÌôîÎ©¥ ÌëúÏãú
            if (gameState.isMenu) {
                return; // Î©îÎâ¥Îäî HTMLÎ°ú ÌëúÏãúÎêòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Í∑∏Î¶¨ÏßÄ ÏïäÏùå
            }

            // Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÏùº ÎïåÎäî Ïä¨Î°ØÎ®∏Ïã†Îßå Í∑∏Î¶¨Í∏∞
            if (gameState.isSlotMachine) {
                ctx.fillStyle = '#0f0f1e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò Í∑∏Î¶¨Í∏∞
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                // ÌòÑÏû¨ ÌëúÏãúÌï† Î™®Îìú
                const currentMode = randomModes[gameState.slotMachineCurrentIndex];
                
                // Î™®Îìú Ïù¥Î¶Ñ ÌëúÏãú
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.font = 'bold 64px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(currentMode.name, centerX, centerY);
                
                // Î™®Îìú ÏÑ§Î™Ö ÌëúÏãú
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.font = '32px Arial';
                ctx.fillText(currentMode.description, centerX, centerY + 60);
                
                return; // Ïä¨Î°ØÎ®∏Ïã† Ï§ëÏóêÎäî ÎÇòÎ®∏ÏßÄ Í≤åÏûÑ ÏöîÏÜå Í∑∏Î¶¨ÏßÄ ÏïäÏùå
            }

            // Ìò∏Î≤ÑÎêú Ï¶ùÍ∞ï Ï¥àÍ∏∞Ìôî
            hoveredAugment = null;
            
            // ÌôîÎ©¥ ÌùîÎì§Î¶º Ï†ÅÏö©
            let shakeX = 0;
            let shakeY = 0;
            if (gameState.shake.duration > 0) {
                shakeX = (Math.random() - 0.5) * gameState.shake.intensity;
                shakeY = (Math.random() - 0.5) * gameState.shake.intensity;
                gameState.shake.duration = Math.max(0, gameState.shake.duration - 16); // ÏïΩ 60fps Í∏∞Ï§Ä
                gameState.shake.intensity *= 0.9; // Ï†êÏßÑÏ†ÅÏúºÎ°ú Í∞êÏÜå
            }

            // Î∞∞Í≤Ω ÌÅ¥Î¶¨Ïñ¥ (ÌùîÎì§Î¶º Ï†ÑÏóê Í∑∏Î¶¨Í∏∞)
            // Ïö©ÏïîÎ™®Îìú: Î∞∞Í≤ΩÏùÑ Î∂âÏùÄ Í≥ÑÏó¥Î°ú Î≥ÄÍ≤Ω
            // ÎπôÌåêÎ™®Îìú: Î∞∞Í≤ΩÏùÑ Ìë∏Î•∏ Í≥ÑÏó¥Î°ú Î≥ÄÍ≤Ω
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'flame') {
                ctx.fillStyle = '#2a0f0f'; // Ïñ¥ÎëêÏö¥ Î∂âÏùÄ Í≥ÑÏó¥
            } else if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'ice') {
                ctx.fillStyle = '#0f1e3a'; // Îçî ÌååÎûÄÏÉâ Ìë∏Î•∏ Í≥ÑÏó¥
            } else {
                ctx.fillStyle = '#0f0f1e';
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ÌôîÎ©¥ ÌùîÎì§Î¶º Ï†ÅÏö©
            ctx.save();
            ctx.translate(shakeX, shakeY);

            // Í≤©Ïûê Í∑∏Î¶¨Í∏∞ (Îßµ Í≤ΩÍ≥Ñ ÎÇ¥Î∂ÄÎßå, Í≤ΩÍ≥ÑÏÑ† Ï†úÏô∏)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            const startX = gameState.mapBounds.minX;
            const startY = gameState.mapBounds.minY;
            const endX = gameState.mapBounds.maxX;
            const endY = gameState.mapBounds.maxY;
            
            // Í≤©Ïûê ÏÑ†Ïù¥ Îßµ Í≤ΩÍ≥ÑÏÑ†Í≥º Í≤πÏπòÏßÄ ÏïäÎèÑÎ°ù Í≤ΩÍ≥ÑÏÑ†ÏùÑ Ï†úÏô∏ÌïòÍ≥† Í∑∏Î¶¨Í∏∞
            const gridStartX = Math.ceil(startX / 50) * 50; // Í≤ΩÍ≥ÑÏÑ† Îã§Ïùå Í≤©ÏûêÎ∂ÄÌÑ∞
            const gridStartY = Math.ceil(startY / 50) * 50;
            const gridEndX = Math.floor(endX / 50) * 50; // Í≤ΩÍ≥ÑÏÑ† Ï†ÑÍπåÏßÄ
            const gridEndY = Math.floor(endY / 50) * 50;
            
            for (let i = gridStartX; i <= gridEndX; i += 50) {
                if (i > startX && i < endX) { // Í≤ΩÍ≥ÑÏÑ† Ï†úÏô∏
                    ctx.beginPath();
                    ctx.moveTo(i, startY);
                    ctx.lineTo(i, endY);
                    ctx.stroke();
                }
            }
            for (let i = gridStartY; i <= gridEndY; i += 50) {
                if (i > startY && i < endY) { // Í≤ΩÍ≥ÑÏÑ† Ï†úÏô∏
                    ctx.beginPath();
                    ctx.moveTo(startX, i);
                    ctx.lineTo(endX, i);
                    ctx.stroke();
                }
            }

            // -25%Î™®Îìú: Ï§ÑÏñ¥Îì† ÏòÅÏó≠ÏùÑ Í≤ÄÏùÄÏÉâÏúºÎ°ú ÌëúÏãú (Í≤©Ïûê Í∑∏Î¶¨Í∏∞ ÌõÑ, Í≤©Ïûê ÏÑ†ÏùÑ ÎçÆÍ∏∞ ÏúÑÌï¥)
            // ÌùîÎì§Î¶ºÏúºÎ°ú Ïù∏Ìïú Ïó¨Ïú† Í≥µÍ∞Ñ Ï∂îÍ∞Ä (ÏµúÎåÄ ÌùîÎì§Î¶º Í∞ïÎèÑ Í≥†Î†§)
            const shakeMargin = 50; // ÌùîÎì§Î¶º Ïó¨Ïú† Í≥µÍ∞Ñ
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'smallMap') {
                ctx.fillStyle = '#000000'; // Í≤ÄÏùÄÏÉâ
                // ÏúÑÏ™Ω ÏòÅÏó≠ (Ïó¨Ïú† Í≥µÍ∞Ñ Ï∂îÍ∞Ä)
                ctx.fillRect(-shakeMargin, -shakeMargin, canvas.width + shakeMargin * 2, gameState.mapBounds.minY + shakeMargin);
                // ÏïÑÎûòÏ™Ω ÏòÅÏó≠ (Ïó¨Ïú† Í≥µÍ∞ÑÏùÄ ÏúÑÏ™ΩÎßå, ÏïÑÎûòÏ™ΩÏùÄ Ï†ïÌôïÌûà Í≤ΩÍ≥ÑÏóêÏÑú ÏãúÏûë)
                ctx.fillRect(-shakeMargin, gameState.mapBounds.maxY, canvas.width + shakeMargin * 2, canvas.height - gameState.mapBounds.maxY);
                // ÏôºÏ™Ω ÏòÅÏó≠ (Ïó¨Ïú† Í≥µÍ∞Ñ Ï∂îÍ∞Ä)
                ctx.fillRect(-shakeMargin, gameState.mapBounds.minY - shakeMargin, gameState.mapBounds.minX + shakeMargin, gameState.mapBounds.maxY - gameState.mapBounds.minY + shakeMargin * 2);
                // Ïò§Î•∏Ï™Ω ÏòÅÏó≠ (Ïó¨Ïú† Í≥µÍ∞ÑÏùÄ ÏôºÏ™ΩÎßå, Ïò§Î•∏Ï™ΩÏùÄ Ï†ïÌôïÌûà Í≤ΩÍ≥ÑÏóêÏÑú ÏãúÏûë)
                ctx.fillRect(gameState.mapBounds.maxX, gameState.mapBounds.minY - shakeMargin, canvas.width - gameState.mapBounds.maxX, gameState.mapBounds.maxY - gameState.mapBounds.minY + shakeMargin * 2);
            }

            // Ï¥ùÏïå Í∑∏Î¶¨Í∏∞
            player.bullets.forEach(bullet => bullet.draw());
            enemy.bullets.forEach(bullet => bullet.draw());

            // Íµ¨Î•¥Í∏∞ ÏûîÏÉÅ Í∑∏Î¶¨Í∏∞
            function drawDodgeTrail(character) {
                if (character.isDodging && character.dodgeTrail && character.dodgeTrail.length > 0) {
                    // ÏûîÏÉÅ Ìö®Í≥º (Í≥ºÍ±∞ ÏúÑÏπò Í∑∏Î¶¨Í∏∞)
                    character.dodgeTrail.forEach((trail, index) => {
                        const fadeAlpha = trail.alpha * (1 - index * 0.2); // Ï†êÏßÑÏ†ÅÏúºÎ°ú Ìà¨Î™Ö
                        ctx.globalAlpha = Math.max(0, fadeAlpha);
                        ctx.fillStyle = character.color;
                        ctx.beginPath();
                        ctx.arc(trail.x, trail.y, character.radius * 0.8, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1.0;
                }
            }

            // ÌÅ¥ÎûòÏãù Î™®Îìú ÎòêÎäî ÎûúÎç§ Î™®ÎìúÏóêÏÑú ÎÑ§Ïò® Ìö®Í≥º Ï∂îÍ∞Ä (Îßµ Í≤ΩÍ≥ÑÏóê ÏûòÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù ÌùîÎì§Î¶º Î≥ÄÌôò Ï†ÑÏóê Í∑∏Î¶¨Í∏∞)
            const isClassicOrRandom = gameState.gameMode === 'classic' || gameState.gameMode === 'random';
            
            // ÎÑ§Ïò® Ìö®Í≥ºÎ•º Î®ºÏ†Ä Í∑∏Î¶¨Í∏∞ (Îßµ Í≤ΩÍ≥ÑÏóê ÏûòÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù)
            if (isClassicOrRandom) {
                // Ï†Å ÎÑ§Ïò® Ìö®Í≥º
                if (enemy.x > -500 && enemy.y > -500) {
                    ctx.save();
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = enemy.color;
                    ctx.globalAlpha = 0.6; // ÎÑ§Ïò® Ìö®Í≥ºÎäî ÏïΩÍ∞Ñ Ìà¨Î™ÖÌïòÍ≤å
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    ctx.restore();
                }
                
                // ÌîåÎ†àÏù¥Ïñ¥ ÎÑ§Ïò® Ìö®Í≥º
                ctx.save();
                ctx.shadowBlur = 20;
                ctx.shadowColor = player.color;
                ctx.globalAlpha = 0.6; // ÎÑ§Ïò® Ìö®Í≥ºÎäî ÏïΩÍ∞Ñ Ìà¨Î™ÖÌïòÍ≤å
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
                ctx.fillStyle = player.color;
                ctx.fill();
                ctx.restore();
            }

            // Ï†Å Í∑∏Î¶¨Í∏∞
            if (enemy.x > -500 && enemy.y > -500) {
                ctx.save();
                ctx.translate(enemy.x, enemy.y);
                ctx.rotate(enemy.angle);
                
                // Í∏∞Î≥∏ alpha ÏÑ§Ï†ï
                ctx.globalAlpha = 1.0;
                
                // Î¨¥Ï†Å ÏÉÅÌÉúÎ©¥ ÍπúÎπ°ÏûÑ Ìö®Í≥º
                if (enemy.isInvincible) {
                    const blink = Math.floor(Date.now() / 100) % 2;
                    if (blink) {
                        ctx.globalAlpha = 0.5;
                    }
                }
                
                // Íµ¨Î•¥Í∏∞ ÏûîÏÉÅ Í∑∏Î¶¨Í∏∞
                if (enemy.dodgeTrail && enemy.dodgeTrail.length > 0) {
                    enemy.dodgeTrail.forEach((trail, index) => {
                        ctx.save();
                        ctx.globalAlpha = trail.alpha * (index / enemy.dodgeTrail.length);
                        ctx.translate(trail.x - enemy.x, trail.y - enemy.y);
                        ctx.beginPath();
                        ctx.arc(0, 0, enemy.radius, 0, Math.PI * 2);
                        ctx.fillStyle = enemy.color;
                        ctx.fill();
                        ctx.restore();
                    });
                }
                
                ctx.beginPath();
                ctx.arc(0, 0, enemy.radius, 0, Math.PI * 2);
                ctx.fillStyle = enemy.color;
                ctx.fill();
                
                // Î∞©Ïñ¥Îßâ: ÏßÑÌïú ÌååÎûÄÏÉâ ÌÖåÎëêÎ¶¨
                if (enemy.hasShield && enemy.shieldReady) {
                    ctx.strokeStyle = '#0066ff'; // ÏßÑÌïú ÌååÎûÄÏÉâ
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
                // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ: ÌïòÏñÄÏÉâ ÌÖåÎëêÎ¶¨
                if (enemy.reflectActive) {
                    ctx.strokeStyle = '#ffffff'; // ÌïòÏñÄÏÉâ
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
                
                // Î¶¨Î≥ºÎ≤Ñ Í∑∏Î¶¨Í∏∞ (ÎÑ§Ïò® Ìö®Í≥º Ï∂îÍ∞Ä)
                ctx.save();
                ctx.shadowBlur = 8;
                ctx.shadowColor = '#333333';
                ctx.fillStyle = '#333'; // ÌååÏä§ÌÖî Í∑∏Î†àÏù¥
                ctx.fillRect(enemy.radius - 7.5, -4.5, 22.5, 9); // 1.5Î∞∞ Ï¶ùÍ∞Ä
                ctx.restore();
                
                ctx.globalAlpha = 1.0; // Î≥µÏõê
                ctx.restore();
                
                // Ï†Å Ï≤¥Î†•Í≥º ÌÉÑÌôòÏàòÎäî UI ÏòÅÏó≠ÏóêÏÑú ÌëúÏãúÎê®
                
                // Ï†Å Ïû¨Ïû•Ï†Ñ Î∞î ÌëúÏãú (Ï†Å Î∞îÎ°ú Ïò§Î•∏Ï™Ω ÏúÑ) - Ï†Å ÏúÑÏπòÏóê ÌùîÎì§Î¶º Ï†ÅÏö©
                if (enemy.isReloading) {
                    drawReloadBar(enemy, enemy.x + 40 + shakeX, enemy.y - 40 + shakeY);
                }
            }

            // ÏãúÍ∞ÑÏû•Îßâ Í∑∏Î¶¨Í∏∞ (ÌîåÎ†àÏù¥Ïñ¥)
            if (player.hasTimeBarrier) {
                ctx.save();
                ctx.globalAlpha = 0.2; // Ìà¨Î™ÖÎèÑÍ∞Ä Í∞ïÌïú Ï¥àÎ°ùÏÉâ
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(player.x + shakeX, player.y + shakeY, player.timeBarrierRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }
            
            // ÏãúÍ∞ÑÏû•Îßâ Í∑∏Î¶¨Í∏∞ (Ï†Å)
            if (enemy.hasTimeBarrier && enemy.x > -500 && enemy.y > -500) {
                ctx.save();
                ctx.globalAlpha = 0.2; // Ìà¨Î™ÖÎèÑÍ∞Ä Í∞ïÌïú Ï¥àÎ°ùÏÉâ
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(enemy.x + shakeX, enemy.y + shakeY, enemy.timeBarrierRadius, 0, Math.PI * 2);
                ctx.stroke();
                ctx.restore();
            }

            // ÌîåÎ†àÏù¥Ïñ¥ Í∑∏Î¶¨Í∏∞
            drawDodgeTrail(player);
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle);
            
            // Î¨¥Ï†Å ÏÉÅÌÉúÏùº Îïå Î∞òÌà¨Î™Ö
            ctx.globalAlpha = 1.0; // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            if (player.isInvincible || player.isReviving) {
                ctx.globalAlpha = 0.5;
            } else if (player.hasGhost) {
                // Ïú†Î†π Ï¶ùÍ∞ï: ÏÇ¥Ïßù ÌùêÎ†§ÏßÄÍ≤å
                ctx.globalAlpha = 0.7;
            }
            
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
            ctx.fill();
            // Í±∞Ï†êÌôïÎ≥¥: ÌïòÏñÄÏÉâ ÌÖåÎëêÎ¶¨
            if (player.hasFortify && player.isFortified) {
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            // Î∞©Ïñ¥Îßâ: ÏßÑÌïú ÌååÎûÄÏÉâ ÌÖåÎëêÎ¶¨
            if (player.hasShield && player.shieldReady) {
                ctx.strokeStyle = '#0066ff'; // ÏßÑÌïú ÌååÎûÄÏÉâ
                ctx.lineWidth = 4;
                ctx.stroke();
            }
            // Î∞òÏÇ¨ Î≥¥Ìò∏Îßâ: ÌïòÏñÄÏÉâ ÌÖåÎëêÎ¶¨
            if (player.reflectActive) {
                ctx.strokeStyle = '#ffffff'; // ÌïòÏñÄÏÉâ
                ctx.lineWidth = 4;
                ctx.stroke();
            }
            // Î¶¨Î≥ºÎ≤Ñ Í∑∏Î¶¨Í∏∞ (ÎÑ§Ïò® Ìö®Í≥º Ï∂îÍ∞Ä)
            ctx.save();
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#333333';
            ctx.fillStyle = '#333'; // ÌååÏä§ÌÖî Í∑∏Î†àÏù¥
            ctx.fillRect(player.radius - 7.5, -4.5, 22.5, 9); // 1.5Î∞∞ Ï¶ùÍ∞Ä
            ctx.restore();
            ctx.globalAlpha = 1.0;
            ctx.restore();

            // ÌôîÎ©¥ ÌùîÎì§Î¶º Ìö®Í≥º Ï¢ÖÎ£å
            ctx.restore();
            
            // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê Í∑∏Î¶¨Í∏∞ (ÌùîÎì§Î¶º ÏòÅÌñ• Î∞õÏùå)
            ctx.save();
            ctx.translate(shakeX, shakeY);
            drawDamageNumbers(player);
                drawDamageNumbers(enemy);
            
            // Î¨¥ÎπôÏõåÌÅ¨ Î™®Îìú: ÌôîÎ©¥ Ï§ëÏïôÏóê Î∞©Ìñ• ÌôîÏÇ¥Ìëú ÏïÑÏù¥ÏΩò ÌëúÏãú (ÌùîÎì§Î¶º ÏòÅÌñ• Î∞õÏùå)
            if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'movingWork' && gameState.movingWorkDirection !== undefined) {
                const centerX = canvas.width / 2;
                let centerY = canvas.height / 2;
                
                // Ï¶ùÍ∞ïÏù¥ 5Í∞úÎ•º ÎÑòÏúºÎ©¥ ÏïÑÎûòÎ°ú ÎÇ¥Î¶º
                const totalAugments = (player.augmentations ? player.augmentations.length : 0) + (enemy.augmentations ? enemy.augmentations.length : 0);
                if (totalAugments > 5) {
                    centerY = canvas.height / 2 + 100; // ÏïÑÎûòÎ°ú 100px Ïù¥Îèô
                }
                
                // ÌôîÏÇ¥Ìëú Î∞©Ìñ•Ïóê Îî∞Î•∏ Ïú†ÎãàÏΩîÎìú ÌôîÏÇ¥Ìëú
                const angle = gameState.movingWorkDirection;
                let arrowChar;
                // 0 (Ïö∞), œÄ/2 (ÏïÑÎûò), œÄ (Ï¢å), 3œÄ/2 (ÏúÑ)
                if (Math.abs(angle - 0) < 0.1) {
                    arrowChar = '‚Üí'; // Ïö∞
                } else if (Math.abs(angle - Math.PI / 2) < 0.1) {
                    arrowChar = '‚Üì'; // ÏïÑÎûò
                } else if (Math.abs(angle - Math.PI) < 0.1) {
                    arrowChar = '‚Üê'; // Ï¢å
                } else if (Math.abs(angle - 3 * Math.PI / 2) < 0.1) {
                    arrowChar = '‚Üë'; // ÏúÑ
                } else {
                    arrowChar = '‚Üí'; // Í∏∞Î≥∏Í∞í
                }
                
                // ÎëêÍ∫ºÏö¥ ÌôîÏÇ¥Ìëú ÏïÑÏù¥ÏΩò ÌëúÏãú (ÌïòÏñÄÏÉâ Îã®ÏÉâ)
                ctx.font = 'bold 80px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // ÌïòÏñÄÏÉâ Îã®ÏÉâ, Ï°∞Í∏à Îçî Ìà¨Î™ÖÌïòÍ≤å
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.fillText(arrowChar, centerX, centerY);
            }
            
            ctx.restore();

            // UI ÏöîÏÜåÎì§ (ÌùîÎì§Î¶ºÏùò ÏòÅÌñ•ÏùÑ Î∞õÏßÄ ÏïäÏùå)
            // ÏäπÎ¶¨ ÌëúÏãú ÎßàÎ¶ÑÎ™® (ÌôîÎ©¥ ÏúÑÏ™Ω Í∞ÄÏö¥Îç∞)
            drawWinIndicators();
            
            // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÌëúÏãú (ÎßàÎ¶ÑÎ™® ÏïÑÎûò)
            if (gameState.countdown > 0 || gameState.augmentCountdown > 0) {
                drawCountdown();
            }
            
            // ÏÉÅÎåÄ ÏÑ†ÌÉù Ï§ë Î©îÏãúÏßÄ ÌëúÏãú
            if (gameState.showOpponentSelecting) {
                ctx.save();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const text = 'ÏÉÅÎåÄÍ∞Ä ÏÑ†ÌÉùÏ§ëÏûÖÎãàÎã§';
                const textWidth = ctx.measureText(text).width;
                const padding = 40;
                const y = canvas.height / 2;
                
                // Î∞∞Í≤Ω ÏÇ¨Í∞ÅÌòï
                ctx.fillRect(
                    canvas.width / 2 - textWidth / 2 - padding,
                    y - 40,
                    textWidth + padding * 2,
                    80
                );
                
                // ÌÖçÏä§Ìä∏
                ctx.fillStyle = '#ffffff';
                ctx.fillText(text, canvas.width / 2, y);
                ctx.restore();
            }
            
            // ÏãúÍ∞Ñ Ï†ïÏßÄ ÌùëÎ∞± Ìö®Í≥º: ÌîåÎ†àÏù¥Ïñ¥ÏôÄ ÌîåÎ†àÏù¥Ïñ¥Ïùò Ï¥ùÏïå Ï†úÏô∏ÌïòÍ≥† ÌùëÎ∞± Ï≤òÎ¶¨
            if (player.timeStopActive) {
                // ÌòÑÏû¨ canvas Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // ÌîåÎ†àÏù¥Ïñ¥ÏôÄ ÌîåÎ†àÏù¥Ïñ¥ Ï¥ùÏïå ÏòÅÏó≠ Ï†ÄÏû• (Ïª¨Îü¨ Ïú†ÏßÄ)
                const playerColorRegions = [];
                const playerRadius = player.radius + 5; // ÏïΩÍ∞ÑÏùò Ïó¨Ïú†
                for (let y = Math.max(0, Math.floor(player.y - playerRadius)); y < Math.min(canvas.height, Math.floor(player.y + playerRadius)); y++) {
                    for (let x = Math.max(0, Math.floor(player.x - playerRadius)); x < Math.min(canvas.width, Math.floor(player.x + playerRadius)); x++) {
                        const dx = x - player.x;
                        const dy = y - player.y;
                        if (dx * dx + dy * dy <= playerRadius * playerRadius) {
                            const idx = (y * canvas.width + x) * 4;
                            playerColorRegions.push({
                                x, y,
                                r: data[idx],
                                g: data[idx + 1],
                                b: data[idx + 2],
                                a: data[idx + 3]
                            });
                        }
                    }
                }
                
                // ÌîåÎ†àÏù¥Ïñ¥ Ï¥ùÏïå ÏòÅÏó≠ Ï†ÄÏû•
                player.bullets.forEach(bullet => {
                    const bulletRadius = bullet.radius + 5;
                    for (let y = Math.max(0, Math.floor(bullet.y - bulletRadius)); y < Math.min(canvas.height, Math.floor(bullet.y + bulletRadius)); y++) {
                        for (let x = Math.max(0, Math.floor(bullet.x - bulletRadius)); x < Math.min(canvas.width, Math.floor(bullet.x + bulletRadius)); x++) {
                            const dx = x - bullet.x;
                            const dy = y - bullet.y;
                            if (dx * dx + dy * dy <= bulletRadius * bulletRadius) {
                                const idx = (y * canvas.width + x) * 4;
                                playerColorRegions.push({
                                    x, y,
                                    r: data[idx],
                                    g: data[idx + 1],
                                    b: data[idx + 2],
                                    a: data[idx + 3]
                                });
                            }
                        }
                    }
                });
                
                // Ï†ÑÏ≤¥Î•º ÌùëÎ∞±ÏúºÎ°ú Î≥ÄÌôò
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = gray;     // R
                    data[i + 1] = gray; // G
                    data[i + 2] = gray; // B
                }
                
                // ÌîåÎ†àÏù¥Ïñ¥ÏôÄ ÌîåÎ†àÏù¥Ïñ¥ Ï¥ùÏïå ÏòÅÏó≠ ÏõêÎûò Ïª¨Îü¨Î°ú Î≥µÏõê
                playerColorRegions.forEach(region => {
                    const idx = (region.y * canvas.width + region.x) * 4;
                    data[idx] = region.r;
                    data[idx + 1] = region.g;
                    data[idx + 2] = region.b;
                    data[idx + 3] = region.a;
                });
                
                // Î≥ÄÌôòÎêú Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Í∑∏Î¶¨Í∏∞
                ctx.putImageData(imageData, 0, 0);
            }

            // ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†• ÌëúÏãú (ÏôºÏ™Ω ÏúÑ)
            const playerHealthY = 20;
            drawHealthHearts(player, 20, playerHealthY, true);
            // ÌîåÎ†àÏù¥Ïñ¥ ÌÉÑÌôòÏàò ÌëúÏãú (Ï≤¥Î†• ÏïÑÎûò - ÏõêÏúºÎ°ú)
            const playerAmmoY = playerHealthY + 40;
            drawAmmoCount(player, 20, playerAmmoY, 'left');
            // ÌîåÎ†àÏù¥Ïñ¥ Ï¶ùÍ∞ï ÏïÑÏù¥ÏΩò ÌëúÏãú (ÌÉÑÌôò ÏïÑÎûò)
            drawAugmentIcons(player, 20, playerAmmoY + 50, 'left');
            // ÌîåÎ†àÏù¥Ïñ¥ Ïû¨Ïû•Ï†Ñ Î∞î ÌëúÏãú (ÌîåÎ†àÏù¥Ïñ¥ Î∞îÎ°ú ÏôºÏ™Ω ÏúÑ) - ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπòÏóê ÌùîÎì§Î¶º Ï†ÅÏö©
            if (player.isReloading) {
                drawReloadBar(player, player.x - 40 + shakeX, player.y - 40 + shakeY); // Ï∫êÎ¶≠ÌÑ∞ ÌÅ¨Í∏∞ Ï¶ùÍ∞ÄÏóê ÎßûÏ∂∞ Ï°∞Ï†ï
            }
            
            // Ï†Å Ï≤¥Î†• ÌëúÏãú (Ïò§Î•∏Ï™Ω ÏúÑ)
            {
                const fixedBarWidth = 150; // Í≥†Ï†ïÎêú Î∞î Í∏∏Ïù¥
                const enemyHealthX = canvas.width - fixedBarWidth - 20;
                const enemyHealthY = 20;
                drawHealthHearts(enemy, enemyHealthX, enemyHealthY, false);
                // Ï†Å ÌÉÑÌôòÏàò ÌëúÏãú (Ï≤¥Î†• ÏïÑÎûò, Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ - ÏõêÏúºÎ°ú)
                const enemyAmmoY = enemyHealthY + 40;
                drawAmmoCount(enemy, enemyHealthX + fixedBarWidth, enemyAmmoY, 'right');
                // Ï†Å Ï¶ùÍ∞ï ÏïÑÏù¥ÏΩò ÌëúÏãú (ÌÉÑÌôò ÏïÑÎûò)
                drawAugmentIcons(enemy, enemyHealthX + fixedBarWidth, enemyAmmoY + 50, 'right');
            }
            // Ï¶ùÍ∞ï Ìà¥ÌåÅ ÌëúÏãú
            if (hoveredAugment) {
                drawAugmentTooltip(hoveredAugment.aug, hoveredAugment.x, hoveredAugment.y);
            }
            
        }
        
        // Ï¶ùÍ∞ï Ìà¥ÌåÅ Í∑∏Î¶¨Í∏∞
        function drawAugmentTooltip(aug, x, y) {
            ctx.save();
            
            const padding = 12;
            const lineHeight = 24;
            const fontSize = 18;
            ctx.font = `bold ${fontSize}px Arial`;
            
            // ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ï∏°Ï†ï
            const titleWidth = ctx.measureText(aug.name).width;
            ctx.font = `${fontSize - 2}px Arial`;
            const descWidth = ctx.measureText(aug.description).width;
            const tooltipWidth = Math.max(titleWidth, descWidth) + padding * 2;
            const tooltipHeight = lineHeight * 2 + padding * 2;
            
            // Ìà¥ÌåÅ ÏúÑÏπò (ÏïÑÏù¥ÏΩò ÏúÑÏ™Ω ÎòêÎäî ÏïÑÎûòÏ™Ω)
            let tooltipX = x;
            let tooltipY = y - 50 - tooltipHeight; // ÏïÑÏù¥ÏΩò ÏúÑÏ™Ω
            
            // ÌôîÎ©¥ Í≤ΩÍ≥Ñ Ï≤¥ÌÅ¨
            if (tooltipY < 0) {
                tooltipY = y + 50; // ÏïÑÏù¥ÏΩò ÏïÑÎûòÏ™Ω
            }
            if (tooltipX + tooltipWidth / 2 > canvas.width) {
                tooltipX = canvas.width - tooltipWidth / 2;
            }
            if (tooltipX - tooltipWidth / 2 < 0) {
                tooltipX = tooltipWidth / 2;
            }
            
            // Î∞∞Í≤Ω
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.strokeStyle = '#ffc107';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ffc107';
            ctx.lineWidth = 2;
            drawRoundedRect(
                tooltipX - tooltipWidth / 2,
                tooltipY,
                tooltipWidth,
                tooltipHeight,
                8
            );
            ctx.fill();
            ctx.stroke();
            
            // Ï†úÎ™© (ÎÑ§Ïò® Ìö®Í≥º)
            ctx.fillStyle = '#ffc107';
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#ffc107';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(aug.name, tooltipX, tooltipY + padding);
            
            // ÏÑ§Î™Ö
            ctx.fillStyle = '#ffffff';
            ctx.font = `${fontSize - 2}px Arial`;
            ctx.fillText(aug.description, tooltipX, tooltipY + padding + lineHeight);
            
            ctx.restore();
        }

        // UI ÏóÖÎç∞Ïù¥Ìä∏ (Ï≤¥Î†• Ïï†ÎãàÎ©îÏù¥ÏÖò Î∞è Îç∞ÎØ∏ÏßÄ Ïà´Ïûê)
        function updateUI() {
            // ÌîåÎ†àÏù¥Ïñ¥ Ï≤¥Î†• Ïï†ÎãàÎ©îÏù¥ÏÖò
            if (player.displayHealth !== player.health) {
                const diff = player.health - player.displayHealth;
                const speed = 0.15; // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑ
                player.displayHealth += diff * speed;
                // Í±∞Ïùò Í∞ôÏïÑÏßÄÎ©¥ Î∞îÎ°ú ÎßûÏ∂§
                if (Math.abs(diff) < 0.01) {
                    player.displayHealth = player.health;
                }
            }
            
            // Ï†Å Ï≤¥Î†• Ïï†ÎãàÎ©îÏù¥ÏÖò
            if (enemy.displayHealth !== enemy.health) {
                const diff = enemy.health - enemy.displayHealth;
                const speed = 0.15; // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑ
                enemy.displayHealth += diff * speed;
                // Í±∞Ïùò Í∞ôÏïÑÏßÄÎ©¥ Î∞îÎ°ú ÎßûÏ∂§
                if (Math.abs(diff) < 0.01) {
                    enemy.displayHealth = enemy.health;
                }
            }
            
            // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÏóÖÎç∞Ïù¥Ìä∏
            updateDamageNumbers(player);
            updateDamageNumbers(enemy);
            
            // ÎèÖ Ìö®Í≥º Ï≤òÎ¶¨
            updatePoisonEffects(player);
                updatePoisonEffects(enemy);
        }
        
        // ÎèÖ Ìö®Í≥º ÏóÖÎç∞Ïù¥Ìä∏
        function updatePoisonEffects(character) {
            const now = Date.now();
            for (let i = character.poisonEffects.length - 1; i >= 0; i--) {
                const poison = character.poisonEffects[i];
                const elapsed = now - poison.startTime;
                
                // 2Ï¥àÍ∞Ä ÏßÄÎÇòÍ±∞ÎÇò ÏµúÎåÄ ÌûàÌä∏ ÌöüÏàòÏóê ÎèÑÎã¨ÌïòÎ©¥ Ï†úÍ±∞
                if (elapsed >= poison.duration || (poison.hitCount >= poison.maxHits)) {
                    character.poisonEffects.splice(i, 1);
                    continue;
                }
                
                // 1Ï¥àÎßàÎã§ 0.2 Îç∞ÎØ∏ÏßÄ (ÏµúÎåÄ 2Î≤à, Ï†ïÌôî Ï¶ùÍ∞ïÏù¥ ÏûàÏúºÎ©¥ Î¨¥Ïãú)
                // Í∏∞Ï°¥ ÎèÖ Ìö®Í≥º Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ hitCountÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
                if (!poison.hasOwnProperty('hitCount')) {
                    poison.hitCount = 0;
                    poison.maxHits = 3;
                }
                if (now - poison.lastDamageTime >= 1000 && (poison.hitCount || 0) < (poison.maxHits || 3)) {
                    // Í≤åÏûÑÏù¥ ÏùºÏãúÏ†ïÏßÄÎêú ÏÉÅÌÉúÎ©¥ Îç∞ÎØ∏ÏßÄ Î¨¥Ïãú (Ï¶ùÍ∞ï ÏÑ†ÌÉù ÏãúÍ∞Ñ ÎèôÏïà)
                    if (gameState.isPaused) {
                        continue;
                    }
                    // Ïú†Î†π Ï¶ùÍ∞ï: ÌôïÎ•† Ï§ëÏ≤© (25% * count)
                    const ghostCount = poison.target.ghostCount || 1;
                    if (poison.target.hasGhost && Math.random() < (0.25 * ghostCount)) {
                        // "Î¨¥Ïãú" ÌÖçÏä§Ìä∏ ÌëúÏãú
                        poison.target.damageNumbers.push({
                            x: poison.target.x,
                            y: poison.target.y,
                            damage: 0,
                            isCritical: false,
                            isGhost: true, // Ïú†Î†π Î¨¥Ïãú Ïó¨Î∂Ä
                            startTime: now,
                            duration: 1000,
                            offsetY: 0
                        });
                        poison.lastDamageTime = now; // Îã§Ïùå Îç∞ÎØ∏ÏßÄ ÌÉÄÏù¥Î®∏ Î¶¨ÏÖã
                        continue; // Îç∞ÎØ∏ÏßÄ Ï†ÅÏö©ÌïòÏßÄ ÏïäÏùå
                    }
                    
                    let poisonDamage = poison.damagePerSecond;
                    // Í±∞Ï†êÌôïÎ≥¥: Îç∞ÎØ∏ÏßÄ *0.5
                    if (poison.target.hasFortify && poison.target.isFortified) {
                        poisonDamage *= 0.5;
                    }
                    // ÏÜåÏàòÏ†ê 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º
                    poisonDamage = roundToMaxTwoDecimals(poisonDamage);
                    
                    poison.target.health -= poisonDamage;
                    poison.target.health = roundToMaxTwoDecimals(poison.target.health);
                    poison.lastDamageTime = now;
                    poison.hitCount = (poison.hitCount || 0) + 1; // ÌûàÌä∏ ÌöüÏàò Ï¶ùÍ∞Ä
                    
                    // ÎèÖ Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÌëúÏãú (Ïñ¥ÎëêÏö¥ Ï¥àÎ°ùÏÉâ)
                    poison.target.damageNumbers.push({
                        x: poison.target.x,
                        y: poison.target.y,
                        damage: poisonDamage,
                        isCritical: false,
                        isPoison: true, // ÎèÖ Îç∞ÎØ∏ÏßÄ Ïó¨Î∂Ä
                        startTime: now,
                        duration: 1000,
                        offsetY: 0
                    });
                    
                    // Ï≤¥Î†•Ïù¥ 0 Ïù¥ÌïòÍ∞Ä ÎêòÎ©¥ Ï≤òÎ¶¨
                    if (poison.target.health <= 0) {
                        poison.target.health = 0;
                        // Î∂ÄÌôú Ï≤¥ÌÅ¨ (ÌöüÏàò Ï§ëÏ≤©)
                        const reviveCount = poison.target.reviveCount || 1;
                        const hasRevivedCount = (typeof poison.target.hasRevived === 'number' ? poison.target.hasRevived : (poison.target.hasRevived ? 1 : 0));
                        if (poison.target.hasRevive && hasRevivedCount < reviveCount && !poison.target.isReviving) {
                            poison.target.hasRevived = hasRevivedCount + 1;
                            poison.target.isReviving = true;
                            poison.target.reviveTime = now + 1000;
                        } else {
                            endRound(poison.target === player ? 'enemy' : 'player');
                        }
                    }
                }
            }
        }
        
        // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÏóÖÎç∞Ïù¥Ìä∏
        function updateDamageNumbers(character) {
            const now = Date.now();
            for (let i = character.damageNumbers.length - 1; i >= 0; i--) {
                const damageNum = character.damageNumbers[i];
                const elapsed = now - damageNum.startTime;
                
                // ÏãúÍ∞ÑÏù¥ ÏßÄÎÇòÎ©¥ Ï†úÍ±∞
                if (elapsed >= damageNum.duration) {
                    character.damageNumbers.splice(i, 1);
                    continue;
                }
                
                // ÏúÑÎ°ú Ïò¨ÎùºÍ∞ÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
                const progress = elapsed / damageNum.duration;
                damageNum.offsetY = -30 * progress; // ÏúÑÎ°ú 30px Ïù¥Îèô
            }
        }
        
        // Îç∞ÎØ∏ÏßÄ Ïà´Ïûê Í∑∏Î¶¨Í∏∞
        function drawDamageNumbers(character) {
            const now = Date.now();
            character.damageNumbers.forEach(damageNum => {
                const elapsed = now - damageNum.startTime;
                const progress = elapsed / damageNum.duration;
                
                // ÌéòÏù¥ÎìúÏïÑÏõÉ Ìö®Í≥º
                const alpha = 1 - progress;
                
                ctx.save();
                ctx.globalAlpha = alpha;
                
                // ÏÉâÏÉÅ Í≤∞Ï†ï: ÌöåÎ≥µÏù¥Î©¥ Îπ®Í∞ÑÏÉâ, Î∞©Ïñ¥Îßâ Î¨¥ÏãúÎ©¥ ÏßÑÌïú ÌååÎûÄÏÉâ, Ïú†Î†π Î¨¥ÏãúÎ©¥ ÌöåÏÉâ, Í∏∞Ï†àÏù¥Î©¥ ÎÖ∏ÎûÄÏÉâ, ÎèÖ Îç∞ÎØ∏ÏßÄÎ©¥ Ïñ¥ÎëêÏö¥ Ï¥àÎ°ùÏÉâ, ÌÅ¨Î¶¨Ìã∞Ïª¨Ïù¥Î©¥ Ïñ¥ÎëêÏö¥ ÎÖ∏ÎûÄÏÉâ, ÏïÑÎãàÎ©¥ ÌïòÏñÄÏÉâ
                let shadowColor = '#ffffff';
                if (damageNum.isHeal) {
                    ctx.fillStyle = '#ff0000'; // Îπ®Í∞ÑÏÉâ
                    shadowColor = '#ff0000';
                } else if (damageNum.isShield) {
                    ctx.fillStyle = '#0066ff'; // ÏßÑÌïú ÌååÎûÄÏÉâ
                    shadowColor = '#0066ff';
                } else if (damageNum.isGhost) {
                    ctx.fillStyle = '#888888'; // ÌöåÏÉâ
                    shadowColor = '#888888';
                } else if (damageNum.isStunned) {
                    ctx.fillStyle = '#ffffff'; // ÌïòÏñÄÏÉâ
                    shadowColor = '#ffffff';
                } else if (damageNum.isPoison) {
                    ctx.fillStyle = '#006600'; // Ïñ¥ÎëêÏö¥ Ï¥àÎ°ùÏÉâ
                    shadowColor = '#006600';
                } else if (damageNum.isCritical) {
                    ctx.fillStyle = '#CCAA00'; // Ïñ¥ÎëêÏö¥ ÎÖ∏ÎûÄÏÉâ
                    shadowColor = '#CCAA00';
                } else if (damageNum.isFlame) {
                    ctx.fillStyle = '#ff6600'; // Ï£ºÌô©/Îπ®Í∞ï Í≥ÑÏó¥
                    shadowColor = '#ff6600';
                } else {
                    ctx.fillStyle = '#ffffff'; // ÌïòÏñÄÏÉâ
                    shadowColor = '#ffffff';
                }
                ctx.shadowBlur = 10;
                ctx.shadowColor = shadowColor;
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏúÑÏπò Í∏∞Ï§ÄÏúºÎ°ú Îç∞ÎØ∏ÏßÄ Ïà´Ïûê ÎòêÎäî ÌäπÏàò ÌÖçÏä§Ìä∏ ÌëúÏãú
                let displayText;
                if (damageNum.isShield || damageNum.isGhost) {
                    displayText = 'Î¨¥Ïãú';
                } else if (damageNum.isStunned) {
                    displayText = 'Í∏∞Ï†à';
                } else {
                    // ÏÜåÏàòÏ†ê 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º, 1~2ÏûêÎ¶¨Îäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                    let value = damageNum.damage;
                    // ÏÜåÏàòÏ†ê ÏûêÎ¶¨Ïàò ÌôïÏù∏ (Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌï¥ÏÑú ÌôïÏù∏)
                    const strValue = value.toString();
                    const decimalIndex = strValue.indexOf('.');
                    if (decimalIndex !== -1) {
                        const decimalPart = strValue.substring(decimalIndex + 1);
                        if (decimalPart.length > 2) {
                            // 3ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Î©¥ 2ÏûêÎ¶¨Î°ú Î∞òÏò¨Î¶º
                            value = Math.round(value * 100) / 100;
                        }
                    }
                    // Î∂àÌïÑÏöîÌïú ÏÜåÏàòÏ†ê Ï†úÍ±∞ (Ï†ïÏàòÎ©¥ ÏÜåÏàòÏ†ê Ï†úÍ±∞)
                    if (value % 1 === 0) {
                        displayText = value.toString();
                    } else {
                        // ÏÜåÏàòÏ†ê ÏûêÎ¶¨ÏàòÏóê ÎßûÍ≤å ÌëúÏãú
                        const strValue2 = value.toString();
                        const decimalIndex2 = strValue2.indexOf('.');
                        if (decimalIndex2 !== -1) {
                            const decimalPart2 = strValue2.substring(decimalIndex2 + 1);
                            displayText = value.toFixed(Math.min(decimalPart2.length, 2));
                        } else {
                            displayText = value.toString();
                        }
                    }
                }
                ctx.fillText(
                    displayText,
                    damageNum.x,
                    damageNum.y + damageNum.offsetY
                );
                
                ctx.restore();
            });
        }

        // Í≤åÏûÑ Î£®ÌîÑ
        let lastTime = 0;
        function gameLoop(currentTime) {
            // Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò Ï≤òÎ¶¨
            if (gameState.isSlotMachine) {
                const elapsed = Date.now() - gameState.slotMachineStartTime;
                const slotSpeed = 80; // 80msÎßàÎã§ Î™®Îìú Î≥ÄÍ≤Ω (Îπ†Î•∏ ÏàúÌôò)
                const spinningDuration = 1200; // 1.2Ï¥à ÎèôÏïà Ïä¨Î°ØÎ®∏Ïã† Ïï†ÎãàÎ©îÏù¥ÏÖò
                const displayDuration = 2000; // ÏÑ†ÌÉùÎêú Î™®Îìú ÌëúÏãú ÏãúÍ∞Ñ 2Ï¥à
                
                // Î™®Îìú ÏàúÌôò
                if (elapsed < spinningDuration) {
                    const newIndex = Math.floor(elapsed / slotSpeed) % randomModes.length;
                    gameState.slotMachineCurrentIndex = newIndex;
                } else if (elapsed < spinningDuration + displayDuration) {
                    // ÏÑ†ÌÉùÎêú Î™®ÎìúÏóêÏÑú Î©àÏ∂§ (ÏÑ§Î™Ö ÏùΩÏùÑ Ïàò ÏûàÍ≤å)
                    if (!gameState.slotMachineSelectedMode) {
                        // ÎûúÎç§ Î™®Îìú ÏÑ†ÌÉù
                        const randomIndex = Math.floor(Math.random() * randomModes.length);
                        gameState.selectedRandomMode = randomModes[randomIndex];
                        gameState.slotMachineSelectedMode = gameState.selectedRandomMode;
                        gameState.slotMachineCurrentIndex = randomIndex; // ÏÑ†ÌÉùÎêú Î™®ÎìúÎ°ú Í≥†Ï†ï
                        
                        // ÎûúÎç§ Î™®Îìú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                        const randomModeDisplay = document.getElementById('randomModeDisplay');
                        const randomModeName = document.getElementById('randomModeName');
                        const randomModeTooltip = document.getElementById('randomModeTooltip');
                        
                        randomModeDisplay.style.display = 'block';
                        randomModeName.textContent = gameState.selectedRandomMode.name;
                        randomModeTooltip.textContent = gameState.selectedRandomMode.description;
                        
                        // ÎûúÎç§ Î™®Îìú Ï†ÅÏö© (ÏÜçÎèÑ Ï¥àÍ∏∞Ìôî ÌõÑ Ï†ÅÏö©)
                        player.speed = 3;
                        enemy.speed = 2.5;
                        player.reloadTime = 3000;
                        player.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
                        enemy.reloadTime = 3000;
                        enemy.baseReloadTime = 3000; // Í∏∞Î≥∏ Ïû¨Ïû•Ï†Ñ ÏãúÍ∞Ñ Ï†ÄÏû•
                        applyRandomMode(gameState.selectedRandomMode.id);
                    }
                } else {
                    // ÌëúÏãú ÏãúÍ∞Ñ Ï¢ÖÎ£å, Ïä¨Î°ØÎ®∏Ïã† Ï¢ÖÎ£å ÌõÑ 3Ï¥à Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
                    gameState.isSlotMachine = false;
                    gameState.countdown = 3; // 3Ï¥à Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
                    gameState.isPaused = true; // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï§ëÏù¥ÎØÄÎ°ú Î©àÏ∂§
                    
                    // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï≤òÎ¶¨
                    const countdownInterval = setInterval(() => {
                        gameState.countdown--;
                        if (gameState.countdown <= 0) {
                            clearInterval(countdownInterval);
                            gameState.isPaused = false; // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï¢ÖÎ£å ÌõÑ Í≤åÏûÑ ÏãúÏûë
                        }
                    }, 1000);
                }
            }
            
            // Î©îÎâ¥ ÌôîÎ©¥Ïù¥ ÏïÑÎãê ÎïåÎßå Í≤åÏûÑ Î°úÏßÅ Ïã§Ìñâ (Ïä¨Î°ØÎ®∏Ïã† Ï§ëÏù¥ ÏïÑÎãê Îïå)
            if (!gameState.isMenu && !gameState.isPaused && !gameState.isGameOver && !gameState.isSlotMachine) {
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;

                // ÌÉÄÏù¥Î®∏ Í∞êÏÜå (Ï¥àÎãπ 1Ïî©)
                if (deltaTime >= 1000) {
                    gameState.gameTime--;
                    lastTime = currentTime;

                    // ÏãúÍ∞Ñ Ï¥àÍ≥º
                    if (gameState.gameTime <= 0) {
                        if (player.health > enemy.health) {
                            endRound('player');
                        } else if (enemy.health > player.health) {
                            endRound('enemy');
                        } else {
                            // Î¨¥ÏäπÎ∂Ä - Ï≤¥Î†•Ïù¥ Îçî ÎßéÏùÄ Ï™ΩÏù¥ ÏäπÎ¶¨
                            endRound(player.health >= enemy.health ? 'player' : 'enemy');
                        }
                    }
                }

                // Ïö©ÏïîÎ™®Îìú: 5Ï¥àÎßàÎã§ 0.5 Îç∞ÎØ∏ÏßÄ
                const now = Date.now();
                if (gameState.selectedRandomMode && gameState.selectedRandomMode.id === 'flame') {
                    if (!gameState.flameLastDamage) {
                        gameState.flameLastDamage = now;
                    }
                    
                    if (now - gameState.flameLastDamage >= 5000) {
                        // ÌîåÎ†àÏù¥Ïñ¥ÏôÄ Ï†Å Î™®Îëê Îç∞ÎØ∏ÏßÄ
                        if (player.health > 0) {
                            player.health = Math.max(0, player.health - 0.5);
                            // Ïö©Ïïî Îç∞ÎØ∏ÏßÄ ÌëúÏãú (Ï£ºÌô©/Îπ®Í∞ï ÏÉâÏÉÅ)
                            player.damageNumbers.push({
                                damage: 0.5,
                                x: player.x,
                                y: player.y - player.radius - 20,
                                alpha: 1,
                                isFlame: true,
                                startTime: now,
                                duration: 1000
                            });
                        }
                        if (enemy.health > 0) {
                            enemy.health = Math.max(0, enemy.health - 0.5);
                            enemy.damageNumbers.push({
                                damage: 0.5,
                                x: enemy.x,
                                y: enemy.y - enemy.radius - 20,
                                alpha: 1,
                                isFlame: true,
                                startTime: now,
                                duration: 1000
                            });
                        }
                        gameState.flameLastDamage = now;
                    }
                }

                // Í≤åÌãÄÎßÅ Î∞úÏÇ¨ Ï≤òÎ¶¨
                if (player.hasGatling && player.gatlingBullets > 0 && now >= player.gatlingNextShot) {
                    if (player.hasScatter) {
                        // Í≤åÌãÄÎßÅ + ÎπÑÏÇ∞ÌÉÑ: Í∞Å Î∞úÏÇ¨Î•º ÎπÑÏÇ∞ÌÉÑÏúºÎ°ú Î∂ÑÏÇ∞
                        const scatterAngles = [-4, -2, 0, 2];
                        scatterAngles.forEach(angleDeg => {
                            const angle = player.angle + (angleDeg * Math.PI / 180);
                            const bullet = new Bullet(
                                player.x + Math.cos(player.angle) * player.radius,
                                player.y + Math.sin(player.angle) * player.radius,
                                angle,
                                player,
                                false
                            );
                            bullet.damage = bullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                            player.bullets.push(bullet);
                        });
                    } else {
                        const bullet = new Bullet(
                            player.x + Math.cos(player.angle) * player.radius,
                            player.y + Math.sin(player.angle) * player.radius,
                            player.angle,
                            player,
                            false
                        );
                        player.bullets.push(bullet);
                    }
                    player.gatlingBullets--;
                    player.gatlingNextShot = now + 100; // 0.1Ï¥àÎßàÎã§
                    
                    // Í≤åÌãÄÎßÅ Î∞úÏÇ¨Í∞Ä ÎÅùÎÇòÎ©¥ ÏûêÎèô Ïû¨Ïû•Ï†Ñ
                    if (player.gatlingBullets === 0 && !player.isReloading) {
                        reload(player);
                    }
                }
                if (enemy.hasGatling && enemy.gatlingBullets > 0 && now >= enemy.gatlingNextShot) {
                    if (enemy.hasScatter) {
                        // Í≤åÌãÄÎßÅ + ÎπÑÏÇ∞ÌÉÑ: Í∞Å Î∞úÏÇ¨Î•º ÎπÑÏÇ∞ÌÉÑÏúºÎ°ú Î∂ÑÏÇ∞
                        const scatterAngles = [-4, -2, 0, 2];
                        scatterAngles.forEach(angleDeg => {
                            const angle = enemy.angle + (angleDeg * Math.PI / 180);
                            const bullet = new Bullet(
                                enemy.x + Math.cos(enemy.angle) * enemy.radius,
                                enemy.y + Math.sin(enemy.angle) * enemy.radius,
                                angle,
                                enemy,
                                false
                            );
                            bullet.damage = bullet.damage * 0.25; // Îç∞ÎØ∏ÏßÄ 0.25Î∞∞
                            enemy.bullets.push(bullet);
                        });
                    } else {
                        const bullet = new Bullet(
                            enemy.x + Math.cos(enemy.angle) * enemy.radius,
                            enemy.y + Math.sin(enemy.angle) * enemy.radius,
                            enemy.angle,
                            enemy,
                            false
                        );
                        enemy.bullets.push(bullet);
                    }
                    enemy.gatlingBullets--;
                    enemy.gatlingNextShot = now + 100; // 0.1Ï¥àÎßàÎã§
                    
                    // Í≤åÌãÄÎßÅ Î∞úÏÇ¨Í∞Ä ÎÅùÎÇòÎ©¥ ÏûêÎèô Ïû¨Ïû•Ï†Ñ
                    if (enemy.gatlingBullets === 0 && !enemy.isReloading) {
                        reload(enemy);
                    }
                }

                updatePlayer();
                updateEnemy();
                updateBullets(enemy);
                updateBullets(player);
            }

            draw();
            
            // Î©îÎâ¥ ÌôîÎ©¥Ïù¥ ÏïÑÎãê ÎïåÎßå UI ÏóÖÎç∞Ïù¥Ìä∏
            if (!gameState.isMenu) {
            updateUI();
            }

            requestAnimationFrame(gameLoop);
        }

        // Í≤åÏûÑ ÏãúÏûë (Î©îÎâ¥ÏóêÏÑú ÏãúÏûë)
        gameLoop(0);
    </script>
</body>
</html>
